{"pageProps":{"frontMatter":{"title":"SQLの勉強 | 自己結合","date":"2022.02.07","description":"SQLの勉強 | 自己結合","categories":["SQL"]},"content":"<p>まずは簡単な例で行います。</p>\n<p>前回の表を使います。</p>\n<p><img src=\"/952/1.png\" alt=\"画像\"></p>\n<p>ここでanimation_idごとに同じ血液型のキャラクターがいるレコードのみを表示します。</p>\n<div class=\"remark-highlight\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">DISTINCT</span> <span class=\"token operator\">*</span> \n<span class=\"token keyword\">FROM</span> characters a <span class=\"token punctuation\">,</span> characters b\n<span class=\"token keyword\">WHERE</span> a<span class=\"token punctuation\">.</span>animation_id <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>animation_id\n<span class=\"token operator\">AND</span> a<span class=\"token punctuation\">.</span>blood <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>blood\n<span class=\"token operator\">AND</span> a<span class=\"token punctuation\">.</span>id <span class=\"token operator\">&#x3C;></span> b<span class=\"token punctuation\">.</span>id\n\n</code></pre></div>\n<p><img src=\"/952/2.png\" alt=\"画像\"></p>\n<p>自己結合で、同じアニメーションIDのもので、血液型が同じでIDが異なるものを抽出しました。</p>\n<p>WHERE a.animation_id = b.animation_id</p>\n<p>として同じテーブルを条件にすることで、同じテーブルで内部結合を行っているイメージです。</p>\n<h2>UPDATEと自己結合</h2>\n<p>以下のテーブルにランキングカラムを追加してupdateする際に、自己結合を使います。</p>\n<p><img src=\"/952/3.png\" alt=\"画像\"></p>\n<p>このようにします。</p>\n<p><img src=\"/952/4.png\" alt=\"画像\"></p>\n<p>まずはランキングの取得について</p>\n<div class=\"remark-highlight\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> a<span class=\"token punctuation\">.</span>title<span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">.</span>mypoint<span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> animations b\n\t\t<span class=\"token keyword\">WHERE</span> b<span class=\"token punctuation\">.</span>mypoint <span class=\"token operator\">></span> a<span class=\"token punctuation\">.</span>mypoint<span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> rank\n<span class=\"token keyword\">FROM</span> animations a\n<span class=\"token comment\">-----------------------------------------</span>\n<span class=\"token string\">\"title\"</span>\t<span class=\"token string\">\"rank\"</span>\n<span class=\"token string\">\"ラブライブ!スーパースター!!\"</span>\t<span class=\"token string\">\"0\"</span>\n<span class=\"token string\">\"鬼滅の刃\"</span>\t<span class=\"token string\">\"3\"</span>\n<span class=\"token string\">\"とある科学の超電磁砲\"</span>\t<span class=\"token string\">\"0\"</span>\n<span class=\"token string\">\"ワンピース\"</span>\t<span class=\"token string\">\"4\"</span>\n<span class=\"token string\">\"NewGame!\"</span>\t<span class=\"token string\">\"2\"</span>\n\n</code></pre></div>\n<p>これはmypointを比較して、比較対象のmypointより高いmypointの件数を取得しています。</p>\n<p>95より大きいmypointは存在しませんので、95のレコードは0になっています。</p>\n<p>newgame:90は、95と95がありますので2です。</p>\n<p>鬼滅の刃:80は、95と95と90がありますので3です</p>\n<p>ワンピース:70は、95と95と90と80がありますので4です。</p>\n<p>のように考えると、ランキングがわかります。</p>\n<p>これを利用してUPDATEをしてみます</p>\n<div class=\"remark-highlight\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">UPDATE</span> animations a\n<span class=\"token keyword\">SET</span> rank <span class=\"token operator\">=</span> \n\t\t<span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">.</span>mypoint<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token keyword\">FROM</span> animations b\n\t\t<span class=\"token keyword\">WHERE</span> b<span class=\"token punctuation\">.</span>mypoint <span class=\"token operator\">></span> a<span class=\"token punctuation\">.</span>mypoint<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p><img src=\"/952/5.png\" alt=\"画像\"></p>\n<p>自己結合はテーブルの結合するイメージが掴みにくいですが、使えるととてもパワフルですね。</p>","slug":"p952"},"__N_SSG":true}