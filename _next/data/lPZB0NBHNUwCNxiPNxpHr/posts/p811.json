{"pageProps":{"frontMatter":{"title":"WordPressでアクセスカウンタープラグインを自作してDB操作を学ぶ","date":"2021.12.31","description":"WordPressでアクセスカウンタープラグインを自作してDB操作を学ぶ","categories":["WordPress"]},"content":"<p>通常のテーマ作成ではデータベースに対して手を加えることは通常しませんが、プラグイン開発をすると独自のテーブルを作成することもあります。</p>\n<p>今回は、データベースにテーブルを追加してみます。通常はプラグインを有効化したときにデータベースに対してテーブル追加、無効化したときにテーブルの削除を行います。</p>\n<p>と、いってもワードプレスのマニュアルにプラグインでデータベーステーブルを作るという素晴らしい記事があるので、こちらの記事を参考にしつつ、簡単なアクセスカウンターを作っていきます。</p>\n<h2>テーブル名</h2>\n<p>テーブル名は以下のようにします</p>\n<p>pagecounter</p>\n<p>ワードプレスのテーブルにはwp_というようなプレフィックスがついていますが以下のようにしてあげるとプレフィックスを取得できるようです</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token variable\">$table_name</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$wpdb</span><span class=\"token operator\">-></span><span class=\"token property\">prefix</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\"pagecounter\"</span><span class=\"token punctuation\">;</span> \n</code></pre></div>\n<h3>どのようにしてテーブルを作成するのか</h3>\n<p>とあります。なのでデータベースを操作する際にはdbDelta関数を利用します。</p>\n<p>ここまでの情報で以下のようなプラグインを定義しました。有効化したときにテーブルの作成、無効化したときにテーブルの削除を行います。</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">register_activation_hook</span><span class=\"token punctuation\">(</span> <span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token this keyword\">$this</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'activation'</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">register_deactivation_hook</span><span class=\"token punctuation\">(</span> <span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token this keyword\">$this</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'deactivation'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">activation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// データベースオブジェクトを使用する</span>\n        <span class=\"token keyword\">global</span> <span class=\"token variable\">$wpdb</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token variable\">$charset_collate</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$wpdb</span><span class=\"token operator\">-></span><span class=\"token function\">get_charset_collate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$table_name</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$wpdb</span><span class=\"token operator\">-></span><span class=\"token property\">prefix</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\"pagecounter\"</span><span class=\"token punctuation\">;</span> \n\n        <span class=\"token variable\">$sql</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"CREATE TABLE <span class=\"token interpolation\"><span class=\"token variable\">$table_name</span></span> (\n            id mediumint(9) NOT NULL AUTO_INCREMENT,\n            date date NOT NULL,\n            uri varchar(190) NOT NULL,\n            count int(11) NOT NULL,\n            KEY url (uri),\n\t\t\tKEY date (date),\n            UNIQUE KEY id (date,uri),\n            PRIMARY KEY (`id`)\n          ) <span class=\"token interpolation\"><span class=\"token variable\">$charset_collate</span></span>;\"</span><span class=\"token punctuation\">;</span>\n          \n          <span class=\"token keyword\">require_once</span><span class=\"token punctuation\">(</span> <span class=\"token constant\">ABSPATH</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'wp-admin/includes/upgrade.php'</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token function\">dbDelta</span><span class=\"token punctuation\">(</span> <span class=\"token variable\">$sql</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">deactivation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">global</span> <span class=\"token variable\">$wpdb</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$wpdb</span><span class=\"token operator\">-></span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'DROP TABLE IF EXISTS '</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$wpdb</span><span class=\"token operator\">-></span><span class=\"token property\">prefix</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'pagecounter'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h3>ユニークキーとプライマリキーの違い</h3>\n<ul>\n<li>プライマリキーは重複した値を入れることができない</li>\n<li>ユニークキーは重複に対してルールを付けられる、どのカラムとどのカラムのセットが重複してはいけない。のように</li>\n</ul>\n<p>今回の場合は、idが重複することは許されない、また同じdateとuriのセットで重複することは許されない。</p>\n<h3>カウント機能</h3>\n<p>次に前記事の内容を踏まえてアクセスカウンターを作ります。</p>\n<p>カウント対象のレコードの存在チェックをして、インサートかアップデートか処理をわけます。</p>\n<p>selectとinsertとupdateを利用するのですが、またドキュメントに参考となる記事があります。</p>\n<p>まずはインサートだけする機能を作ります。</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">register_activation_hook</span><span class=\"token punctuation\">(</span> <span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token this keyword\">$this</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'activation'</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">register_deactivation_hook</span><span class=\"token punctuation\">(</span> <span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token this keyword\">$this</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'deactivation'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">add_action</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'wp'</span><span class=\"token punctuation\">,</span>  <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token this keyword\">$this</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'countaccess'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">countaccess</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">global</span> <span class=\"token variable\">$wpdb</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// 今日日付</span>\n        <span class=\"token variable\">$today</span> <span class=\"token operator\">=</span> <span class=\"token function\">date</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"Y-m-d\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// パラメータ</span>\n        <span class=\"token variable\">$data</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span>\n            <span class=\"token string single-quoted-string\">'date'</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$today</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'uri'</span> <span class=\"token operator\">=></span> <span class=\"token string double-quoted-string\">\"test1\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'count'</span> <span class=\"token operator\">=></span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// インサート実行</span>\n        <span class=\"token variable\">$wpdb</span><span class=\"token operator\">-></span><span class=\"token function\">insert</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$wpdb</span><span class=\"token operator\">-></span><span class=\"token property\">prefix</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'pagecounter'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$data</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n    <span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>wpのフックが発火されるようなアクセスをすると、データベースにレコードがインサートされますが、現状では２回目のアクセスでユニークキーの制約でエラーになります。</p>\n<p>しかしいとも簡単にインサートができることを確認しました。</p>\n<p>次にアップデート機能を作ります。</p>\n<p>ポイントはレコードが存在する場合はカウントをインクリメントしてアップデートするので、selectした結果で判定してupdateに回すという処理になっている点です。</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">function</span> <span class=\"token function-definition function\">countaccess</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n\n        <span class=\"token keyword\">global</span> <span class=\"token variable\">$wpdb</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// 今日日付</span>\n        <span class=\"token variable\">$today</span> <span class=\"token operator\">=</span> <span class=\"token function\">date</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"Y-m-d\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// パラメータの作成</span>\n        <span class=\"token variable\">$data</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"date\"</span> <span class=\"token operator\">=></span> <span class=\"token function\">date</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"Y-m-d\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"uri\"</span> <span class=\"token operator\">=></span> <span class=\"token string double-quoted-string\">\"none\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"count\"</span> <span class=\"token operator\">=></span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">is_singular</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token variable\">$data</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'uri'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'post'</span> <span class=\"token operator\">.</span> <span class=\"token function\">get_queried_object_id</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">is_page</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token variable\">$data</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'uri'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'page'</span> <span class=\"token operator\">.</span> <span class=\"token function\">get_queried_object_id</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$data</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'uri'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">===</span> <span class=\"token string double-quoted-string\">\"none\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// 既存レコードの取得</span>\n        <span class=\"token variable\">$exist</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$wpdb</span><span class=\"token operator\">-></span><span class=\"token function\">get_row</span><span class=\"token punctuation\">(</span>\n            <span class=\"token string double-quoted-string\">\"SELECT * FROM \"</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$wpdb</span><span class=\"token operator\">-></span><span class=\"token property\">prefix</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\"pagecounter\"</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\" WHERE date = '\"</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$data</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"date\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\"'\"</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\" AND uri = '\"</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$data</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'uri'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\"';\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$exist</span> <span class=\"token operator\">!==</span> <span class=\"token constant\">null</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token variable\">$data</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"count\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$exist</span><span class=\"token operator\">-></span><span class=\"token property\">count</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n            <span class=\"token variable\">$wpdb</span><span class=\"token operator\">-></span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span>\n                <span class=\"token variable\">$wpdb</span><span class=\"token operator\">-></span><span class=\"token property\">prefix</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'pagecounter'</span><span class=\"token punctuation\">,</span> \n                <span class=\"token variable\">$data</span><span class=\"token punctuation\">,</span> \n                <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"id\"</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$exist</span><span class=\"token operator\">-></span><span class=\"token property\">id</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token variable\">$wpdb</span><span class=\"token operator\">-></span><span class=\"token function\">insert</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$wpdb</span><span class=\"token operator\">-></span><span class=\"token property\">prefix</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'pagecounter'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$data</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n    <span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>1つの関数に複数の処理を押し込んでいますが、機能の実装はできました。</p>\n<p>また、データベース操作はセキュリティの意識も持たないといけないのですが、その辺は公式ドキュメントに目を通しておきます。</p>","slug":"p811"},"__N_SSG":true}