{"pageProps":{"frontMatter":{"title":"ソースで理解するWordPressの起動処理 ２","date":"2021.12.26","description":"ソースで理解するWordPressの起動処理 ２","categories":["WordPress"]},"content":"<p>前回はwp-blog-headerからwp-loadへいき、wp-configからwp-settingsまでの処理を確認しました。</p>\n<p>今回はwp-blog-headerに戻ってきて、wp関数を実行しているところについて見ていきます。</p>\n<p>前回までで、wp-includesにあるファイルまでローディングされ、mustプラグイン及び、有効化しているプラグインのロード、そしてテーマの読み込みと、WP_Queryオブジェクトの生成、functions.phpの読み込みなど、ワードプレスのコアからテーマまでのロードが完了しています。</p>\n<p>そして次に流れるwp関数はコメントにもあるようにWordPressのqueryのセットアップになります</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token comment\">// Set up the WordPress query.</span>\n\t<span class=\"token function\">wp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>このwp関数は以下のようになっています。</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token doc-comment comment\">/**\n * Set up the WordPress query.\n *\n * <span class=\"token keyword\">@since</span> 2.0.0\n *\n * <span class=\"token keyword\">@global</span> <span class=\"token class-name\">WP</span>       <span class=\"token parameter\">$wp</span>           Current WordPress environment instance.\n * <span class=\"token keyword\">@global</span> <span class=\"token class-name\">WP_Query</span> <span class=\"token parameter\">$wp_query</span>     WordPress Query object.\n * <span class=\"token keyword\">@global</span> <span class=\"token class-name\">WP_Query</span> <span class=\"token parameter\">$wp_the_query</span> Copy of the WordPress Query object.\n *\n * <span class=\"token keyword\">@param</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span><span class=\"token punctuation\">|</span><span class=\"token keyword\">array</span></span> <span class=\"token parameter\">$query_vars</span> Default WP_Query arguments.\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function-definition function\">wp</span><span class=\"token punctuation\">(</span> <span class=\"token variable\">$query_vars</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">''</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">global</span> <span class=\"token variable\">$wp</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$wp_query</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$wp_the_query</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token variable\">$wp</span><span class=\"token operator\">-></span><span class=\"token function\">main</span><span class=\"token punctuation\">(</span> <span class=\"token variable\">$query_vars</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token operator\">!</span> <span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span> <span class=\"token variable\">$wp_the_query</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token variable\">$wp_the_query</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$wp_query</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>WPクラスのオブジェクトのmain関数を実行しています。これはwp-includes\\class-wp.phpに定義があります。</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token doc-comment comment\">/**\n\t * Sets up all of the variables required by the WordPress environment.\n\t *\n\t * The action <span class=\"token punctuation\">{</span><span class=\"token keyword\">@see</span> 'wp'<span class=\"token punctuation\">}</span> has one parameter that references the WP object. It\n\t * allows for accessing the properties and methods to further manipulate the\n\t * object.\n\t *\n\t * <span class=\"token keyword\">@since</span> 2.0.0\n\t *\n\t * <span class=\"token keyword\">@param</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span><span class=\"token punctuation\">|</span><span class=\"token keyword\">array</span></span> <span class=\"token parameter\">$query_args</span> Passed to parse_request().\n\t */</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span> <span class=\"token variable\">$query_args</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">''</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token this keyword\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token this keyword\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">parse_request</span><span class=\"token punctuation\">(</span> <span class=\"token variable\">$query_args</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token this keyword\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">send_headers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token this keyword\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">query_posts</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token this keyword\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">handle_404</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token this keyword\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">register_globals</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token doc-comment comment\">/**\n\t\t * Fires once the WordPress environment has been set up.\n\t\t *\n\t\t * <span class=\"token keyword\">@since</span> 2.1.0\n\t\t *\n\t\t * <span class=\"token keyword\">@param</span> <span class=\"token class-name\">WP</span> <span class=\"token parameter\">$this</span> Current WordPress environment instance (passed by reference).\n\t\t */</span>\n\t\t<span class=\"token function\">do_action_ref_array</span><span class=\"token punctuation\">(</span> <span class=\"token string single-quoted-string\">'wp'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span> <span class=\"token operator\">&#x26;</span><span class=\"token this keyword\">$this</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>最初のinitはwp-settingsでも登場したものでしょう</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token comment\">// Set up current user.</span>\n<span class=\"token global\">$GLOBALS</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'wp'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">-></span><span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>次にRewriteオブジェクトを利用してリクエストの解析を行います。</p>\n<p>次にキャッシュ、コンテンツタイプなど、追加のHTTPヘッダを送信します。Content-Type ヘッダを設定します。</p>\n<p>次にメインクエリを実行します。</p>\n<p>次にリクエストURLが見つからない場合に404ヘッダーを返します。</p>\n<p>最後にワードプレスのグローバル変数をセットします。$postsなんてのもここで設定されています。</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">register_globals</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">global</span> <span class=\"token variable\">$wp_query</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token comment\">// Extract updated query vars back into global namespace.</span>\n\t\t<span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span><span class=\"token keyword type-casting\">array</span><span class=\"token punctuation\">)</span> <span class=\"token variable\">$wp_query</span><span class=\"token operator\">-></span><span class=\"token property\">query_vars</span> <span class=\"token keyword\">as</span> <span class=\"token variable\">$key</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$value</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token global\">$GLOBALS</span><span class=\"token punctuation\">[</span> <span class=\"token variable\">$key</span> <span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$value</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token global\">$GLOBALS</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'query_string'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token this keyword\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">query_string</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token global\">$GLOBALS</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'posts'</span><span class=\"token punctuation\">]</span>        <span class=\"token operator\">=</span> <span class=\"token operator\">&#x26;</span> <span class=\"token variable\">$wp_query</span><span class=\"token operator\">-></span><span class=\"token property\">posts</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token global\">$GLOBALS</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'post'</span><span class=\"token punctuation\">]</span>         <span class=\"token operator\">=</span> <span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span> <span class=\"token variable\">$wp_query</span><span class=\"token operator\">-></span><span class=\"token property\">post</span> <span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token variable\">$wp_query</span><span class=\"token operator\">-></span><span class=\"token property\">post</span> <span class=\"token punctuation\">:</span> <span class=\"token constant\">null</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token global\">$GLOBALS</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'request'</span><span class=\"token punctuation\">]</span>      <span class=\"token operator\">=</span> <span class=\"token variable\">$wp_query</span><span class=\"token operator\">-></span><span class=\"token property\">request</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token variable\">$wp_query</span><span class=\"token operator\">-></span><span class=\"token function\">is_single</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token variable\">$wp_query</span><span class=\"token operator\">-></span><span class=\"token function\">is_page</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token global\">$GLOBALS</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'more'</span><span class=\"token punctuation\">]</span>   <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token global\">$GLOBALS</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'single'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token variable\">$wp_query</span><span class=\"token operator\">-></span><span class=\"token function\">is_author</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token global\">$GLOBALS</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'authordata'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">get_userdata</span><span class=\"token punctuation\">(</span> <span class=\"token function\">get_queried_object_id</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>そして処理はwp-blog-headerに戻り、wp-includesのtemplate-loader.phpをロードします。</p>\n<p>ここでテーマのテンプレートとなるファイルをロードしています。</p>\n<p>call_user_funcではis_singleの場合はget_single_templateにてsingle テンプレートのパスを取得できればincluedeします。</p>\n<p>初期処理の最後にテーマのパーツファイルをインクルードしているということですね。</p>\n<p>テーマで作成したファイルは$postとかでメインクエリの結果を取得していますが、裏ではこのwpメソッドが動いてグローバル変数を設定していたのです。</p>\n<p>サブクエリを利用すると新しいWP_Queryが作成されるので、利用用途によっては正しくwp reset postdataを実行する必要があります。</p>\n<p>これにてWordPressの起動処理は完了です。</p>","slug":"p769"},"__N_SSG":true}