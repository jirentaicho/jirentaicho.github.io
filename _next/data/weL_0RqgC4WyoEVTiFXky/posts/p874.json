{"pageProps":{"frontMatter":{"title":"wordpressでjsと連携したプラグインを作る","date":"2022.01.16","description":"wordpressでjsと連携したプラグインを作る","categories":["WordPress"]},"content":"<p>今回はchart.jsを使って、管理画面でチャート表示をするようなプラグインを作成します。</p>\n<p>全て作成すると時間がかかってしまうので、実際のデータをせずモックを利用して行います。</p>\n<p>こんなのを作ってみます</p>\n<p><img src=\"/874/1.png\" alt=\"画像\"></p>\n<p>別のデータを表示するをクリックすると以下のようになります</p>\n<p><img src=\"/874/2.png\" alt=\"画像\"></p>\n<h2>開発環境の構築</h2>\n<p>環境構築は個人的なメモみたいになっていますがやっていきます。</p>\n<p>プラグイン開発の環境構築を行います。今回はjsファイルを利用するのでバンドルするためにwebpackをインストールします。また、ついでにbabelを使います。</p>\n<p>docker-compose.yaml</p>\n<div class=\"remark-highlight\"><pre class=\"language-html\"><code class=\"language-html\">version: '3.7'\nservices:\n  db:\n    image: mysql:8.0.19\n    command: '--default-authentication-plugin=mysql_native_password'\n    volumes:\n      - db_data:/var/lib/mysql\n    restart: always\n    environment:\n      - MYSQL_ROOT_PASSWORD=somewordpress\n      - MYSQL_DATABASE=wordpress\n      - MYSQL_USER=wordpress\n      - MYSQL_PASSWORD=wordpress\n    ports:\n      - 3306:3306\n    expose:\n      - 3306\n      - 33060\n  wordpress:\n    image: wordpress:latest\n    ports:\n      - 80:80\n    restart: always\n    environment:\n      - WORDPRESS_DB_HOST=db\n      - WORDPRESS_DB_USER=wordpress\n      - WORDPRESS_DB_PASSWORD=wordpress\n      - WORDPRESS_DB_NAME=wordpress\n    volumes:\n      - ./html:/var/www/html\n  phpmyadmin:\n    depends_on:\n      - db\n    image: phpmyadmin/phpmyadmin\n    ports:\n      - \"8081:80\"\nvolumes:\n  db_data:\n</code></pre></div>\n<p>wp-cliは使わずnodeでの環境を整えます。</p>\n<p>node_modulesは大きいのでwp-contentなどと同じフォルダにて初期化します。</p>\n<p><img src=\"/874/3.png\" alt=\"画像\"></p>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">npm init -y</code></pre></div>\n<p>webpackをインストールします</p>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">npm install --save-dev webpack\nnpm install --save-dev webpack-cli</code></pre></div>\n<p>package.jsonの依存モジュールが追加されます</p>\n<div class=\"remark-highlight\"><pre class=\"language-html\"><code class=\"language-html\">\"devDependencies\": {\n    \"webpack\": \"^5.65.0\",\n    \"webpack-cli\": \"^4.9.1\"\n  }\n</code></pre></div>\n<p>ちなみにinstallは一気に行うこともできます</p>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">npm init -y\nnpm install webpack webpack-cli --save-dev</code></pre></div>\n<p>webpack.config.jsを手動で作成します</p>\n<div class=\"remark-highlight\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"path\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nmodule<span class=\"token punctuation\">.</span><span class=\"token property-access\">exports</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">mode</span><span class=\"token operator\">:</span> <span class=\"token string\">'production'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">entry</span><span class=\"token operator\">:</span> <span class=\"token string\">'./plugins/myplugin/js/index.js'</span><span class=\"token punctuation\">,</span> \n    <span class=\"token literal-property property\">output</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">path</span><span class=\"token operator\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">resolve</span><span class=\"token punctuation\">(</span>__dirname <span class=\"token punctuation\">,</span> <span class=\"token string\">'plugins/myplugin/dist'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">filename</span><span class=\"token operator\">:</span> <span class=\"token string\">'bundle.js'</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>これはmypluginというフォルダにてプラグインを作成する想定です。そこのjsフォルダにあるindex.jsを起点に、distフォルダにbundle.jsという名前でバンドルします。</p>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">npx webpack</code></pre></div>\n<h2>babelのインストール</h2>\n<p>以下のコマンドで必要なものをインストールします。</p>\n<p>babelローダーからbabelのコアを呼出し、ついでにプラグインのプリセットをインストールします。</p>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">npm install babel-loader @babel/core @babel/preset-env --save-dev</code></pre></div>\n<p>次にwebpackにて設定を行います。</p>\n<p>対象となるファイルはjsのみで、node_modulesフォルダのものはbableの対象外にします。</p>\n<div class=\"remark-highlight\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"path\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nmodule<span class=\"token punctuation\">.</span><span class=\"token property-access\">exports</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">mode</span><span class=\"token operator\">:</span> <span class=\"token string\">'production'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">entry</span><span class=\"token operator\">:</span> <span class=\"token string\">'./plugins/myplugin/js/index.js'</span><span class=\"token punctuation\">,</span> \n    <span class=\"token literal-property property\">devtool</span><span class=\"token operator\">:</span> <span class=\"token string\">'none'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">output</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">path</span><span class=\"token operator\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">resolve</span><span class=\"token punctuation\">(</span>__dirname <span class=\"token punctuation\">,</span> <span class=\"token string\">'plugins/myplugin/dist'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">filename</span><span class=\"token operator\">:</span> <span class=\"token string\">'bundle.js'</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">module</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">rules</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token literal-property property\">test</span><span class=\"token operator\">:</span> <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\"><span class=\"token special-escape escape\">\\.</span>js<span class=\"token anchor function\">$</span></span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">,</span>\n                <span class=\"token literal-property property\">exclude</span><span class=\"token operator\">:</span> <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">node_modules</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">,</span>\n                <span class=\"token literal-property property\">loader</span><span class=\"token operator\">:</span> <span class=\"token string\">'babel-loader'</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>これで準備OKです</p>\n<h2>chart.jsのインストール</h2>\n<p>以下のコマンドでインストールします</p>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">npm install chart.js</code></pre></div>\n<p>node_modulesフォルダにchart.jsが作成されます。</p>\n<h2>プラグインの作成</h2>\n<p>ソースコードはgithubにあげてあります。</p>\n<p>ようやくプラグインを作成していきます</p>\n<p>今回作成するプラグインの作成は以下のような流れになります。</p>\n<ul>\n<li>管理画面にチャートを追加する</li>\n<li>チャート画面では、chart.jsを利用する</li>\n<li>利用するデータはモックを流し込む</li>\n</ul>\n<p>そしてchart.jsはwebpackを利用して一緒にバンドルしてしまいます。</p>\n<p>プラグインの定義は以下のようになっています</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&#x3C;?php</span>\n<span class=\"token doc-comment comment\">/**</span>\n<span class=\"token doc-comment comment\"> * Plugin Name: MyChart</span>\n<span class=\"token doc-comment comment\"> */</span>\n\n<span class=\"token comment\"># ワードプレスのセットアップができていない場合に中止</span>\n<span class=\"token function\">defined</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'ABSPATH'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token keyword\">exit</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\"># プラグインパスを定数定義しておく</span>\n<span class=\"token function\">define</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'MY_CHART_DIR'</span><span class=\"token punctuation\">,</span> <span class=\"token function\">plugin_dir_path</span><span class=\"token punctuation\">(</span><span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">final</span> <span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">MyChart</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\"># セットアップを行います</span>\n        <span class=\"token function\">add_action</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'plugins_loaded'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token this keyword\">$this</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'plugin_setup'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">plugin_setup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">is_admin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">#　ファイルの読み込みを行う</span>\n            <span class=\"token keyword\">require_once</span> <span class=\"token constant\">MY_CHART_DIR</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'Menu.php'</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">require_once</span> <span class=\"token constant\">MY_CHART_DIR</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'view/GraphView.php'</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">require_once</span> <span class=\"token constant\">MY_CHART_DIR</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'AdminAssets.php'</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">require_once</span> <span class=\"token constant\">MY_CHART_DIR</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'DataStore.php'</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        \n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">activation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">deactivation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">new</span> <span class=\"token class-name\">MyChart</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>\n</code></pre></div>\n<p>プラグインのセットアップで必要なのはファイルの読み込みくらいです。</p>\n<p>管理画面メニューに追加するためのファイル、グラフのViewを管理するファイル、jsを読み込む設定をするファイル、データを取得するファイルです。</p>\n<p>メニューの追加では、よくviewに関する記載をクラスの関数に押し込むことがありますが、基本的には別クラスにするほうが良いです。</p>\n<p>なんで良いかというと、大量のメニューを追加する必要がある場合は、設定系の配列を用意して一括してメニューに登録させたいからです。（今回はやってないですが）</p>\n<p>その場合は設定系の配列に、subメニューの登録なのか、ファイル名は何か？などの情報を格納しておき、全てviewメソッドを指定するなどの対応をすれば済むからです。</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Menu</span><span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\"># 管理ページのチャート画面にjsの利用設定を行います</span>\n        <span class=\"token function\">add_action</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'admin_menu'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token this keyword\">$this</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'wp_admin_menu'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token doc-comment comment\">/**</span>\n<span class=\"token doc-comment comment\">     * $hookで管理ページの呼び出し元管理ページのフック名</span>\n<span class=\"token doc-comment comment\">     * </span>\n<span class=\"token doc-comment comment\">     * </span>\n<span class=\"token doc-comment comment\">     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">wp_admin_menu</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token function\">add_menu_page</span><span class=\"token punctuation\">(</span>\n            <span class=\"token string single-quoted-string\">'グラフ'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'グラフ'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'manage_options'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'graph'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'my_plugin\\GraphView'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'view'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>jsファイルの読み込みを行います。</p>\n<p>チャートに表示するためのデータは適当に用意しました。必要でああればDBから取得するためのクラスなどを作成して、取得すれば良いかと思います。</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">AdminAssets</span><span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\"># 管理ページのチャート画面にjsの利用設定を行います</span>\n        <span class=\"token function\">add_action</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'admin_enqueue_scripts'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token this keyword\">$this</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'admin_scripts'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token doc-comment comment\">/**</span>\n<span class=\"token doc-comment comment\">     * $hookで管理ページの呼び出し元管理ページのフック名</span>\n<span class=\"token doc-comment comment\">     * </span>\n<span class=\"token doc-comment comment\">     * </span>\n<span class=\"token doc-comment comment\">     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">admin_scripts</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$hook</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$hook</span> <span class=\"token operator\">!=</span> <span class=\"token string single-quoted-string\">'toplevel_page_graph'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\"># $in_footerをtrueにするとjsがfooterにて読み込まれます。</span>\n        <span class=\"token function\">wp_enqueue_script</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'my_plugin_chart'</span><span class=\"token punctuation\">,</span> <span class=\"token function\">plugin_dir_url</span><span class=\"token punctuation\">(</span><span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'dist/bundle.js'</span><span class=\"token punctuation\">,</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">wp_localize_script</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'my_plugin_chart'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'chart_data'</span><span class=\"token punctuation\">,</span> <span class=\"token scope\"><span class=\"token keyword\">self</span><span class=\"token punctuation\">::</span></span><span class=\"token function\">getChartData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   \n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token doc-comment comment\">/**</span>\n<span class=\"token doc-comment comment\">     * JSに渡す初期データ</span>\n<span class=\"token doc-comment comment\">     * </span>\n<span class=\"token doc-comment comment\">     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">getChartData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span>            \n            <span class=\"token string single-quoted-string\">'label'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'当社店舗の販売数'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'labels'</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'渋谷店'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'原宿店'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'新宿店'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'町田店'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'川崎店'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'data'</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token number\">80</span><span class=\"token punctuation\">,</span><span class=\"token number\">120</span><span class=\"token punctuation\">,</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span><span class=\"token number\">70</span><span class=\"token punctuation\">,</span><span class=\"token number\">90</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'backgroundColor'</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span>\n                <span class=\"token string single-quoted-string\">'rgba(255, 99, 132, 0.2)'</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string single-quoted-string\">'rgba(54, 162, 235, 0.2)'</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string single-quoted-string\">'rgba(255, 206, 86, 0.2)'</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string single-quoted-string\">'rgba(255, 99, 132, 0.2)'</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string single-quoted-string\">'rgba(54, 162, 235, 0.2)'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'borderColor'</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span>\n                <span class=\"token string single-quoted-string\">'rgba(255, 99, 132, 1)'</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string single-quoted-string\">'rgba(54, 162, 235, 1)'</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string single-quoted-string\">'rgba(255, 206, 86, 1)'</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string single-quoted-string\">'rgba(255, 99, 132, 1)'</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string single-quoted-string\">'rgba(54, 162, 235, 1)'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>View用の設定ファイル</p>\n<p>フォームの表示箇所だけ別のファイルにしました。ここは良い方法を考える必要がある箇所です。</p>\n<p>一旦は動作してるのですが、なんとも気持ちの悪い記載になってしまったので、別のプラグインとか見て勉強します。</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\">class GraphView{\n\n    public function __construct()\n    {\n        \n    }\n\n    public static function view()\n    {\n        # 外部定義ファイルの読み込み\n        include MY_CHART_DIR . 'view/GraphFormView.php';\n\n        ?>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>h1</span><span class=\"token punctuation\">></span></span>街のまんまる屋さん<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;/</span>h1</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>div</span> <span class=\"token special-attr\"><span class=\"token attr-name\">style</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token value css language-css\"><span class=\"token property\">height</span><span class=\"token punctuation\">:</span><span class=\"token number\">500</span><span class=\"token unit\">px</span><span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">\"</span></span></span><span class=\"token punctuation\">></span></span>\n                <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>canvas</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>myChart<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;/</span>canvas</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;/</span>div</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token php language-php\"><span class=\"token delimiter important\">&#x3C;?php</span>\n    <span class=\"token punctuation\">}</span>\n    \n<span class=\"token punctuation\">}</span></span>\n</code></pre></div>\n<p>外部定義したフォーム表示用のファイル</p>\n<p>別のデータも別の取得用クラスに全て任せています。ここも必要であればDBから取得するなどのクラスを実装するという感じです。</p>\n<p>そうなった場合には処理の共通化もできると思います。ここでwp_localize_scriptを使っているのが非常に気持ち悪いのですが、ちょっとベストな方法が思いつかなかったので他のプラグインを見て勉強します。。</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&#x3C;?php</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">my_plugin</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\"># フォームの処理を行います。</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">current_user_can</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'manage_options'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">wp_die</span><span class=\"token punctuation\">(</span> <span class=\"token function\">__</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'不正なアクセスです'</span><span class=\"token punctuation\">)</span>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token global\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'change_graph'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&#x26;&#x26;</span> <span class=\"token function\">check_admin_referer</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'graph_form_csrf'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">getGraph</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function-definition function\">getGraph</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\"># データを取得する</span>\n    <span class=\"token variable\">$data</span> <span class=\"token operator\">=</span> <span class=\"token scope\">DataStore<span class=\"token punctuation\">::</span></span><span class=\"token function\">getData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">wp_localize_script</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'my_plugin_chart'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'chart_data'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$data</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n\n<span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'&#x3C;form method=\"post\">'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">wp_nonce_field</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'graph_form_csrf'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'&#x3C;input type=\"hidden\" value=\"true\" name=\"change_graph\" />'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">submit_button</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'別のデータを表示する'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'&#x3C;/form>'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token delimiter important\">?></span></span>\n</code></pre></div>\n<p>jsファイル</p>\n<p>処理を一つのファイルにまとめてしまったのですが、重要なのはchart.jsをインポートしているところです。</p>\n<p>wordpressでは色々なファイルを別ファイルとして読込させることが多いですが、webpackを使っているので一つのファイルにバンドルできます。</p>\n<div class=\"remark-highlight\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword module\">import</span> <span class=\"token imports\"><span class=\"token maybe-class-name\">Chart</span></span> <span class=\"token keyword module\">from</span> <span class=\"token string\">'chart.js/auto'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword module\">import</span> <span class=\"token imports\"><span class=\"token punctuation\">{</span> getRelativePosition <span class=\"token punctuation\">}</span></span> <span class=\"token keyword module\">from</span> <span class=\"token string\">'chart.js/helpers'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> ctx <span class=\"token operator\">=</span> <span class=\"token dom variable\">document</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'myChart'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">getContext</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2d'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nctx<span class=\"token punctuation\">.</span><span class=\"token property-access\">canvas</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">height</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"100%\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">vaildData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword control-flow\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> chart_data <span class=\"token operator\">===</span> <span class=\"token string\">'undefined'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword control-flow\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Array</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">getData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token function\">vaildData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword control-flow\">return</span> chart_data<span class=\"token punctuation\">.</span><span class=\"token property-access\">data</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">getLabels</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token function\">vaildData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword control-flow\">return</span> chart_data<span class=\"token punctuation\">.</span><span class=\"token property-access\">labels</span><span class=\"token punctuation\">;</span> \n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">getBackgroundColor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token function\">vaildData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword control-flow\">return</span> chart_data<span class=\"token punctuation\">.</span><span class=\"token property-access\">backgroundColor</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">getBorderColor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token function\">vaildData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword control-flow\">return</span> chart_data<span class=\"token punctuation\">.</span><span class=\"token property-access\">borderColor</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">getLabel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token function\">vaildData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword control-flow\">return</span> chart_data<span class=\"token punctuation\">.</span><span class=\"token property-access\">label</span><span class=\"token punctuation\">;</span> \n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> myChart <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Chart</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'bar'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">data</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">labels</span><span class=\"token operator\">:</span> <span class=\"token function\">getLabels</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">datasets</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n            <span class=\"token literal-property property\">label</span><span class=\"token operator\">:</span> <span class=\"token function\">getLabel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token literal-property property\">data</span><span class=\"token operator\">:</span> <span class=\"token function\">getData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token literal-property property\">backgroundColor</span><span class=\"token operator\">:</span> <span class=\"token function\">getBackgroundColor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token literal-property property\">borderColor</span><span class=\"token operator\">:</span> <span class=\"token function\">getBorderColor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token literal-property property\">borderWidth</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">options</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">responsive</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">animation</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token literal-property property\">duration</span><span class=\"token operator\">:</span> <span class=\"token number\">1500</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>これで管理画面にグラフを利用したページが作成できます。</p>","slug":"p874"},"__N_SSG":true}