{"pageProps":{"frontMatter":{"title":"SQLの勉強 | CASE式","date":"2022.02.06","description":"SQLの勉強 | CASE式","categories":["SQL"]},"content":"<p>Laravelでクエリビルダを使っていたら、SQLって意外と面白いなと再認識したので勉強しました。</p>\n<p>SQLについては仕事でそこそこ扱ったことがありますので、基本は抑えています。というレベルです。</p>\n<p>ちなみに私の大好きなブックオフさんで見つけた本が参考書籍です（私は古いほうを買ってしまった）</p>\n<p>https://amzn.to/3snvBir</p>\n<p>アニメテーブルは、タイトルと私の主観による評価ポイントが登録されています。</p>\n<p><img src=\"/940/1.png\" alt=\"画像\"></p>\n<p>キャラクターテーブルは、アニメテーブルに属するキャラクターの名前と血液型が登録されています。</p>\n<p><img src=\"/940/2.png\" alt=\"画像\"></p>\n<h2>ランク関数</h2>\n<p>rank関数でいい感じのランキング結果を出力する</p>\n<p>普通にランキング出力する場合</p>\n<div class=\"remark-highlight\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">--血液型の人気ランキングを作る</span>\n<span class=\"token keyword\">SELECT</span> blood<span class=\"token punctuation\">,</span><span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">FROM</span> characters\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> blood\n<span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DESC</span>\n<span class=\"token comment\">-----------------------</span>\n<span class=\"token string\">\"blood\"</span>\t<span class=\"token string\">\"count\"</span>\n<span class=\"token string\">\"O\"</span>\t<span class=\"token string\">\"6\"</span>\n<span class=\"token string\">\"A\"</span>\t<span class=\"token string\">\"6\"</span>\n<span class=\"token string\">\"B\"</span>\t<span class=\"token string\">\"5\"</span>\n<span class=\"token string\">\"AB\"</span>\t<span class=\"token string\">\"4\"</span>\n</code></pre></div>\n<p>rank関数を使った場合</p>\n<div class=\"remark-highlight\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">--血液型の人気ランキングを作る改</span>\n<span class=\"token keyword\">SELECT</span> blood<span class=\"token punctuation\">,</span> rank<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">over</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">desc</span> <span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> ランキング\n<span class=\"token keyword\">FROM</span> characters\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> blood\n<span class=\"token comment\">----------------------</span>\n<span class=\"token string\">\"blood\"</span>\t<span class=\"token string\">\"ランキング\"</span>\n<span class=\"token string\">\"O\"</span>\t<span class=\"token string\">\"1\"</span>\n<span class=\"token string\">\"A\"</span>\t<span class=\"token string\">\"1\"</span>\n<span class=\"token string\">\"B\"</span>\t<span class=\"token string\">\"3\"</span>\n<span class=\"token string\">\"AB\"</span>\t<span class=\"token string\">\"4\"</span>\n</code></pre></div>\n<h2>CASE式を利用してグルーピングする</h2>\n<p>簡単な例</p>\n<p>北と南にわける</p>\n<p><img src=\"/940/3.png\" alt=\"画像\"></p>\n<p>caseで２つに分類して人口の合計を出す</p>\n<div class=\"remark-highlight\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">CASE</span> k_name \n\t\t\t<span class=\"token keyword\">WHEN</span> <span class=\"token string\">'東京'</span> <span class=\"token keyword\">THEN</span> <span class=\"token string\">'南関東'</span>\n\t\t\t<span class=\"token keyword\">WHEN</span> <span class=\"token string\">'神奈川'</span> <span class=\"token keyword\">THEN</span> <span class=\"token string\">'南関東'</span>\n\t\t\t<span class=\"token keyword\">WHEN</span> <span class=\"token string\">'埼玉'</span> <span class=\"token keyword\">THEN</span> <span class=\"token string\">'南関東'</span>\n\t\t\t<span class=\"token keyword\">WHEN</span> <span class=\"token string\">'千葉'</span> <span class=\"token keyword\">THEN</span> <span class=\"token string\">'南関東'</span>\n\t\t\t<span class=\"token keyword\">WHEN</span> <span class=\"token string\">'茨城'</span> <span class=\"token keyword\">THEN</span> <span class=\"token string\">'北関東'</span>\n\t\t\t<span class=\"token keyword\">WHEN</span> <span class=\"token string\">'栃木'</span> <span class=\"token keyword\">THEN</span> <span class=\"token string\">'北関東'</span>\n\t\t\t<span class=\"token keyword\">WHEN</span> <span class=\"token string\">'群馬'</span> <span class=\"token keyword\">THEN</span> <span class=\"token string\">'北関東'</span>\n\t\t<span class=\"token keyword\">ELSE</span> <span class=\"token string\">'その他'</span> <span class=\"token keyword\">END</span> <span class=\"token keyword\">AS</span> 人口<span class=\"token punctuation\">,</span>\n\t\t<span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span>population<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">FROM</span> kantou\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> <span class=\"token keyword\">CASE</span> k_name \n\t\t\t<span class=\"token keyword\">WHEN</span> <span class=\"token string\">'東京'</span> <span class=\"token keyword\">THEN</span> <span class=\"token string\">'南関東'</span>\n\t\t\t<span class=\"token keyword\">WHEN</span> <span class=\"token string\">'神奈川'</span> <span class=\"token keyword\">THEN</span> <span class=\"token string\">'南関東'</span>\n\t\t\t<span class=\"token keyword\">WHEN</span> <span class=\"token string\">'埼玉'</span> <span class=\"token keyword\">THEN</span> <span class=\"token string\">'南関東'</span>\n\t\t\t<span class=\"token keyword\">WHEN</span> <span class=\"token string\">'千葉'</span> <span class=\"token keyword\">THEN</span> <span class=\"token string\">'南関東'</span>\n\t\t\t<span class=\"token keyword\">WHEN</span> <span class=\"token string\">'茨城'</span> <span class=\"token keyword\">THEN</span> <span class=\"token string\">'北関東'</span>\n\t\t\t<span class=\"token keyword\">WHEN</span> <span class=\"token string\">'栃木'</span> <span class=\"token keyword\">THEN</span> <span class=\"token string\">'北関東'</span>\n\t\t\t<span class=\"token keyword\">WHEN</span> <span class=\"token string\">'群馬'</span> <span class=\"token keyword\">THEN</span> <span class=\"token string\">'北関東'</span>\n\t\t<span class=\"token keyword\">ELSE</span> <span class=\"token string\">'その他'</span> <span class=\"token keyword\">END</span>\n<span class=\"token comment\">---------------------------</span>\n<span class=\"token string\">\"人口\"</span>\t<span class=\"token string\">\"sum\"</span>\n<span class=\"token string\">\"北関東\"</span>\t<span class=\"token string\">\"6864346\"</span>\n<span class=\"token string\">\"南関東\"</span>\t<span class=\"token string\">\"36130685\"</span>\n</code></pre></div>\n<h2>CASE式の中で式を評価する</h2>\n<p>またテーブルをアニメに戻してみます。</p>\n<p>自分の評価ポイントが高いアニメに属しているキャラクターを◎〇△で集計します。</p>\n<div class=\"remark-highlight\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> full_name<span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">CASE</span> <span class=\"token keyword\">WHEN</span> animation_id <span class=\"token operator\">IN</span> \n\t\t<span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> id <span class=\"token keyword\">FROM</span> animations \n\t\t\t<span class=\"token keyword\">WHERE</span> mypoint <span class=\"token operator\">></span> <span class=\"token number\">90</span> <span class=\"token punctuation\">)</span> <span class=\"token keyword\">THEN</span> <span class=\"token string\">'◎'</span> \n\t<span class=\"token keyword\">WHEN</span> animation_id <span class=\"token operator\">IN</span> \n\t\t<span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> id <span class=\"token keyword\">FROM</span> animations \n\t\t\t<span class=\"token keyword\">WHERE</span> mypoint <span class=\"token operator\">></span> <span class=\"token number\">79</span> <span class=\"token operator\">AND</span> mypoint <span class=\"token operator\">&#x3C;</span> <span class=\"token number\">91</span> <span class=\"token punctuation\">)</span> <span class=\"token keyword\">THEN</span> <span class=\"token string\">'〇'</span>\n\t<span class=\"token keyword\">ELSE</span> <span class=\"token string\">'△'</span> <span class=\"token keyword\">END</span> <span class=\"token keyword\">AS</span> アニメ評価\n<span class=\"token keyword\">FROM</span> characters\n<span class=\"token comment\">--------------------</span>\n<span class=\"token string\">\"full_name\"</span>\t<span class=\"token string\">\"アニメ評価\"</span>\n<span class=\"token string\">\"澁谷かのん\"</span>\t<span class=\"token string\">\"◎\"</span>\n<span class=\"token string\">\"嵐千砂都\"</span>\t<span class=\"token string\">\"◎\"</span>\n<span class=\"token string\">\"唐可可\"</span>\t<span class=\"token string\">\"◎\"</span>\n<span class=\"token string\">\"平安名すみれ\"</span>\t<span class=\"token string\">\"◎\"</span>\n<span class=\"token string\">\"葉月恋\"</span>\t<span class=\"token string\">\"◎\"</span>\n<span class=\"token string\">\"竈門炭治郎\"</span>\t<span class=\"token string\">\"〇\"</span>\n<span class=\"token string\">\"竈門ねずこ\"</span>\t<span class=\"token string\">\"〇\"</span>\n<span class=\"token string\">\"富岡義勇\"</span>\t<span class=\"token string\">\"〇\"</span>\n<span class=\"token string\">\"宇随天元\"</span>\t<span class=\"token string\">\"〇\"</span>\n<span class=\"token string\">\"煉獄杏寿郎\"</span>\t<span class=\"token string\">\"〇\"</span>\n<span class=\"token string\">\"御坂美琴\"</span>\t<span class=\"token string\">\"◎\"</span>\n<span class=\"token string\">\"白井黒子\"</span>\t<span class=\"token string\">\"◎\"</span>\n<span class=\"token string\">\"初春飾利\"</span>\t<span class=\"token string\">\"◎\"</span>\n<span class=\"token string\">\"佐天涙子\"</span>\t<span class=\"token string\">\"◎\"</span>\n<span class=\"token string\">\"ルフィ\"</span>\t<span class=\"token string\">\"△\"</span>\n<span class=\"token string\">\"ナミ\"</span>\t<span class=\"token string\">\"△\"</span>\n<span class=\"token string\">\"ウソップ\"</span>\t<span class=\"token string\">\"△\"</span>\n<span class=\"token string\">\"サンジ\"</span>\t<span class=\"token string\">\"△\"</span>\n<span class=\"token string\">\"涼風青葉\"</span>\t<span class=\"token string\">\"〇\"</span>\n<span class=\"token string\">\"八神コウ\"</span>\t<span class=\"token string\">\"〇\"</span>\n<span class=\"token string\">\"桜ねね\"</span>\t<span class=\"token string\">\"〇\"</span>\n</code></pre></div>\n<p>mypointが90以上あるアニメに属しているキャラクターは、◎などもcaseを使うことで表現できます。</p>\n<h2>CASE式で集約関数の利用</h2>\n<p>A型のキャラクターが2人以上登録されているアニメを〇にして表示します</p>\n<div class=\"remark-highlight\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> animation_id<span class=\"token punctuation\">,</span> blood<span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">CASE</span> <span class=\"token keyword\">WHEN</span> <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">2</span>\n\t\t<span class=\"token keyword\">THEN</span> <span class=\"token string\">'〇'</span>\n\t<span class=\"token keyword\">ELSE</span> <span class=\"token string\">'×'</span> <span class=\"token keyword\">END</span> <span class=\"token keyword\">AS</span> ２件以上\n<span class=\"token keyword\">FROM</span> characters\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> animation_id<span class=\"token punctuation\">,</span> blood\n<span class=\"token keyword\">HAVING</span> blood <span class=\"token operator\">=</span> <span class=\"token string\">'A'</span>\n<span class=\"token comment\">------------------------------------------</span>\n<span class=\"token string\">\"animation_id\"</span>\t<span class=\"token string\">\"blood\"</span>\t<span class=\"token string\">\"２件以上\"</span>\n<span class=\"token string\">\"1\"</span>\t<span class=\"token string\">\"A\"</span>\t<span class=\"token string\">\"〇\"</span>\n<span class=\"token string\">\"2\"</span>\t<span class=\"token string\">\"A\"</span>\t<span class=\"token string\">\"〇\"</span>\n<span class=\"token string\">\"3\"</span>\t<span class=\"token string\">\"A\"</span>\t<span class=\"token string\">\"×\"</span>\n<span class=\"token string\">\"4\"</span>\t<span class=\"token string\">\"A\"</span>\t<span class=\"token string\">\"×\"</span>\n</code></pre></div>\n<p>次回は自己結合についてやります。</p>","slug":"p940"},"__N_SSG":true}