{"pageProps":{"frontMatter":{"title":"Laravelでユニークキーとか外部キーとかを設定する","date":"2022.03.17","description":"Laravelでユニークキーとか外部キーとかを設定する","categories":["Laravel"]},"content":"<p>データベースのテーブルに制約を付けることで思わぬバグを取り除きます。例えば</p>\n<ul>\n<li>銀行口座はユーザーが１つしか作れない場合はユニークキーを設定してあげます</li>\n<li>銀行口座は存在するユーザーしか登録できない場合は外部キーを設定してあげます</li>\n</ul>\n<h2>設定</h2>\n<p>今回はUserとItemとStockを利用します。</p>\n<ul>\n<li>StockはUserの所持しているItemを管理している</li>\n<li>ユニークキー\n<ul>\n<li>Stockはuser_idとitem_idをユニークキーに設定</li>\n</ul>\n</li>\n<li>外部キー\n<ul>\n<li>Stockはuser_idとUserのidを外部キーに設定</li>\n<li>Stockはitem_idとItemのidを外部キーに設定</li>\n</ul>\n</li>\n</ul>\n<h2>ユニークキー</h2>\n<p>user_idとitem_idにユニークキーの設定をします。もちろん一つのカラムにユニークキーを設定することもできます。</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">up</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token scope\">Schema<span class=\"token punctuation\">::</span></span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'stocks'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token class-name type-declaration\">Blueprint</span> <span class=\"token variable\">$table</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token variable\">$table</span><span class=\"token operator\">-></span><span class=\"token function\">id</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token variable\">$table</span><span class=\"token operator\">-></span><span class=\"token function\">integer</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'user_id'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token variable\">$table</span><span class=\"token operator\">-></span><span class=\"token function\">integer</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'item_id'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token variable\">$table</span><span class=\"token operator\">-></span><span class=\"token function\">integer</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'count'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token variable\">$table</span><span class=\"token operator\">-></span><span class=\"token function\">timestamps</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token variable\">$table</span><span class=\"token operator\">-></span><span class=\"token function\">unique</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'user_id'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'item_id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'unique_user_item'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>第二引数にユニークキーの名前を指定しています。</p>\n<h2>外部キー</h2>\n<ul>\n<li>user_idはUserが削除されたら削除されるようにします</li>\n<li>item_idはItemとの外部キーを設定するだけにします(itemを削除するときにエラー)</li>\n</ul>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">up</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token scope\">Schema<span class=\"token punctuation\">::</span></span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'stocks'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token class-name type-declaration\">Blueprint</span> <span class=\"token variable\">$table</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token variable\">$table</span><span class=\"token operator\">-></span><span class=\"token function\">id</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token comment\">//$table->integer('user_id');</span>\n            <span class=\"token comment\">//$table->integer('item_id');</span>\n            <span class=\"token variable\">$table</span><span class=\"token operator\">-></span><span class=\"token function\">integer</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'count'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token variable\">$table</span><span class=\"token operator\">-></span><span class=\"token function\">timestamps</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token variable\">$table</span><span class=\"token operator\">-></span><span class=\"token function\">foreignId</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'user_id'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">constrained</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">onDelete</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'cascade'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token variable\">$table</span><span class=\"token operator\">-></span><span class=\"token function\">foreignId</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'item_id'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">constrained</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token variable\">$table</span><span class=\"token operator\">-></span><span class=\"token function\">unique</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'user_id'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'item_id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'unique_user_item'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>カラムは自動的に作成されます。</p>\n<h2>動作確認</h2>\n<p>user_idとitem_idが重複したときにエラー</p>\n<p><img src=\"/1586/1.png\" alt=\"画像\"></p>\n<p>存在しないUser.idを登録しようとするとエラー</p>\n<p><img src=\"/1586/2.png\" alt=\"画像\"></p>\n<p>存在しないItem.idを登録しようとするとエラー</p>\n<p><img src=\"/1586/3.png\" alt=\"画像\"></p>\n<p>ユーザーを消した時に対応するレコードも消えるユーザーレコード削除前</p>\n<p><img src=\"/1586/4.png\" alt=\"画像\"></p>\n<p>ユーザーレコード削除後user_id2のレコードが消えると自動的に消えます</p>\n<p><img src=\"/1586/5.png\" alt=\"画像\"></p>\n<p>itemは削除しようとするとエラーになる</p>\n<p><img src=\"/1586/6.png\" alt=\"画像\"></p>\n<p>stockから対象のitemを消すと消せます</p>\n<p><img src=\"/1586/7.png\" alt=\"画像\"></p>\n<h2>終わりに</h2>\n<ul>\n<li>外部キーは運用する際には注意が必要です。</li>\n<li>SQLクライアントは大好きな</li>\n</ul>","slug":"p1586"},"__N_SSG":true}