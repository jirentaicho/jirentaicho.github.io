{"pageProps":{"frontMatter":{"title":"Laravel8でトランザクション処理を行う","date":"2021.12.15","description":"Laravel8でトランザクション処理を行う","categories":["Laravel"]},"content":"<p>データベースにレコードを登録する際にはトランザクション処理を行うことになります。</p>\n<p>例えば二つのテーブルを更新することを考えた場合に、一方が登録完了してももう一方が何らかのエラーになった場合に、データの不整合が発生します。</p>\n<p>例えば以下の場合。（コードはまだ未完成です）</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$post</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Post</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$post</span><span class=\"token operator\">-></span><span class=\"token property\">title</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$request</span><span class=\"token operator\">-></span><span class=\"token property\">title</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$post</span><span class=\"token operator\">-></span><span class=\"token property\">user_id</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"0000\"</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$post</span><span class=\"token operator\">-></span><span class=\"token property\">delete_flag</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$post</span><span class=\"token operator\">-></span><span class=\"token property\">body</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$request</span><span class=\"token operator\">-></span><span class=\"token property\">inpuybody</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$post</span><span class=\"token operator\">-></span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token variable\">$category</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Category</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$category</span><span class=\"token operator\">-></span><span class=\"token property\">post_id</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"1\"</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$category</span><span class=\"token operator\">-></span><span class=\"token property\">categories</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$request</span><span class=\"token operator\">-></span><span class=\"token property\">category</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$category</span><span class=\"token operator\">-></span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>postの保存処理が成功してもカテゴリの保存が失敗する可能性があります。</p>\n<p>試しに失敗を起こしてみます。</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token doc-comment comment\">/**</span>\n<span class=\"token doc-comment comment\">     * 新規登録処理</span>\n<span class=\"token doc-comment comment\">     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">register</span><span class=\"token punctuation\">(</span><span class=\"token class-name type-declaration\">Request</span> <span class=\"token variable\">$request</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$post</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Post</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$post</span><span class=\"token operator\">-></span><span class=\"token property\">title</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$request</span><span class=\"token operator\">-></span><span class=\"token property\">title</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$post</span><span class=\"token operator\">-></span><span class=\"token property\">user_id</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"0000\"</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$post</span><span class=\"token operator\">-></span><span class=\"token property\">delete_flag</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$post</span><span class=\"token operator\">-></span><span class=\"token property\">body</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$request</span><span class=\"token operator\">-></span><span class=\"token property\">inpuybody</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$post</span><span class=\"token operator\">-></span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token variable\">$category</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Category</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">//$category->post_id = \"1\";</span>\n        <span class=\"token variable\">$category</span><span class=\"token operator\">-></span><span class=\"token property\">categories</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$request</span><span class=\"token operator\">-></span><span class=\"token property\">category</span><span class=\"token punctuation\">;</span>\n\n        \n        <span class=\"token variable\">$category</span><span class=\"token operator\">-></span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>こんなエラーが発生します。カテゴリーのインサート処理に失敗しています。</p>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">Illuminate\\Database\\QueryException\r\r\nSQLSTATE[HY000]: General error: 1364 Field &#x26;#39;post_id&#x26;#39; doesn&#x26;#39;t have a default value (SQL: insert into `categories` (`categories`, `updated_at`, `created_at`) values (テスト, 2021-12-14 17:55:15, 2021-12-14 17:55:15))</code></pre></div>\n<p>postテーブルにはレコードが保存されます</p>\n<p><img src=\"/642/1.png\" alt=\"画像\"></p>\n<p>一方でcategoryテーブルにはレコードがありません</p>\n<p><img src=\"/642/2.png\" alt=\"画像\"></p>\n<p>これでは整合性が取れません。</p>\n<h2>トランザクションを利用する</h2>\n<p>トランザクションを利用することでcommit操作ができるようになります。</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">register</span><span class=\"token punctuation\">(</span><span class=\"token class-name type-declaration\">Request</span> <span class=\"token variable\">$request</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token scope\">DB<span class=\"token punctuation\">::</span></span><span class=\"token function\">beginTransaction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">try</span><span class=\"token punctuation\">{</span>\n            <span class=\"token variable\">$post</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Post</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token variable\">$post</span><span class=\"token operator\">-></span><span class=\"token property\">title</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$request</span><span class=\"token operator\">-></span><span class=\"token property\">title</span><span class=\"token punctuation\">;</span>\n            <span class=\"token variable\">$post</span><span class=\"token operator\">-></span><span class=\"token property\">user_id</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"0000\"</span><span class=\"token punctuation\">;</span>\n            <span class=\"token variable\">$post</span><span class=\"token operator\">-></span><span class=\"token property\">delete_flag</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n            <span class=\"token variable\">$post</span><span class=\"token operator\">-></span><span class=\"token property\">body</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$request</span><span class=\"token operator\">-></span><span class=\"token property\">inpuybody</span><span class=\"token punctuation\">;</span>\n            <span class=\"token variable\">$post</span><span class=\"token operator\">-></span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token variable\">$category</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Category</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token comment\">//$category->post_id = \"1\";</span>\n            <span class=\"token variable\">$category</span><span class=\"token operator\">-></span><span class=\"token property\">categories</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$request</span><span class=\"token operator\">-></span><span class=\"token property\">category</span><span class=\"token punctuation\">;</span> \n            <span class=\"token variable\">$category</span><span class=\"token operator\">-></span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token scope\">DB<span class=\"token punctuation\">::</span></span><span class=\"token function\">commit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> <span class=\"token variable\">$e</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token scope\">DB<span class=\"token punctuation\">::</span></span><span class=\"token function\">rollBack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>こうすることで$category->save();を行った時の例外にてrollBack処理が走ります。</p>\n<p>こうすることでデータベースにはpostの登録がされません。</p>\n<p>公式ドキュメントのデータベーストランザクションの章に詳細が記載されています。</p>","slug":"p642"},"__N_SSG":true}