{"pageProps":{"frontMatter":{"title":"WordPressでプラグイン開発をする","date":"2021.12.28","description":"WordPressでプラグイン開発をする","categories":["WordPress"]},"content":"<p>プラグインの開発を行うことで、あらゆるテーマで利用できる機能を提供することができます。</p>\n<p>プラグインについては、ソースで理解するWordPressの起動処理 １にて読込個所を確認しています。</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token comment\">// Load active plugins.</span>\n<span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span> <span class=\"token function\">wp_get_active_and_valid_plugins</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token variable\">$plugin</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token function\">wp_register_plugin_realpath</span><span class=\"token punctuation\">(</span> <span class=\"token variable\">$plugin</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">include_once</span> <span class=\"token variable\">$plugin</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token doc-comment comment\">/**\n\t * Fires once a single activated plugin has loaded.\n\t *\n\t * <span class=\"token keyword\">@since</span> 5.1.0\n\t *\n\t * <span class=\"token keyword\">@param</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> <span class=\"token parameter\">$plugin</span> Full path to the plugin's main file.\n\t */</span>\n\t<span class=\"token function\">do_action</span><span class=\"token punctuation\">(</span> <span class=\"token string single-quoted-string\">'plugin_loaded'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$plugin</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">unset</span><span class=\"token punctuation\">(</span> <span class=\"token variable\">$plugin</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<h2>プラグインを作成する</h2>\n<p>プラグインの作成はwp-content\\pluginsフォルダにて行います。</p>\n<p>ハローワールドとかではあるあるな気がしますので、好きなアニメのリストを登録するようなプラグインを作成します。</p>\n<h3>プラグインを認識させる</h3>\n<p>AnimeList.phpを作ったら以下のように記載します。</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&#x3C;?php</span>\n<span class=\"token doc-comment comment\">/**</span>\n<span class=\"token doc-comment comment\"> * Plugin Name: AnimeList</span>\n<span class=\"token doc-comment comment\"> */</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">AnimeList</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">register_activation_hook</span><span class=\"token punctuation\">(</span> <span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token this keyword\">$this</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'init'</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">wp_die</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"OK\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"プラグインが有効化になりました。\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// インスタンス化してフックを登録しておきます。 </span>\n<span class=\"token keyword\">new</span> <span class=\"token class-name\">AnimeList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>\n</code></pre></div>\n<p>register_activation_hookはプラグインが有効化されたときに実行する関数を定義します。</p>\n<p>クラスの関数を指定する際には配列にして$thisと関数名をいれてあげます。</p>\n<p>プラグインを有効化するとwp_dieが実行されます。</p>\n<p><img src=\"/774/1.png\" alt=\"画像\"></p>\n<h3>管理画面にメニューを追加する</h3>\n<p>次に管理画面にメニューを追加します。管理画面に追加するにはadd_actionのadmin_menuに対してメニューページを追加する記載をした関数を指定します。</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\">class AnimeList {\n\n    function __construct()\n    {\n        register_activation_hook( __FILE__, array($this, 'init' ) );\n        //追加\n        add_action('admin_menu', array($this, 'anime_list_admin_page'));\n    }\n\n    function init()\n    {\n        // ここは削除\n        //wp_die(\"OK\",\"プラグインが有効化になりました。\");\n    }\n\n    // admin_menuに登録される関数。\n    function anime_list_admin_page(){\n        add_menu_page('アニメリストの設定', 'アニメリスト設定', 'manage_options', 'anime_list', array($this,'add_anime_list_menu_page'), 'dashicons-admin-generic', 4);\n    }\n\n    //　メニューページに表示されるViewを定義。メニューページを表示する際に実行される関数\n    function add_anime_list_menu_page()\n    {\n        ?>\n\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>warp<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>h2</span><span class=\"token punctuation\">></span></span>アニメリスト設定<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;/</span>h2</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;/</span>div</span><span class=\"token punctuation\">></span></span>\n\n        <span class=\"token php language-php\"><span class=\"token delimiter important\">&#x3C;?php</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></span>\n</code></pre></div>\n<p>add_menu_pageはメニューページを追加します。第５引数にメニューページを表示する際に実行される関数を指定します。</p>\n<p>以下のようになっていればOKです。</p>\n<p><img src=\"/774/2.png\" alt=\"画像\"></p>\n<h2>値の保存</h2>\n<p>ワードプレスで値を保存したい場合はoptionを使うことが多いです。</p>\n<p>まず順序としてはadmin_initにアクションを追加して、コールバック関数でregister_settingを実行します。ここで保存するkey情報を設定しておきます</p>\n<p>フォームではsettings fields メソッドを利用してNonceなどのhidden項目を生成します。</p>\n<p>get_option(“key”)とすることで値を取得できます。</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&#x3C;?php</span>\n<span class=\"token doc-comment comment\">/**</span>\n<span class=\"token doc-comment comment\"> * Plugin Name: AnimeList</span>\n<span class=\"token doc-comment comment\"> */</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">AnimeList</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">register_activation_hook</span><span class=\"token punctuation\">(</span> <span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token this keyword\">$this</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'init'</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">add_action</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'admin_menu'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token this keyword\">$this</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'anime_list_admin_page'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// 追加</span>\n        <span class=\"token function\">add_action</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'admin_init'</span><span class=\"token punctuation\">,</span>  <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token this keyword\">$this</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'register_animelist_setting'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// ここは削除</span>\n        <span class=\"token comment\">//wp_die(\"OK\",\"プラグインが有効化になりました。\");</span>\n        \n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// admin_menuに登録される関数。</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">anime_list_admin_page</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token function\">add_menu_page</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'アニメリストの設定'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'アニメリスト設定'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'manage_options'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'anime_list'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token this keyword\">$this</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'add_anime_list_menu_page'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'dashicons-admin-generic'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">//　メニューページに表示されるViewを定義。メニューページを表示する際に実行される関数</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">add_anime_list_menu_page</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n\n        <span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'&#x3C;div class=\"warp\">'</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'&#x3C;h2>アニメリスト設定&#x3C;/h2>'</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'&#x3C;form method=\"post\" action=\"options.php\">'</span><span class=\"token punctuation\">;</span>\n                <span class=\"token comment\">// Nonceなどのhidden項目を生成します。</span>\n                <span class=\"token function\">settings_fields</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'my-plugin-settings-group'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n               <span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'&#x3C;input type=\"text\" name=\"animelist\" id=\"animelist\" value=\"'</span> <span class=\"token operator\">.</span> <span class=\"token function\">esc_attr</span><span class=\"token punctuation\">(</span><span class=\"token function\">get_option</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"animelist\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'\">'</span><span class=\"token punctuation\">;</span>\n                <span class=\"token comment\">// 保存用のボタンを出力します。</span>\n                <span class=\"token function\">submit_button</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'&#x3C;/form>'</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'&#x3C;/div>'</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">register_animelist_setting</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">register_setting</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'my-plugin-settings-group'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'animelist'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">new</span> <span class=\"token class-name\">AnimeList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>\n</code></pre></div>\n<p>上記のコードだけで値の保存等までを実行できます</p>\n<p><img src=\"/774/3.png\" alt=\"画像\"></p>\n<p>DBにもレコードが登録されています。</p>\n<p><img src=\"/774/4.png\" alt=\"画像\"></p>\n<h2>settings_fields</h2>\n<p>settings_fieldsはhidden項目および、nonceの作成を行います</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">function</span> <span class=\"token function-definition function\">settings_fields</span><span class=\"token punctuation\">(</span> <span class=\"token variable\">$option_group</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">echo</span> <span class=\"token string double-quoted-string\">\"&#x3C;input type='hidden' name='option_page' value='\"</span> <span class=\"token operator\">.</span> <span class=\"token function\">esc_attr</span><span class=\"token punctuation\">(</span> <span class=\"token variable\">$option_group</span> <span class=\"token punctuation\">)</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\"' />\"</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">echo</span> <span class=\"token string single-quoted-string\">'&#x3C;input type=\"hidden\" name=\"action\" value=\"update\" />'</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token function\">wp_nonce_field</span><span class=\"token punctuation\">(</span> <span class=\"token string double-quoted-string\">\"<span class=\"token interpolation\"><span class=\"token variable\">$option_group</span></span>-options\"</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>nonceはlaravelでいうところの@csrfみたいなものですね。</p>\n<h2>submit_button</h2>\n<p>定義としては以下のようになっています</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">function</span> <span class=\"token function-definition function\">submit_button</span><span class=\"token punctuation\">(</span> <span class=\"token variable\">$text</span> <span class=\"token operator\">=</span> <span class=\"token constant\">null</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$type</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'primary'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$name</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'submit'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$wrap</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$other_attributes</span> <span class=\"token operator\">=</span> <span class=\"token constant\">null</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">echo</span> <span class=\"token function\">get_submit_button</span><span class=\"token punctuation\">(</span> <span class=\"token variable\">$text</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$type</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$name</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$wrap</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$other_attributes</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>ここで利用するget_submit_buttonというのがボタンの要素を作成して返却しています。</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token variable\">$name_attr</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$name</span> <span class=\"token operator\">?</span> <span class=\"token string single-quoted-string\">' name=\"'</span> <span class=\"token operator\">.</span> <span class=\"token function\">esc_attr</span><span class=\"token punctuation\">(</span> <span class=\"token variable\">$name</span> <span class=\"token punctuation\">)</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'\"'</span> <span class=\"token punctuation\">:</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$id_attr</span>   <span class=\"token operator\">=</span> <span class=\"token variable\">$id</span> <span class=\"token operator\">?</span> <span class=\"token string single-quoted-string\">' id=\"'</span> <span class=\"token operator\">.</span> <span class=\"token function\">esc_attr</span><span class=\"token punctuation\">(</span> <span class=\"token variable\">$id</span> <span class=\"token punctuation\">)</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'\"'</span> <span class=\"token punctuation\">:</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token variable\">$button</span>  <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'&#x3C;input type=\"submit\"'</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$name_attr</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$id_attr</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">' class=\"'</span> <span class=\"token operator\">.</span> <span class=\"token function\">esc_attr</span><span class=\"token punctuation\">(</span> <span class=\"token variable\">$class</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token variable\">$button</span> <span class=\"token operator\">.=</span> <span class=\"token string single-quoted-string\">'\" value=\"'</span> <span class=\"token operator\">.</span> <span class=\"token function\">esc_attr</span><span class=\"token punctuation\">(</span> <span class=\"token variable\">$text</span> <span class=\"token punctuation\">)</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'\" '</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$attributes</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">' />'</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token variable\">$wrap</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token variable\">$button</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'&#x3C;p class=\"submit\">'</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$button</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'&#x3C;/p>'</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">return</span> <span class=\"token variable\">$button</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<h2>get_option</h2>\n<p>テーブルから取得する記載があります。</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token variable\">$row</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$wpdb</span><span class=\"token operator\">-></span><span class=\"token function\">get_row</span><span class=\"token punctuation\">(</span> <span class=\"token variable\">$wpdb</span><span class=\"token operator\">-></span><span class=\"token function\">prepare</span><span class=\"token punctuation\">(</span> <span class=\"token string double-quoted-string\">\"SELECT option_value FROM <span class=\"token interpolation\"><span class=\"token variable\">$wpdb</span><span class=\"token operator\">-></span><span class=\"token property\">options</span></span> WHERE option_name = %s LIMIT 1\"</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$option</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>get_optionの引数にはoption_nameを渡していますので感覚的にも処理が掴めると思います。</p>","slug":"p774"},"__N_SSG":true}