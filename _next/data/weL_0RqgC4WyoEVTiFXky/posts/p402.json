{"pageProps":{"frontMatter":{"title":"kubernetesの初心者トレーニング | Volume偏","date":"2021.12.07","description":"kubernetesの初心者トレーニング | Volume偏","categories":["Kubernetes"]},"content":"<p>参考１</p>\n<p>https://kubernetes.io/ja/docs/tutorials/stateful-application/mysql-wordpress-persistent-volume/</p>\n<p>MySQLとWordPressのサイトを構築するとなると、データの保存方法が重要になってきます。</p>\n<p>データの永続化には以下の機能を使います</p>\n<ul>\n<li>PersistentVolume</li>\n<li>PersistentVolumeClaim</li>\n</ul>\n<p>永続ボリュームについては以下のサイトも参考にします</p>\n<p>https://kubernetes.io/ja/docs/concepts/storage/persistent-volumes/</p>\n<p>PresistentVolumeはKubernetesが用意している永続化ボリュームで、ここにデータを保存すれば消えることはありません。</p>\n<p>そしてコンテナはPresistentVolumeClaimをマウントすることでデータの永続化を行います。</p>\n<p>予めまたは動的に、 PresistentVolumeを作成しておき、 PresistentVolumeClaimに使いたい PresistentVolumeの条件を渡すと、その条件に合った PresistentVolumeが利用できます。</p>\n<p>今回はPresistentVolumeClaimを定義して動的に PresistentVolumeを作成します。</p>\n<h2>Secret generator</h2>\n<p>MYSQLのパスワードに関してはsecretを利用しています</p>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">        - name: MYSQL_ROOT_PASSWORD\r\r\n          valueFrom:\r\r\n            secretKeyRef:\r\r\n              name: mysql-pass\r\r\n              key: password</code></pre></div>\n<p>mysql-passというsecretのpasswordというkeyからvalueを設定します。</p>\n<p>上記を踏まえてkustomization.yamlという名前で以下の用に作成します。参考サイトではヒアドキュメントで作成しているのですがファイルを新規作成しても同じです。</p>\n<p>またsecretGeneratorについての参考サイト</p>\n<p>passwordの値はお好みで設定します。</p>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">secretGenerator:\r\r\n- name: mysql-pass\r\r\n  literals:\r\r\n  - password=MIKOTO</code></pre></div>\n<p>参考１のサイトにてアップロードされているyamlファイルダウンロードしてフォルダに入れておきます。</p>\n<p>kustomization.yamlを以下のように修正します</p>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">secretGenerator:\r\r\n- name: mysql-pass\r\r\n  literals:\r\r\n  - password=MIKOTO\r\r\nresources:\r\r\n  - mysql-deployment.yaml\r\r\n  - wordpress-deployment.yaml</code></pre></div>\n<p>今度こそデプロイします</p>\n<p>今回はoフォルダに全てのyamlを突っ込んでいます</p>\n<p>ポイントとしてはyamlファイルを個別にデプロイするのではなく-kオプションをつけてkustomization.yamlをデプロイします</p>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">┌──(misaka㉿misaka)-[~/デスクトップ/vol]\r\r\n└─$ sudo kubectl apply -k o                                                                                                                    1 ⨯\r\r\nsecret/mysql-pass-877mh7gg9c created\r\r\nservice/wordpress created\r\r\nservice/wordpress-mysql created\r\r\npersistentvolumeclaim/mysql-pv-claim created\r\r\npersistentvolumeclaim/wp-pv-claim created\r\r\ndeployment.apps/wordpress created\r\r\ndeployment.apps/wordpress-mysql created\r                                        </code></pre></div>\n<p>pvcとpvを取得すればボリュームについて確認できます</p>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">└─$ sudo kubectl get pvc,pv                                                 \r\r\nNAME                                           STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE\r\r\npersistentvolumeclaim/mysql-pv-claim           Bound    pvc-aecdaefa-3763-4bbb-b25f-6f6ea09804e3   20Gi       RWO            standard       21m\r\r\npersistentvolumeclaim/wp-pv-claim              Bound    pvc-14e5ba27-a3bc-4d77-b247-bc4dc10f859a   20Gi       RWO            standard       21m\r\r\n\r\r\nNAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                            STORAGECLASS   REASON   AGE\r\r\npersistentvolume/pvc-14e5ba27-a3bc-4d77-b247-bc4dc10f859a   20Gi       RWO            Delete           Bound    default/wp-pv-claim              standard                21m\r\r\npersistentvolume/pvc-aecdaefa-3763-4bbb-b25f-6f6ea09804e3   20Gi       RWO            Delete           Bound    default/mysql-pv-claim           standard                21m\r\r\n</code></pre></div>\n<p>それぞれ紐づいていることがわかります。</p>\n<p>podも見ます</p>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">┌──(misaka㉿misaka)-[~/デスクトップ/vol]\r\r\n└─$ sudo kubectl get pods   \r\r\nNAME                               READY   STATUS    RESTARTS   AGE\r\r\nwordpress-ccccc84f-w42n6           1/1     Running   0          46s\r\r\nwordpress-mysql-748d8b96cc-n9jhx   1/1     Running   0          46s\r</code></pre></div>\n<p>scecretsを確認します</p>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">└─$ sudo kubectl get secrets\r\r\nNAME                    TYPE                                  DATA   AGE\r\r\ndefault-token-c74ts     kubernetes.io/service-account-token   3      4d2h\r\r\nmysql-pass-877mh7gg9c   Opaque                                1      76s\r\r\n                                                                               </code></pre></div>\n<p>サービスを確認します</p>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">┌──(misaka㉿misaka)-[~/デスクトップ/vol]\r\r\n└─$ sudo kubectl get service wordpress    \r\r\nNAME        TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)        AGE\r\r\nwordpress   LoadBalancer   10.99.159.251   192.168.49.51   80:31041/TCP   4m45s\r</code></pre></div>\n<p>URLを取得してアクセスします</p>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">└─$ sudo minikube service wordpress --url                                                                                                     37 ⨯\r\r\nhttp://10.0.2.15:31041\r</code></pre></div>\n<p><img src=\"/402/1.png\" alt=\"画像\"></p>\n<p>インストールしてみます</p>\n<p><img src=\"/402/2.png\" alt=\"画像\"></p>\n<p>ワードプレスをインストールしたということは、wp-adminやらのフォルダが作成されました。</p>\n<h2>保存されているパス</h2>\n<p>今回のボリュームについてはデフォルトのhostPathが利用されていますので、以下のパスにワードプレスでインストールしたデータが保存されています。(/tmp)</p>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">wd\r\r\n/tmp/hostpath-provisioner/default/wp-pv-claim\r\r\n                                                                                                                                                   \r\r\n┌──(misaka㉿misaka)-[/tmp/hostpath-provisioner/default/wp-pv-claim]\r\r\n└─$ ls\r\r\nindex.php    wp-activate.php     wp-comments-post.php  wp-content   wp-links-opml.php  wp-mail.php      wp-trackback.php\r\r\nlicense.txt  wp-admin            wp-config-sample.php  wp-cron.php  wp-load.php        wp-settings.php  xmlrpc.php\r\r\nreadme.html  wp-blog-header.php  wp-config.php         wp-includes  wp-login.php       wp-signup.php\r\r\n                                                                                                                </code></pre></div>","slug":"p402"},"__N_SSG":true}