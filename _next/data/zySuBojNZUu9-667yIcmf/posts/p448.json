{"pageProps":{"frontMatter":{"title":"タクソノミーを利用する","date":"2021.12.07","description":"タクソノミーを利用する","categories":["WordPress"]},"content":"<p>前回までで、タクソノミーについて構造とカスタムタクソノミーまで学びました。</p>\n<p>今回は、タクソノミーの利用方法について学びます。とはいっても、テーマ作成している場合は既に利用しているのです。なぜならばカテゴリー一覧とかタグの表示とかってできますよね。</p>\n<p>なので今回はカスタムタクソノミーを同じように利用してみます。</p>\n<p>タームの一覧を取得したいと思ったときには、記事IDに紐づくタームタクソノミーIDを取得すれば全て取得できそうですが、</p>\n<p><img src=\"/448/1.png\" alt=\"画像\"></p>\n<p><img src=\"/448/2.png\" alt=\"画像\"></p>\n<p>タームを取得するメソッドは以下で定義されているget_termsメソッドです。オプションもありますがとりあえずタクソノミー名を渡せば取得できそうです。</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">function</span> <span class=\"token function-definition function\">get_terms</span><span class=\"token punctuation\">(</span> <span class=\"token variable\">$args</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$deprecated</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">''</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token variable\">$term_query</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WP_Term_Query</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token variable\">$defaults</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span>\n\t\t<span class=\"token string single-quoted-string\">'suppress_filter'</span> <span class=\"token operator\">=></span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n省略\n\t<span class=\"token variable\">$terms</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$term_query</span><span class=\"token operator\">-></span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span> <span class=\"token variable\">$args</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token operator\">!</span> <span class=\"token function\">is_array</span><span class=\"token punctuation\">(</span> <span class=\"token variable\">$terms</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token variable\">$terms</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token variable\">$suppress_filter</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token variable\">$terms</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>更に読み込んでいくと以下でデータベースから取得していると思います</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">get_terms</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">global</span> <span class=\"token variable\">$wpdb</span><span class=\"token punctuation\">;</span>\n省略\n\n\t\t<span class=\"token this keyword\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">sql_clauses</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'select'</span><span class=\"token punctuation\">]</span>  <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"SELECT <span class=\"token interpolation\"><span class=\"token variable\">$distinct</span></span> <span class=\"token interpolation\"><span class=\"token variable\">$fields</span></span>\"</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token this keyword\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">sql_clauses</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'from'</span><span class=\"token punctuation\">]</span>    <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"FROM <span class=\"token interpolation\"><span class=\"token variable\">$wpdb</span><span class=\"token operator\">-></span><span class=\"token property\">terms</span></span> AS t <span class=\"token interpolation\"><span class=\"token variable\">$join</span></span>\"</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token this keyword\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">sql_clauses</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'orderby'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$orderby</span> <span class=\"token operator\">?</span> <span class=\"token string double-quoted-string\">\"<span class=\"token interpolation\"><span class=\"token variable\">$orderby</span></span> <span class=\"token interpolation\"><span class=\"token variable\">$order</span></span>\"</span> <span class=\"token punctuation\">:</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token this keyword\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">sql_clauses</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'limits'</span><span class=\"token punctuation\">]</span>  <span class=\"token operator\">=</span> <span class=\"token variable\">$limits</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token this keyword\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">request</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token this keyword\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">sql_clauses</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'select'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span></span> <span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token this keyword\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">sql_clauses</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'from'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span></span> <span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token variable\">$where</span><span class=\"token punctuation\">}</span></span> <span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token this keyword\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">sql_clauses</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'orderby'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span></span> <span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token this keyword\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">sql_clauses</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'limits'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span></span>\"</span><span class=\"token punctuation\">;</span>\n省略\n\t\t<span class=\"token variable\">$terms</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$wpdb</span><span class=\"token operator\">-></span><span class=\"token function\">get_results</span><span class=\"token punctuation\">(</span> <span class=\"token this keyword\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">request</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n省略\n\t\t<span class=\"token this keyword\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">terms</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$terms</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token this keyword\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">terms</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>早速つかってタームを取得してみます。</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token variable\">$terms</span> <span class=\"token operator\">=</span> <span class=\"token function\">get_terms</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"my_test\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">var_dump</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$terms</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">array(1) { [0]=&#x26;gt; object(WP_Term)#4513 (10) { [&#x26;quot;term_id&#x26;quot;]=&#x26;gt; int(5) [&#x26;quot;name&#x26;quot;]=&#x26;gt; string(27) &#x26;quot;新しいタクソノミー&#x26;quot; [&#x26;quot;slug&#x26;quot;]=&#x26;gt; string(81) &#x26;quot;%e6%96%b0%e3%81%97%e3%81%84%e3%82%bf%e3%82%af%e3%82%bd%e3%83%8e%e3%83%9f%e3%83%bc&#x26;quot; [&#x26;quot;term_group&#x26;quot;]=&#x26;gt; int(0) [&#x26;quot;term_taxonomy_id&#x26;quot;]=&#x26;gt; int(5) [&#x26;quot;taxonomy&#x26;quot;]=&#x26;gt; string(7) &#x26;quot;my_test&#x26;quot; [&#x26;quot;description&#x26;quot;]=&#x26;gt; string(0) &#x26;quot;&#x26;quot; [&#x26;quot;parent&#x26;quot;]=&#x26;gt; int(0) [&#x26;quot;count&#x26;quot;]=&#x26;gt; int(1) [&#x26;quot;filter&#x26;quot;]=&#x26;gt; string(3) &#x26;quot;raw&#x26;quot; } }</code></pre></div>\n<h2>リンクを取得する</h2>\n<p>タームに紐づく記事一覧などを表示したい場合はリンクが必要になります。</p>\n<p>これもget_term_linkメソッドというのがありました。ソースを見ていると、取得したtermを渡せば良さそうですが、公式リファレンスではスラッグでもOKと書いてあります。第二引数はオプションです。</p>\n<p>とりあえず取得したtermを渡してリンクを表示してみます。</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token variable\">$terms</span> <span class=\"token operator\">=</span> <span class=\"token function\">get_terms</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"my_test\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">foreach</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$terms</span> <span class=\"token keyword\">as</span> <span class=\"token variable\">$term</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">echo</span> <span class=\"token function\">get_term_link</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$term</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>これで画面にttp://localhost/?my_test=%e6%96%b0%e3%81%97%e3%81%84%e3%82%bf%e3%82%af%e3%82%bd%e3%83%8e%e3%83%9f%e3%83%bcという文字列が表示されていました。</p>\n<p>正しくリンクが取得できています。</p>\n<p><img src=\"/448/3.png\" alt=\"画像\"></p>\n<h2>記事に紐づくターム情報</h2>\n<p>ターム情報を取得したのはいいですが、記事画面では記事に紐づくタームを取得したいケースがあるでしょう</p>\n<p>これはどうやるのか？調べてみたらwp_get_object_termsメソッドを利用するみたいです。</p>\n<p>これも結局はget_termsを呼出しているようですがobject_idsが設定されて、class-wp-term-query.phpの中でobject_idsがsqlの条件として追加されているように見えました。</p>\n<p>とにかく、記事に紐づくタームを取得するときには、wp_get_object_termsメソッドを利用します。</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token variable\">$term</span> <span class=\"token operator\">=</span> <span class=\"token function\">wp_get_object_terms</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$post</span><span class=\"token operator\">-></span><span class=\"token constant\">ID</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"my_test\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token function\">var_dump</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$term</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>新しい記事にタクソノミーにタームを追加して投稿して、記事詳細画面を表示してみます</p>\n<p><img src=\"/448/4.png\" alt=\"画像\"></p>\n<p>新しいタクソノミーというのは表示されず、記事に紐づくタームのみ（ここではラブライバー）が表示されています。リンクも同じように取得できるでしょう。</p>","slug":"p448"},"__N_SSG":true}