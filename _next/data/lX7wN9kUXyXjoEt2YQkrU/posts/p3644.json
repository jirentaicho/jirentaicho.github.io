{"pageProps":{"frontMatter":{"title":"SQL | グループ化とCASE文","date":"2022.09.08","description":"SQL | グループ化とCASE文","categories":["SQL"]},"content":"<p>SQLでグループ化した途端どうなってんのかわかんなくなる病気にかかっています。普段からSQLを書いてないと以前やったことができない。というわけでSQLの復習です。実行環境はpostgreです。</p>\n<h2>グループ化とCASE文</h2>\n<p>以下のようなテーブルがあります</p>\n<p><img src=\"/3644/1.png\" alt=\"画像\"></p>\n<p>nameでグループ化すると重複したnameは一つにまとまりますので4レコードが取得されます。</p>\n<p><img src=\"/3644/2.png\" alt=\"画像\"></p>\n<p>じゃあここで、CASE式を使ってクレープを買った人は〇を付けようとします</p>\n<div class=\"remark-highlight\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> NAME<span class=\"token punctuation\">,</span>\n<span class=\"token keyword\">CASE</span> <span class=\"token keyword\">WHEN</span> <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">CASE</span> <span class=\"token keyword\">WHEN</span> item <span class=\"token operator\">=</span> <span class=\"token string\">'クレープ'</span> <span class=\"token keyword\">THEN</span> <span class=\"token number\">1</span> <span class=\"token keyword\">ELSE</span> <span class=\"token number\">0</span> <span class=\"token keyword\">END</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n\t<span class=\"token keyword\">THEN</span> <span class=\"token string\">'〇'</span> <span class=\"token keyword\">ELSE</span> <span class=\"token string\">'×'</span> <span class=\"token keyword\">END</span> <span class=\"token keyword\">AS</span> クレープ\n<span class=\"token keyword\">FROM</span> sales\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> NAME\n</code></pre></div>\n<p><img src=\"/3644/3.png\" alt=\"画像\"></p>\n<p>この時に、なぜグループ化して4行になった?のにクレープの有無を確認できるんだ？？という頭がバグってしまった笑</p>\n<p>以下を考えるとわかりやすい</p>\n<div class=\"remark-highlight\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> NAME<span class=\"token punctuation\">,</span>\n<span class=\"token function\">count</span><span class=\"token punctuation\">(</span>NAME<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">FROM</span> sales\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> NAME\n</code></pre></div>\n<p><img src=\"/3644/4.png\" alt=\"画像\"></p>\n<p>4行になった?としたらcountがそれぞれ1件になるはずだ。切り捨てられたわけじゃない。</p>\n<p>となると・・・</p>\n<div class=\"remark-highlight\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> NAME<span class=\"token punctuation\">,</span>\n<span class=\"token keyword\">CASE</span> <span class=\"token keyword\">WHEN</span> <span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">CASE</span> <span class=\"token keyword\">WHEN</span> item <span class=\"token operator\">=</span> <span class=\"token string\">'クレープ'</span> <span class=\"token keyword\">THEN</span> <span class=\"token number\">1</span> <span class=\"token keyword\">ELSE</span> <span class=\"token number\">0</span> <span class=\"token keyword\">END</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n\t<span class=\"token keyword\">THEN</span> <span class=\"token string\">'〇'</span> <span class=\"token keyword\">ELSE</span> <span class=\"token string\">'×'</span> <span class=\"token keyword\">END</span> <span class=\"token keyword\">AS</span> クレープ\n<span class=\"token keyword\">FROM</span> sales\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> NAME\n</code></pre></div>\n<p>misakaの行はカウントが2なので、misakaのゲコ太とクレープがチェックされて、クレープがあるのでsumは1となり、〇が出力される。こんな感じだろうか・・・？</p>\n<p>では次に以下のようなテーブルを利用して、学年ごとにクレープを持っている人が何人いるかを出力します。</p>\n<p><img src=\"/3644/5.png\" alt=\"画像\"></p>\n<p>ちなみに学年は以下の通りです</p>\n<ul>\n<li>1年生\n<ul>\n<li>saten</li>\n<li>sirai</li>\n<li>uiharu</li>\n</ul>\n</li>\n<li>2年生\n<ul>\n<li>misaka</li>\n<li>kongo</li>\n</ul>\n</li>\n</ul>\n<p>まずは学年を出力させるだけのcaseとgroupです</p>\n<div class=\"remark-highlight\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> \n\t<span class=\"token keyword\">CASE</span> NAME \n\t\t<span class=\"token keyword\">WHEN</span> <span class=\"token string\">'misaka'</span> <span class=\"token keyword\">THEN</span> <span class=\"token string\">'2年生'</span>\n\t\t<span class=\"token keyword\">WHEN</span> <span class=\"token string\">'kongo'</span> <span class=\"token keyword\">THEN</span> <span class=\"token string\">'2年生'</span>\n\t\t<span class=\"token keyword\">ELSE</span> <span class=\"token string\">'1年生'</span> <span class=\"token keyword\">END</span> <span class=\"token keyword\">AS</span> 学年\n<span class=\"token keyword\">FROM</span> sales\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> name\n</code></pre></div>\n<p><img src=\"/3644/6.png\" alt=\"画像\"></p>\n<p>次にクレープを買った人数をカウントさせます。また学年をグループ化の条件に流用します</p>\n<div class=\"remark-highlight\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> \n\t<span class=\"token keyword\">CASE</span> NAME \n\t\t<span class=\"token keyword\">WHEN</span> <span class=\"token string\">'misaka'</span> <span class=\"token keyword\">THEN</span> <span class=\"token string\">'2年生'</span>\n\t\t<span class=\"token keyword\">WHEN</span> <span class=\"token string\">'kongo'</span> <span class=\"token keyword\">THEN</span> <span class=\"token string\">'2年生'</span>\n\t\t<span class=\"token keyword\">ELSE</span> <span class=\"token string\">'1年生'</span> <span class=\"token keyword\">END</span> <span class=\"token keyword\">AS</span> 学年\n\t<span class=\"token punctuation\">,</span>\n\t<span class=\"token function\">SUM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">CASE</span> <span class=\"token keyword\">WHEN</span> item <span class=\"token operator\">=</span> <span class=\"token string\">'クレープ'</span> <span class=\"token keyword\">THEN</span> <span class=\"token number\">1</span> <span class=\"token keyword\">ELSE</span> <span class=\"token number\">0</span> <span class=\"token keyword\">END</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> クレープ\n<span class=\"token keyword\">FROM</span> sales\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> 学年\n</code></pre></div>\n<p><img src=\"/3644/7.png\" alt=\"画像\"></p>\n<p>うまくできました。なんとなくコツを掴んできた感じがします？</p>\n<p>関連記事</p>\n<p><a href=\"/posts/p940\">リンク</a></p>","slug":"p3644"},"__N_SSG":true}