{"pageProps":{"frontMatter":{"title":"LaravelでTinyMCEを使ってデータを読み書きする","date":"2021.12.14","description":"LaravelでTinyMCEを使ってデータを読み書きする","categories":["Laravel"]},"content":"<p>TinyMCEの導入については前記事をご参照ください</p>\n<p>ファイルアップロードもファイルピッカーを使えばドキュメント記載の内容で実装できそうですが今回は行いません。</p>\n<p>今回は投稿内容を保存する処理などを書きます。</p>\n<h2>コードの記載</h2>\n<p>コードはドキュメントの内容をそのまま記載すればOKです。ドキュメントの内容リンクのjs箇所をそのまま記載します。※selectorだけ自分のフォームに合わせています</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token operator\">&#x3C;</span>script src<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"{{ asset('js/tinymce/tinymce.min.js') }}\"</span> referrerpolicy<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"origin\"</span><span class=\"token operator\">></span><span class=\"token operator\">&#x3C;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span>\n<span class=\"token operator\">&#x3C;</span>script<span class=\"token operator\">></span>\n  tinymce<span class=\"token operator\">.</span><span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    selector<span class=\"token punctuation\">:</span> <span class=\"token string single-quoted-string\">'textarea#myeditorinstance'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token argument-name\">plugins</span><span class=\"token punctuation\">:</span> <span class=\"token string single-quoted-string\">'image code'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token argument-name\">toolbar</span><span class=\"token punctuation\">:</span> <span class=\"token string single-quoted-string\">'undo redo | link image | code'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">/* enable title field in the Image dialog*/</span>\n    image_title<span class=\"token punctuation\">:</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">/* enable automatic uploads of images represented by blob or data URIs*/</span>\n    automatic_uploads<span class=\"token punctuation\">:</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">,</span>\n省略\n</code></pre></div>\n<p>ビューに関しては以下のようにしました。</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token operator\">&#x3C;</span>div<span class=\"token operator\">></span>\n    <span class=\"token operator\">&#x3C;</span>form method<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"post\"</span> action<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"/register\"</span> id<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"inputform\"</span> name<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"inputfomr\"</span><span class=\"token operator\">></span>\n        @csrf\n        <span class=\"token operator\">&#x3C;</span>textarea id<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"myeditorinstance\"</span> name<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"inpuybody\"</span><span class=\"token operator\">></span>Hello<span class=\"token punctuation\">,</span> World<span class=\"token operator\">!</span><span class=\"token operator\">&#x3C;</span><span class=\"token operator\">/</span>textarea<span class=\"token operator\">></span>\n        <span class=\"token operator\">&#x3C;</span>button type<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"submit\"</span> name<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"action\"</span> value<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"send\"</span><span class=\"token operator\">></span>登録<span class=\"token operator\">&#x3C;</span><span class=\"token operator\">/</span>button<span class=\"token operator\">></span>\n    <span class=\"token operator\">&#x3C;</span><span class=\"token operator\">/</span>form<span class=\"token operator\">></span>\n<span class=\"token operator\">&#x3C;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n</code></pre></div>\n<h2>ルーティングとコントローラー</h2>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token scope\">Route<span class=\"token punctuation\">::</span></span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'/register'</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span><span class=\"token scope\">App<span class=\"token punctuation\">\\</span>Http<span class=\"token punctuation\">\\</span>Controllers<span class=\"token punctuation\">\\</span>TinyController<span class=\"token punctuation\">::</span></span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'register'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>中身を確認程度</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">register</span><span class=\"token punctuation\">(</span><span class=\"token class-name type-declaration\">Request</span> <span class=\"token variable\">$request</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">dd</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$request</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h2>画像はどうなる</h2>\n<p>Springでも取り扱いましたが、base64にエンコードしています。画像はバイナリデータになっているのでbase64でエンコードして文字列として扱います。もちろんファイルサイズの大きな画像になると膨大なテキストになります。</p>\n<p><img src=\"/622/1.png\" alt=\"画像\"></p>\n<h2>データベースに登録する</h2>\n<p>適当なテーブルにレコードとして保存してみます。</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">register</span><span class=\"token punctuation\">(</span><span class=\"token class-name type-declaration\">Request</span> <span class=\"token variable\">$request</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$post</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Post</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$post</span><span class=\"token operator\">-></span><span class=\"token property\">title</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"サンプルタイトル\"</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$post</span><span class=\"token operator\">-></span><span class=\"token property\">body</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$request</span><span class=\"token operator\">-></span><span class=\"token property\">inpuybody</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token variable\">$post</span><span class=\"token operator\">-></span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>データベースにはhtmlの構造で保存されています。</p>\n<p><img src=\"/622/2.png\" alt=\"画像\"></p>\n<h2>表示する</h2>\n<p>少し注意が必要です。xss攻撃です。例えばjsコードなんかが登録された場合に、以下の表示を行うとjsコードが評価されて実行されてしまいます。</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token operator\">&#x3C;</span>body <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"antialiased\"</span><span class=\"token operator\">></span>\n        <span class=\"token operator\">&#x3C;</span>div<span class=\"token operator\">></span>\n            <span class=\"token punctuation\">{</span><span class=\"token operator\">!</span><span class=\"token operator\">!</span> <span class=\"token variable\">$post</span><span class=\"token operator\">-></span><span class=\"token property\">body</span> <span class=\"token operator\">!</span><span class=\"token operator\">!</span><span class=\"token punctuation\">}</span>\n        <span class=\"token operator\">&#x3C;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n    <span class=\"token operator\">&#x3C;</span><span class=\"token operator\">/</span>body<span class=\"token operator\">></span>\n</code></pre></div>\n<p>参考サイトにあるようにサニタイズをしてあげましょう。</p>\n<p><img src=\"/622/3.png\" alt=\"画像\"></p>\n<h2>編集する</h2>\n<p>編集するときにもサニタイズした値を渡してあげればOKです</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token operator\">&#x3C;</span>div<span class=\"token operator\">></span>\n    <span class=\"token operator\">&#x3C;</span>form method<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"post\"</span> action<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"/register\"</span> id<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"inputform\"</span> name<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"inputfomr\"</span><span class=\"token operator\">></span>\n        @csrf\n        <span class=\"token operator\">&#x3C;</span>textarea id<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"myeditorinstance\"</span> name<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"inpuybody\"</span><span class=\"token operator\">></span>\n            <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> <span class=\"token variable\">$body</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token operator\">&#x3C;</span><span class=\"token operator\">/</span>textarea<span class=\"token operator\">></span>\n        <span class=\"token operator\">&#x3C;</span>button type<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"submit\"</span> name<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"action\"</span> value<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\"send\"</span><span class=\"token operator\">></span>登録<span class=\"token operator\">&#x3C;</span><span class=\"token operator\">/</span>button<span class=\"token operator\">></span>\n    <span class=\"token operator\">&#x3C;</span><span class=\"token operator\">/</span>form<span class=\"token operator\">></span>\n<span class=\"token operator\">&#x3C;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n</code></pre></div>\n<h2>画像アップロードについて</h2>\n<p>一応、TinyMCEを使って画像をアップロードする際に419エラーが出た際にはこの記事が良さそう。古いけどこの記事も見ました。というか記載はどちらも似ているのですがね。</p>\n<p>他にもファイルアップロードにパッケージを利用する方法などがあるが、そもそもLaravel8では使えないなどの問題があったりする。</p>\n<p>ちなみにファイルアップロード用のファイル選択ボタンは、以下のコールバック関数を定義することで表示されます。</p>\n<p><img src=\"/622/4.png\" alt=\"画像\"></p>\n<p>もちろんこれだけで役に立ちません</p>\n<p>images_upload_urlにパスの指定をすると画像アップロード処理が走りますので、ここで処理を記載します。</p>","slug":"p622"},"__N_SSG":true}