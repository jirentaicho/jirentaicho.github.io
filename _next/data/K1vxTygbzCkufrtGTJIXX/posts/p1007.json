{"pageProps":{"frontMatter":{"title":"Laravel | ミドルウェア","date":"2022.02.10","description":"Laravel | ミドルウェア","categories":["Laravel"]},"content":"<h2>前提</h2>\n<p>https://readouble.com/laravel/8.x/ja/middleware.html</p>\n<p>・ルートミドルウェアは特定のルートに設定する</p>\n<p>・グローバルミドルウェアは全てのルートで実施する</p>\n<p>・ミドルウェアグループは、複数のミドルウェアをグループ化する</p>\n<p>このミドルウェアなんだろう？ってなったら、app\\Http\\Kernel.phpを見る。</p>\n<p>認証ユーザーのみのルート設定</p>\n<p>参考：https://poppotennis.com/posts/laravel-routing-auth</p>\n<h2>実践</h2>\n<p>作成コマンド</p>\n<p>app\\Http\\Middlewareに作成されます。作成されたクラスのhandleメソッドに実際の処理を記載します。</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">handle</span><span class=\"token punctuation\">(</span><span class=\"token class-name type-declaration\">Request</span> <span class=\"token variable\">$request</span><span class=\"token punctuation\">,</span> <span class=\"token class-name type-declaration\">Closure</span> <span class=\"token variable\">$next</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$request</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'name'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"御坂美琴\"</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token variable\">$next</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$request</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>カーネルにミドルウェアの設定を行います。</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token doc-comment comment\">/**\n     * The application's route middleware.\n     *\n     * These middleware may be assigned to groups or used individually.\n     *\n     * <span class=\"token keyword\">@var</span> <span class=\"token class-name\"><span class=\"token keyword\">array</span></span>&#x3C;string, class-string|string>\n     */</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$routeMiddleware</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string single-quoted-string\">'auth'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>App<span class=\"token punctuation\">\\</span>Http<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>Authenticate</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string single-quoted-string\">'auth.basic'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>Illuminate<span class=\"token punctuation\">\\</span>Auth<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>AuthenticateWithBasicAuth</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string single-quoted-string\">'cache.headers'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>Illuminate<span class=\"token punctuation\">\\</span>Http<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>SetCacheHeaders</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string single-quoted-string\">'can'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>Illuminate<span class=\"token punctuation\">\\</span>Auth<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>Authorize</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string single-quoted-string\">'guest'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>App<span class=\"token punctuation\">\\</span>Http<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>RedirectIfAuthenticated</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string single-quoted-string\">'password.confirm'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>Illuminate<span class=\"token punctuation\">\\</span>Auth<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>RequirePassword</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string single-quoted-string\">'signed'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>Illuminate<span class=\"token punctuation\">\\</span>Routing<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>ValidateSignature</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string single-quoted-string\">'throttle'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>Illuminate<span class=\"token punctuation\">\\</span>Routing<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>ThrottleRequests</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string single-quoted-string\">'verified'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>Illuminate<span class=\"token punctuation\">\\</span>Auth<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>EnsureEmailIsVerified</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n        <span class=\"token comment\">//追加</span>\n        <span class=\"token string single-quoted-string\">'sample'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>App<span class=\"token punctuation\">\\</span>Http<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>Sample</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>ルートにて設定して確認します。</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token scope\">Route<span class=\"token punctuation\">::</span></span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'/sample'</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token class-name type-declaration\">Request</span> <span class=\"token variable\">$request</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token variable\">$request</span><span class=\"token operator\">-></span><span class=\"token property\">name</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'さん'</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">middleware</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'sample'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p><img src=\"/1007/1.png\" alt=\"画像\"></p>\n<h3>グローバルミドルウェアにして確認する</h3>\n<p>カーネルの修正</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">protected</span> <span class=\"token variable\">$middleware</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token comment\">// \\App\\Http\\Middleware\\TrustHosts::class,</span>\n        <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>App<span class=\"token punctuation\">\\</span>Http<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>TrustProxies</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n        <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>Fruitcake<span class=\"token punctuation\">\\</span>Cors<span class=\"token punctuation\">\\</span>HandleCors</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n        <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>App<span class=\"token punctuation\">\\</span>Http<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>PreventRequestsDuringMaintenance</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n        <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>Illuminate<span class=\"token punctuation\">\\</span>Foundation<span class=\"token punctuation\">\\</span>Http<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>ValidatePostSize</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n        <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>App<span class=\"token punctuation\">\\</span>Http<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>TrimStrings</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n        <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>Illuminate<span class=\"token punctuation\">\\</span>Foundation<span class=\"token punctuation\">\\</span>Http<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>ConvertEmptyStringsToNull</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n        <span class=\"token comment\">// 追加</span>\n        <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>App<span class=\"token punctuation\">\\</span>Http<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>Sample</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>ルートからミドルウェアの設定を消す</p>\n<div class=\"remark-highlight\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token scope\">Route<span class=\"token punctuation\">::</span></span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'/sample'</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token class-name type-declaration\">Request</span> <span class=\"token variable\">$request</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token variable\">$request</span><span class=\"token operator\">-></span><span class=\"token property\">name</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'さん'</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p><img src=\"/1007/2.png\" alt=\"画像\"></p>\n<p>Laravelにはデフォルトでミドルウェアが複数あります。特に認証回りはこういうもんだと思って使っていることもあるので、一度目を通すと面白いかもしれません。</p>\n<p>関係ない話</p>\n<p>このブログのデザインをいい加減変えたい。</p>","slug":"p1007"},"__N_SSG":true}