{"pageProps":{"frontMatter":{"title":"DockerでOracle環境を作ってOracleの勉強する","date":"2022.10.05","description":"DockerでOracle環境を作ってOracleの勉強する","categories":["Oracle"]},"content":"<h2>Dockerで環境構築</h2>\n<p>PostgreやMySQLは環境構築が簡単ですが、Oracleはハードルが高いイメージしかありません。でも仕事ではOracle以外のデータベースを使ったことがない。ただ仕事で使ったといってもユーザーの作成とか、データベースのインポートとかその辺くらいなので、ほとんどわかってない。</p>\n<p>というわけでOracle環境をDockerで作って勉強してみます！そのメモです。</p>\n<p>まず、Dockerでの作成は以下の記事の通りに進めればOKです。docker-compose up -dまで</p>\n<p>https://zenn.dev/re24_1986/articles/29430f2f8b4b46</p>\n<p>ただしWindowsでWSL2を使っている場合はメモリでエラーになることがあります。私はメモリを8Gにして成功しました。</p>\n<p>メモリの設定は.wslconfigというファイルで行います。これは下記フォルダにありますが、なければ新規作成します</p>\n<p>C:\\Users{ユーザー名}.wslconfig</p>\n<p>以下のように記載</p>\n<div class=\"remark-highlight\"><pre class=\"language-html\"><code class=\"language-html\">[wsl2]\nmemory=8GB\nswap=0\n</code></pre></div>\n<p>これでコンテナの起動が完了しました。→結構時間かかりました。</p>\n<p><img src=\"/3854/1.png\" alt=\"画像\"></p>\n<h2>PDB</h2>\n<p>正直あんまり知らなかった。複数のデータベースを作るのよりも、リソースの削減、一括管理ができるなどのメリットがあるようです</p>\n<p>https://www.intellilink.co.jp/column/oracleletter/2013/081500.aspx</p>\n<p>PDBの作成</p>\n<p>https://docs.oracle.com/cd/E96517_01/multi/creating-a-pdb-from-scratch.html#GUID-261BCDEC-7B06-4378-867A-1333D97AFCAC</p>\n<p>https://sigrid-stem-focus.com/oracle19c-pdb-create-seed/</p>\n<p>色々作成方法はあるけども、seedからの作成が簡単みたいです。(seedってなんだ？)seedにあるファイルを配置するようです。</p>\n<p>環境構築に参考にした記事では、セットアップ用のファイルをコンテナ作成、開始時に流すようにしていますが、確認も含めてコンテナに入ってPDBを作成してみます</p>\n<p>以下のコマンドでコンテナに入ります。</p>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">D:\\docker\\oracle\\work&#x26;gt;docker exec -it oracle21c /bin/sh\nsh-4.2$</code></pre></div>\n<p>次にSqlplusを利用します。sys/{自分で設定したパスワード}です。</p>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">sh-4.2$ sqlplus sys/oracle@//localhost:1521/XE as sysdba\n\nSQL*Plus: Release 21.0.0.0.0 - Production on Tue Oct 4 09:44:10 2022\nVersion 21.3.0.0.0\n\nCopyright (c) 1982, 2021, Oracle.  All rights reserved.\n\n\nConnected to:\nOracle Database 21c Express Edition Release 21.0.0.0.0 - Production\nVersion 21.3.0.0.0\n\nSQL&#x26;gt;</code></pre></div>\n<p>PDBの情報を確認する</p>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">SQL&#x26;gt; show pdbs\n\n    CON_ID CON_NAME                       OPEN MODE  RESTRICTED\n---------- ------------------------------ ---------- ----------\n         2 PDB$SEED                       READ ONLY  NO\n         3 XEPDB1                         READ WRITE NO</code></pre></div>\n<p>現在の接続先を確認</p>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">SQL&#x26;gt; show con_name\n\nCON_NAME\n------------------------------\nCDB$ROOT</code></pre></div>\n<p>この状態だとCDBに接続されています。このCDB$ROOTの上(中)にPDB＄SEEDがあり、また新たにPDBを作成していくイメージですね。</p>\n<p>セッションを切り替えてシードのファイルを確認する</p>\n<div class=\"remark-highlight\"><pre class=\"language-html\"><code class=\"language-html\">SQL> alter session set container=PDB$SEED;\n\nSession altered.\n\nSQL> show con_name\n\nCON_NAME\n------------------------------\nPDB$SEED\nSQL>\nSQL> select file_name from dba_data_files;\n\nFILE_NAME\n--------------------------------------------------------------------------------\n/opt/oracle/oradata/XE/pdbseed/system01.dbf\n/opt/oracle/oradata/XE/pdbseed/sysaux01.dbf\n/opt/oracle/oradata/XE/pdbseed/undotbs01.dbf\n\nSQL>\n</code></pre></div>\n<p>このファイルを設置する新規PDB用のフォルダを作成する</p>\n<div class=\"remark-highlight\"><pre class=\"language-html\"><code class=\"language-html\">SQL> !mkdir /opt/oracle/oradata/XE/pdb01\n</code></pre></div>\n<p>新規PDBを作成します。ここは参考記事と同じ設定で作成</p>\n<div class=\"remark-highlight\"><pre class=\"language-html\"><code class=\"language-html\">SQL> CREATE PLUGGABLE DATABASE pdb01 ADMIN USER pdb01admin IDENTIFIED BY password\nfile_name_convert = ('/opt/oracle/oradata/XE/pdbseed/','/opt/oracle/oradata/XE/pdb01/');\n  2  CREATE PLUGGABLE DATABASE pdb01 ADMIN USER pdb01admin IDENTIFIED BY password\n*\nERROR at line 1:\nORA-16000: database or pluggable database open for read-only access\n\n\nSQL> alter session set container=CDB$ROOT\n  2  ;\n\nSession altered.\n\nSQL> CREATE PLUGGABLE DATABASE pdb01 ADMIN USER pdb01admin IDENTIFIED BY password\nfile_name_convert = ('/opt/oracle/oradata/XE/pdbseed/','/opt/oracle/oradata/XE/pdb01/');\n  2\n\nPluggable database created.\n\nSQL> SQL>\n</code></pre></div>\n<p>PDB$SEEDからは作成できず、CDB$ROOTにセッションを変更してから実行しました。</p>\n<p>作成できたことを確認</p>\n<div class=\"remark-highlight\"><pre class=\"language-html\"><code class=\"language-html\">SQL> SQL> show pdbs\n\n    CON_ID CON_NAME                       OPEN MODE  RESTRICTED\n---------- ------------------------------ ---------- ----------\n         2 PDB$SEED                       READ ONLY  NO\n         3 XEPDB1                         READ WRITE NO\n         4 PDB01                          MOUNTED\nSQL>\n</code></pre></div>\n<h2>表領域とユーザの作成</h2>\n<p>次に表領域とユーザを作成します。先に表領域を作成して、ユーザ作成時に格納先の表領域を指定します。指定しない場合はデフォルト表領域が使用される。ここも参考記事と同じように作成しました。</p>\n<p>https://www.shift-the-oracle.com/config/create-user.html</p>\n<div class=\"remark-highlight\"><pre class=\"language-html\"><code class=\"language-html\">SQL> CREATE TABLESPACE users DATAFILE '/opt/oracle/oradata/XE/pdb01/users01.dbf' SIZE 300M AUTOEXTEND ON NEXT 500K MAXSIZE UNLIMITED;\n</code></pre></div>\n<p>表領域の名前を指定して情報を取得する</p>\n<div class=\"remark-highlight\"><pre class=\"language-html\"><code class=\"language-html\">SQL> SELECT * FROM DBA_TABLESPACE_USAGE_METRICS WHERE TABLESPACE_NAME = 'USERS';\n\nTABLESPACE_NAME                USED_SPACE TABLESPACE_SIZE USED_PERCENT\n------------------------------ ---------- --------------- ------------\nUSERS                                 344         4194302   .008201603\n\nSQL>\n</code></pre></div>\n<p>作りたてなので全く利用されていません。</p>\n<p>次にPDB01にユーザを作成しますが、データベースが開いてないと怒られたので</p>\n<div class=\"remark-highlight\"><pre class=\"language-html\"><code class=\"language-html\">SQL> alter session set container=pdb01;\n\nSession altered.\n\nSQL> CREATE USER misaka IDENTIFIED BY password DEFAULT TABLESPACE users QUOTA UNLIMITED ON users TEMPORARY TABLESPACE temp;\nCREATE USER misaka IDENTIFIED BY password DEFAULT TABLESPACE users QUOTA UNLIMITED ON users TEMPORARY TABLESPACE temp\n*\nERROR at line 1:\nORA-01109: database not open\n</code></pre></div>\n<p>データベースをオープンしますが、今度は表領域がないと怒られます。</p>\n<div class=\"remark-highlight\"><pre class=\"language-html\"><code class=\"language-html\">SQL> alter pluggable database pdb01 open;\n\nPluggable database altered.\n\nSQL> CREATE USER misaka IDENTIFIED BY password DEFAULT TABLESPACE users QUOTA UNLIMITED ON users TEMPORARY TABLESPACE temp;\nCREATE USER misaka IDENTIFIED BY password DEFAULT TABLESPACE users QUOTA UNLIMITED ON users TEMPORARY TABLESPACE temp\n*\nERROR at line 1:\nORA-00959: tablespace 'USERS' does not exist\n\n\nSQL> SELECT * FROM DBA_TABLESPACE_USAGE_METRICS WHERE TABLESPACE_NAME = 'USERS';\n\nno rows selected\n</code></pre></div>\n<p>表領域をPDBに作らないといけないのでしょうか？</p>\n<p>参考記事もセッションを変更していました！というわけで一旦既存のものを削除してから作り直します。</p>\n<div class=\"remark-highlight\"><pre class=\"language-html\"><code class=\"language-html\">SQL> DROP TABLESPACE USERS;\nDROP TABLESPACE USERS\n*\nERROR at line 1:\nORA-12919: Can not drop the default permanent tablespace\n\n</code></pre></div>\n<p>デフォルト表領域は削除できませんと言われた。のでもう一個表領域を作ってデフォルトとして割り当ててから削除すると良いらしい</p>\n<div class=\"remark-highlight\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SQL</span><span class=\"token operator\">></span> <span class=\"token comment\">--デフォルトに設定</span>\n<span class=\"token keyword\">alter</span> <span class=\"token keyword\">database</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">tablespace</span> DEFAULT_TEMP<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">Database</span> altered<span class=\"token punctuation\">.</span>\n\n<span class=\"token keyword\">SQL</span><span class=\"token operator\">></span> <span class=\"token comment\">--削除</span>\n<span class=\"token keyword\">DROP</span> <span class=\"token keyword\">TABLESPACE</span> USERS<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">DROP</span> <span class=\"token keyword\">TABLESPACE</span> USERS\n<span class=\"token operator\">*</span>\nERROR at line <span class=\"token number\">1</span>:\nORA<span class=\"token operator\">-</span><span class=\"token number\">01549</span>: <span class=\"token keyword\">tablespace</span> <span class=\"token operator\">not</span> empty<span class=\"token punctuation\">,</span> <span class=\"token keyword\">use</span> INCLUDING CONTENTS <span class=\"token keyword\">option</span>\n\n<span class=\"token comment\">--今度こそ削除</span>\n<span class=\"token keyword\">SQL</span><span class=\"token operator\">></span> <span class=\"token keyword\">DROP</span> <span class=\"token keyword\">TABLESPACE</span> USERS INCLUDING CONTENTS <span class=\"token operator\">AND</span> DATAFILES<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">Tablespace</span> dropped<span class=\"token punctuation\">.</span>\n\n<span class=\"token keyword\">SQL</span><span class=\"token operator\">></span>\n</code></pre></div>\n<p>次はPDB01に表領域を作成してユーザを作成します</p>\n<div class=\"remark-highlight\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SQL</span><span class=\"token operator\">></span> <span class=\"token keyword\">alter</span> <span class=\"token keyword\">session</span> <span class=\"token keyword\">set</span> container<span class=\"token operator\">=</span>PDB01<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">Session</span> altered<span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">SQL</span><span class=\"token operator\">></span> <span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLESPACE</span> users DATAFILE <span class=\"token string\">'/opt/oracle/oradata/XE/pdb01/users01.dbf'</span> SIZE <span class=\"token number\">300</span>M AUTOEXTEND <span class=\"token keyword\">ON</span> <span class=\"token keyword\">NEXT</span> <span class=\"token number\">500</span>K MAXSIZE UNLIMITED<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">Tablespace</span> created<span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">SQL</span><span class=\"token operator\">></span> <span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">USER</span> misaka IDENTIFIED <span class=\"token keyword\">BY</span> password <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">TABLESPACE</span> users QUOTA UNLIMITED <span class=\"token keyword\">ON</span> users <span class=\"token keyword\">TEMPORARY</span> <span class=\"token keyword\">TABLESPACE</span> <span class=\"token keyword\">temp</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">User</span> created<span class=\"token punctuation\">.</span>\n</code></pre></div>\n<p>今度こそユーザの作成ができました！</p>\n<p>ユーザには権限を付けてあげないと表の作成などができないので権限を付けてあげる必要があります。ここでは参考記事と同じ権限を付与してあげます</p>\n<div class=\"remark-highlight\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SQL</span><span class=\"token operator\">></span> <span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">SESSION</span> <span class=\"token keyword\">TO</span> misaka<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">Grant</span> succeeded<span class=\"token punctuation\">.</span>\n\n<span class=\"token keyword\">SQL</span><span class=\"token operator\">></span> <span class=\"token keyword\">GRANT</span> RESOURCE <span class=\"token keyword\">TO</span> misaka<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">Grant</span> succeeded<span class=\"token punctuation\">.</span>\n\n<span class=\"token keyword\">SQL</span><span class=\"token operator\">></span> <span class=\"token keyword\">GRANT</span> UNLIMITED <span class=\"token keyword\">TABLESPACE</span> <span class=\"token keyword\">TO</span> misaka<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">Grant</span> succeeded<span class=\"token punctuation\">.</span>\n</code></pre></div>\n<ul>\n<li>CREATE SESSION\n<ul>\n<li>データベースに接続を許可するシステム権限</li>\n</ul>\n</li>\n<li>RESOURCE\n<ul>\n<li>ユーザーに関連付けられたスキーマで特定タイプのスキーマ・オブジェクトの作成、変更および削除を可能にします</li>\n</ul>\n</li>\n<li>UNLIMITED TABLESPACE\n<ul>\n<li>データベース内の表領域を無制限に使用することをユーザーに許可する</li>\n</ul>\n</li>\n</ul>\n<h2>テーブルの作成とローカルから確認</h2>\n<p>テーブルを作成してレコードをインサートしておきます</p>\n<div class=\"remark-highlight\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SQL</span><span class=\"token operator\">></span> <span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> characters <span class=\"token punctuation\">(</span>id NUMBER<span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span><span class=\"token punctuation\">,</span> name VARCHAR2<span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">Table</span> created<span class=\"token punctuation\">.</span>\n\n<span class=\"token keyword\">SQL</span><span class=\"token operator\">></span> <span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> characters <span class=\"token keyword\">values</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'misaka'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token number\">1</span> <span class=\"token keyword\">row</span> created<span class=\"token punctuation\">.</span>\n\n<span class=\"token keyword\">SQL</span><span class=\"token operator\">></span> <span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> characters <span class=\"token keyword\">values</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'sirai'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token number\">1</span> <span class=\"token keyword\">row</span> created<span class=\"token punctuation\">.</span>\n\n<span class=\"token keyword\">SQL</span><span class=\"token operator\">></span> <span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> characters <span class=\"token keyword\">values</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'sogita'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token number\">1</span> <span class=\"token keyword\">row</span> created<span class=\"token punctuation\">.</span>\n\n<span class=\"token keyword\">SQL</span><span class=\"token operator\">></span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> characters<span class=\"token punctuation\">;</span>\n\n        ID NAME\n<span class=\"token comment\">---------- ----------</span>\n         <span class=\"token number\">1</span> misaka\n         <span class=\"token number\">2</span> sirai\n         <span class=\"token number\">3</span> sogita\n</code></pre></div>\n<p>次にローカルのSQLクライアントからOracleに繋いでレコードを取得します</p>\n<p><img src=\"/3854/2.png\" alt=\"画像\"></p>\n<p>なんとテーブルが存在しませんでした…</p>\n<p>どうやらユーザ名.テーブル名で作成しないといけないようです</p>\n<div class=\"remark-highlight\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SQL</span><span class=\"token operator\">></span> <span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> misaka<span class=\"token punctuation\">.</span>characters2 <span class=\"token punctuation\">(</span>id NUMBER<span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span><span class=\"token punctuation\">,</span> name VARCHAR2<span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">Table</span> created<span class=\"token punctuation\">.</span>\n\n<span class=\"token keyword\">SQL</span><span class=\"token operator\">></span> <span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> misaka<span class=\"token punctuation\">.</span>characters2 <span class=\"token keyword\">values</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'misaka'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token number\">1</span> <span class=\"token keyword\">row</span> created<span class=\"token punctuation\">.</span>\n\n<span class=\"token keyword\">SQL</span><span class=\"token operator\">></span> <span class=\"token keyword\">commit</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">Commit</span> complete<span class=\"token punctuation\">.</span>\n</code></pre></div>\n<p>気を取り直して確認してみます</p>\n<p><img src=\"/3854/3.png\" alt=\"画像\"></p>\n<p>なんとか確認ができました…!!</p>\n<p>Oracleはデータベースを操作してる感がいいですけど、少し敷居が高いですね。Dockerを使ってOracleの勉強ができることがわかったので、もう少しいじってみたいと思います。</p>\n<p>業務でDBサーバーなんかを使っていると、表領域を作ったり壊したりなんてのを気楽にできないですが、コンテナならいくら壊そうが問題ないので勉強には最適です</p>","slug":"p3854"},"__N_SSG":true}