{"pageProps":{"frontMatter":{"title":"Springでdomaを使う | Maven","date":"2022.02.19","description":"Springでdomaを使う | Maven","categories":["Java"]},"content":"<p>domaを使うことでsqlファイルを実装として使うことができます。利用環境の構築で少し迷ったのでメモ残しておきます</p>\n<p>参考：https://qiita.com/toki_k/items/9e89613c10bc61f1ab38</p>\n<p>参考：https://doma.readthedocs.io/en/2.20.0/build/</p>\n<h3>pomの修正</h3>\n<p>domaを利用するには以下のものを追加</p>\n<div class=\"remark-highlight\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>dependency</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>groupId</span><span class=\"token punctuation\">></span></span>org.seasar.doma<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;/</span>groupId</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>artifactId</span><span class=\"token punctuation\">></span></span>doma<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;/</span>artifactId</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>version</span><span class=\"token punctuation\">></span></span>2.29.0<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;/</span>version</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;/</span>dependency</span><span class=\"token punctuation\">></span></span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>dependency</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>groupId</span><span class=\"token punctuation\">></span></span>org.seasar.doma.boot<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;/</span>groupId</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>artifactId</span><span class=\"token punctuation\">></span></span>doma-spring-boot-starter<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;/</span>artifactId</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;</span>version</span><span class=\"token punctuation\">></span></span>1.5.0<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;/</span>version</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&#x3C;/</span>dependency</span><span class=\"token punctuation\">></span></span>\n</code></pre></div>\n<h3>Java Build Path</h3>\n<p>src/main/resourcesのExcludedを全て削除する。ここで除外対象にするとsqlファイルがtargetに出力されない？</p>\n<p><img src=\"/1254/1.png\" alt=\"画像\"></p>\n<h3>Factory Path</h3>\n<p>domaのjarファイルを指定する。m2フォルダにインストールされているのでそこを参照させる。</p>\n<p><img src=\"/1254/2.png\" alt=\"画像\"></p>\n<h3>META-INF</h3>\n<p>src/main/resourcesは以下に作成する</p>\n<p><img src=\"/1254/3.png\" alt=\"画像\"></p>\n<p>作成するSQLファイルは、パッケージ+クラス名のフォルダに、メソッド名.sqlで作成する</p>\n<p>以下の場合</p>\n<div class=\"remark-highlight\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">package</span> <span class=\"token namespace\">com<span class=\"token punctuation\">.</span>volkruss<span class=\"token punctuation\">.</span>misakaspring<span class=\"token punctuation\">.</span>transaction<span class=\"token punctuation\">.</span>entity</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">javax<span class=\"token punctuation\">.</span>persistence<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Column</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">javax<span class=\"token punctuation\">.</span>persistence<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Id</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>seasar<span class=\"token punctuation\">.</span>doma<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Entity</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>seasar<span class=\"token punctuation\">.</span>doma<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Table</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">lombok<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Getter</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">lombok<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Setter</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token annotation punctuation\">@Setter</span>\n<span class=\"token annotation punctuation\">@Getter</span>\n<span class=\"token annotation punctuation\">@Entity</span> <span class=\"token comment\">//こっちのほうをつけないとdomaが反応しない</span>\n<span class=\"token annotation punctuation\">@Table</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"animations\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">DomaAnimation</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token annotation punctuation\">@Id</span>\n\t<span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> id<span class=\"token punctuation\">;</span>\n\t\n\t<span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"title\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> title<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n</code></pre></div>\n<p>フォルダはクラス名まで作成する。私はここをうっかりしていました。</p>\n<p><img src=\"/1254/4.png\" alt=\"画像\"></p>\n<h3>Entity</h3>\n<p>Entityはorg.seasar.doma.Entityのアノテーションを付与する必要がある。javaxのほうをつけててエラーになってた。</p>\n<div class=\"remark-highlight\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">package</span> <span class=\"token namespace\">com<span class=\"token punctuation\">.</span>volkruss<span class=\"token punctuation\">.</span>misakaspring<span class=\"token punctuation\">.</span>transaction<span class=\"token punctuation\">.</span>entity</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">javax<span class=\"token punctuation\">.</span>persistence<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Column</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">javax<span class=\"token punctuation\">.</span>persistence<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Id</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>seasar<span class=\"token punctuation\">.</span>doma<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Entity</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>seasar<span class=\"token punctuation\">.</span>doma<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Table</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">lombok<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Getter</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">lombok<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Setter</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token annotation punctuation\">@Setter</span>\n<span class=\"token annotation punctuation\">@Getter</span>\n<span class=\"token annotation punctuation\">@Entity</span> <span class=\"token comment\">//こっちのほうをつけないとdomaが反応しない</span>\n<span class=\"token annotation punctuation\">@Table</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"animations\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">DomaAnimation</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token annotation punctuation\">@Id</span>\n\t<span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> id<span class=\"token punctuation\">;</span>\n\t\n\t<span class=\"token annotation punctuation\">@Column</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"title\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> title<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h3>Dao</h3>\n<p>アノテーションをつけておくことと、ここで利用するメソッドに対応するSQLファイルを作成することが大事</p>\n<div class=\"remark-highlight\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">package</span> <span class=\"token namespace\">com<span class=\"token punctuation\">.</span>volkruss<span class=\"token punctuation\">.</span>misakaspring<span class=\"token punctuation\">.</span>dao<span class=\"token punctuation\">.</span>doma</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>seasar<span class=\"token punctuation\">.</span>doma<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Dao</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>seasar<span class=\"token punctuation\">.</span>doma<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Select</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>seasar<span class=\"token punctuation\">.</span>doma<span class=\"token punctuation\">.</span>boot<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ConfigAutowireable</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>volkruss<span class=\"token punctuation\">.</span>misakaspring<span class=\"token punctuation\">.</span>transaction<span class=\"token punctuation\">.</span>entity<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">DomaAnimation</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// entityアノテーションのクラスを作る</span>\n<span class=\"token comment\">// このようなインターフェースを作る</span>\n<span class=\"token comment\">// SQLを作る</span>\n<span class=\"token comment\">//アノテーション付けてSQLファイルを利用する</span>\n<span class=\"token annotation punctuation\">@ConfigAutowireable</span>\n<span class=\"token annotation punctuation\">@Dao</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">AnimationDomaDao</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token comment\">//アノテーションを付けて対応するSQLファイルを作成する</span>\n\t<span class=\"token comment\">// meta-inf配下でパッケージと同じ構成でdaoインターフェースで定義したメソッド名.sqlを用意する</span>\n\t<span class=\"token annotation punctuation\">@Select</span>\n\t<span class=\"token class-name\">DomaAnimation</span> <span class=\"token function\">selectbyid</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\n\t<span class=\"token comment\">/*</span>\n<span class=\"token comment\">\t@Update</span>\n<span class=\"token comment\">\tint update(Animation animation);</span>\n<span class=\"token comment\">\t*/</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h3>sql</h3>\n<p>今回は指定したidのレコードを取得するだけのsqlを利用しました。</p>\n<div class=\"remark-highlight\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> id<span class=\"token punctuation\">,</span>title\n<span class=\"token keyword\">from</span> animations\n<span class=\"token keyword\">where</span> \n<span class=\"token comment\">/*%if id != null */</span>\nid <span class=\"token operator\">=</span> <span class=\"token comment\">/* id */</span><span class=\"token operator\">-</span><span class=\"token number\">1</span>\n<span class=\"token comment\">/*%end*/</span>\n</code></pre></div>\n<h3>application.yaml</h3>\n<p>一応domaの設定はしておきました。</p>\n<div class=\"remark-highlight\"><pre class=\"language-html\"><code class=\"language-html\">doma:\n  batch-size: 500\n  fetch-size: 500\n  naming: lenient-snake-lower-case\n</code></pre></div>\n<p>とりあえず動かすことはできました。</p>","slug":"p1254"},"__N_SSG":true}