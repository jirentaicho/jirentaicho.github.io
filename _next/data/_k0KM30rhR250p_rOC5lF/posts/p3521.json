{"pageProps":{"frontMatter":{"title":"TypeScriptでRPGツクールMVのプラグインを作る","date":"2022.09.03","description":"TypeScriptでRPGツクールMVのプラグインを作る","categories":["TypeScript"]},"content":"<p>結構前に買ったRPGツクールMVが家から出てきたので、そういえばプラグインってTypeScriptで書けるのかな？と思い検索すると型定義情報など準備している猛者もおりました</p>\n<p>http://narazaka.blog109.fc2.com/blog-entry-248.html</p>\n<p>当時モバイル向けに簡単にゲームが作れるソフトということで買ったのですが、大して触ることもせずにしまっていた物だし、そもそもRPGツクール自体がよくわかっていないという状態です。</p>\n<h2>プラグインの認識</h2>\n<p>既存のプラグインを見てみるとTitleCommandPosition.jsというファイルのプラグインを発見しました。</p>\n<p>ここでは即時関数を定義して実行することでプラグインを実行しているようです。またコメントにて定義しているパラメータは画面上から値を設定してあげることもできるようです。</p>\n<p>これはゲーム編集画面のプラグイン管理から認識されるようになっています。</p>\n<p><img src=\"/3521/1.png\" alt=\"画像\"></p>\n<p>まずはゲームのエディタから認識されるプラグインを作成してみます</p>\n<p>TitleCommandPosition.jsを参考にTest.tsというファイルを以下のように作成してみました。</p>\n<div class=\"remark-highlight\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">/// &#x3C;reference types=\"rpgmakermv_typescript_dts\"/></span>\n<span class=\"token comment\">//=============================================================================</span>\n<span class=\"token comment\">// Test.js</span>\n<span class=\"token comment\">//=============================================================================</span>\n\n<span class=\"token comment\">/*:ja</span>\n<span class=\"token comment\"> * @plugindesc  サンプルのプラグインです</span>\n<span class=\"token comment\"> * @author Misaka Mikoto</span>\n<span class=\"token comment\"> *</span>\n<span class=\"token comment\"> * @param Message</span>\n<span class=\"token comment\"> * @desc 表示するメッセージです</span>\n<span class=\"token comment\"> * @default 御坂美琴</span>\n<span class=\"token comment\"> *</span>\n<span class=\"token comment\"> * @help このプラグインには、プラグインコマンドはありません。</span>\n<span class=\"token comment\"> */</span>\n<span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> parameters <span class=\"token operator\">=</span> PluginManager<span class=\"token punctuation\">.</span><span class=\"token function\">parameters</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Test\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>parameters<span class=\"token punctuation\">[</span><span class=\"token string\">\"Message\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>これをjsに変換してRPGツクールのjs/pluginsフォルダに入れると</p>\n<p><img src=\"/3521/2.png\" alt=\"画像\"></p>\n<p>ちゃんと認識されていました。このプラグインを適用してブラウザで実行するとコンソールログに御坂美琴が流れます</p>\n<p><img src=\"/3521/3.png\" alt=\"画像\"></p>\n<p>またplugins.jsも自動的に修正されています</p>\n<div class=\"remark-highlight\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// Generated by RPG Maker.</span>\n<span class=\"token comment\">// Do not edit this file directly.</span>\n<span class=\"token keyword\">var</span> $plugins <span class=\"token operator\">=</span>\n<span class=\"token punctuation\">[</span>\n<span class=\"token punctuation\">{</span><span class=\"token string-property property\">\"name\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"Test\"</span><span class=\"token punctuation\">,</span><span class=\"token string-property property\">\"status\"</span><span class=\"token operator\">:</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span><span class=\"token string-property property\">\"description\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"サンプルのプラグインです\"</span><span class=\"token punctuation\">,</span><span class=\"token string-property property\">\"parameters\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span><span class=\"token string-property property\">\"Message\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"御坂美琴\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>※厳密にいうと認識自体はjsファイルさえ置けばしてくれます。</p>\n<p>blankfile.jsという空ファイルを適用させた結果</p>\n<div class=\"remark-highlight\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// Generated by RPG Maker.</span>\n<span class=\"token comment\">// Do not edit this file directly.</span>\n<span class=\"token keyword\">var</span> $plugins <span class=\"token operator\">=</span>\n<span class=\"token punctuation\">[</span>\n<span class=\"token punctuation\">{</span><span class=\"token string-property property\">\"name\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"blankfile\"</span><span class=\"token punctuation\">,</span><span class=\"token string-property property\">\"status\"</span><span class=\"token operator\">:</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span><span class=\"token string-property property\">\"description\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span><span class=\"token string-property property\">\"parameters\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n</code></pre></div>\n<h2>webpack</h2>\n<p>ここからは少しTypeScriptっぽく書きたいと思いますので、プラグインファイルはバンドルして作成します。そのためwebpackを利用します。</p>\n<p>以下のようなwebpack.config.jsを作成します。</p>\n<div class=\"remark-highlight\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span>\nmodule<span class=\"token punctuation\">.</span><span class=\"token property-access\">exports</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">mode</span><span class=\"token operator\">:</span> <span class=\"token string\">\"none\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 余計なコメントが入るのでnoneを指定</span>\n    <span class=\"token literal-property property\">entry</span><span class=\"token operator\">:</span> <span class=\"token string\">'./src/main.ts'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 入口となるファイル</span>\n    <span class=\"token literal-property property\">output</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>   <span class=\"token comment\">//　バンドルしたファイルの出力先</span>\n        <span class=\"token literal-property property\">path</span><span class=\"token operator\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">resolve</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'public'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// publicフォルダ</span>\n        <span class=\"token literal-property property\">filename</span><span class=\"token operator\">:</span> <span class=\"token string\">'MyPlugin.js'</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">resolve</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">//インポート時ファイル拡張子を省略します</span>\n        <span class=\"token literal-property property\">extensions</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'.ts'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'.js'</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">module</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">rules</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token literal-property property\">loader</span><span class=\"token operator\">:</span> <span class=\"token string\">'ts-loader'</span><span class=\"token punctuation\">,</span>\n                <span class=\"token literal-property property\">test</span><span class=\"token operator\">:</span> <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\"><span class=\"token special-escape escape\">\\.</span>ts<span class=\"token anchor function\">$</span></span><span class=\"token regex-delimiter\">/</span></span> <span class=\"token punctuation\">,</span>\n                <span class=\"token literal-property property\">exclude</span><span class=\"token operator\">:</span> <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">node_modules</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">performance</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">maxAssetSize</span><span class=\"token operator\">:</span> <span class=\"token number\">99999999</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">//バンドル可能サイズを変更する</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>src/main.tsというファイルを起点にMyPlugin.jsというファイルを作成します。またmodeはnoneにしておきます。</p>\n<p>Sample.tsを作成して以下のように記載します</p>\n<div class=\"remark-highlight\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Sample</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token function\">show</span><span class=\"token punctuation\">(</span>arg<span class=\"token operator\">:</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span>  <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Sample.\"</span> <span class=\"token operator\">+</span> arg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>main.tsではこのSampleクラスを利用します。またshowメソッドの引数はエディタから受け取ります</p>\n<div class=\"remark-highlight\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">/// &#x3C;reference types=\"rpgmakermv_typescript_dts\"/></span>\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Sample <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"./Sample\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//=============================================================================</span>\n<span class=\"token comment\">// main.js</span>\n<span class=\"token comment\">//=============================================================================</span>\n\n<span class=\"token comment\">/*:ja</span>\n<span class=\"token comment\"> * @plugindesc  このプラグインを適用してください</span>\n<span class=\"token comment\"> * @author Misaka Mikoto</span>\n<span class=\"token comment\"> * </span>\n<span class=\"token comment\"> * @param Message</span>\n<span class=\"token comment\"> * @desc 表示するメッセージです</span>\n<span class=\"token comment\"> * @default 御坂美琴</span>\n<span class=\"token comment\"> *</span>\n<span class=\"token comment\"> * @help このプラグインには、プラグインコマンドはありません。</span>\n<span class=\"token comment\"> */</span>\n<span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> params <span class=\"token operator\">=</span> PluginManager<span class=\"token punctuation\">.</span><span class=\"token function\">parameters</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"MyPlugin\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//出力されるファイル名を指定しています</span>\n    <span class=\"token keyword\">const</span> message <span class=\"token operator\">=</span> params<span class=\"token punctuation\">[</span><span class=\"token string\">\"Message\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> sample <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Sample</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    sample<span class=\"token punctuation\">.</span><span class=\"token function\">show</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>そしてnpx webpackコマンドでMyPlugin.jsを作成したら、RPGツクールのプラグインフォルダに入れます。エディタから適用させます。</p>\n<p><img src=\"/3521/4.png\" alt=\"画像\"></p>\n<p>実行してみるとMessageで設定した内容がログ出力されていることが確認できます</p>\n<p><img src=\"/3521/5.png\" alt=\"画像\"></p>\n<p>もう古いソフトなので今更感がありますが、興味本位でやってみました。</p>\n<h2>関連記事</h2>\n<p><a href=\"/posts/p920\">リンク</a></p>\n<h2>その他</h2>\n<p>他にもTypeScriptで書いてるコードがあったので少し見てみました。</p>\n<p>plugins.jsの$pluginsという変数を利用したい時にはアンビエント宣言をします。</p>\n<div class=\"remark-highlight\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">declare</span> <span class=\"token keyword\">namespace</span> <span class=\"token constant\">MV</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">interface</span> <span class=\"token class-name\">Plugin</span> <span class=\"token punctuation\">{</span>\n\t\tname<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n\t\tstatus<span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span><span class=\"token punctuation\">;</span>\n\t\tdescription<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n\t\tparameters<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">[</span>name<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">declare</span> <span class=\"token keyword\">var</span> $plugins<span class=\"token operator\">:</span> <span class=\"token constant\">MV</span><span class=\"token punctuation\">.</span>Plugin<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>こうすることでTypeScriptから$pluginsという変数にアクセスできるだけでなく、nameやdescriptionといった値にもアクセスできるようになります。</p>\n<p>この$pluginsというのは、エディタからプラグインを適用した時に自動設定されるやつです。</p>\n<div class=\"remark-highlight\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// Generated by RPG Maker.</span>\n<span class=\"token comment\">// Do not edit this file directly.</span>\n<span class=\"token keyword\">var</span> $plugins <span class=\"token operator\">=</span>\n<span class=\"token punctuation\">[</span>\n<span class=\"token punctuation\">{</span><span class=\"token string-property property\">\"name\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"Test\"</span><span class=\"token punctuation\">,</span><span class=\"token string-property property\">\"status\"</span><span class=\"token operator\">:</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span><span class=\"token string-property property\">\"description\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"サンプルのプラグインです\"</span><span class=\"token punctuation\">,</span><span class=\"token string-property property\">\"parameters\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span><span class=\"token string-property property\">\"Message\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"御坂美琴\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>このアンビエント宣言によってnameやらにもTypeScriptからアクセスできるようになります。</p>\n<p>ちなみにこれ($plugins)はRPGツクールMVのmain.jsでPluginManager#setupに渡されて読み込みなどが行われています。そして最終的にはloadScriptメソッド(実際には関数が代入されている)にて、scriptタグとしてHTML出力されます。そしてブラウザにて実行されるようになっています。※コードは載せていいのかわからないので未掲載にしています。</p>\n<p>↓こんな感じで生成されている。</p>\n<p><img src=\"/3521/6.png\" alt=\"画像\"></p>","slug":"p3521"},"__N_SSG":true}