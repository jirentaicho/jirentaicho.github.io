<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@site"/><meta name="twitter:creator" content="@keisukesiratori"/><meta property="og:site_name" content="Edelstein"/><title>ゼロからのOS自作入門 | day02</title><meta name="robots" content="index,follow"/><meta name="description" content="ゼロからのOS自作入門 | day02"/><meta property="og:title" content="ゼロからのOS自作入門 | day02"/><meta property="og:description" content="ゼロからのOS自作入門 | day02"/><meta property="og:url" content="http:localhost:3000/posts/p225"/><meta property="og:type" content="website"/><meta property="og:image" content="https://locahost:3000/undefined"/><meta property="og:image:alt" content="ゼロからのOS自作入門 | day02"/><meta property="og:image:width" content="1200"/><meta property="og:image:height" content="700"/><meta name="next-head-count" content="17"/><link rel="preload" href="/_next/static/css/df6bb53438996960.css" as="style"/><link rel="stylesheet" href="/_next/static/css/df6bb53438996960.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-8fa1640cc84ba8fe.js" defer=""></script><script src="/_next/static/chunks/framework-7751730b10fa0f74.js" defer=""></script><script src="/_next/static/chunks/main-480c748fb908b436.js" defer=""></script><script src="/_next/static/chunks/pages/_app-5a840d570c522cf0.js" defer=""></script><script src="/_next/static/chunks/7-a9ae6bf2d6049209.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-31ed6b5e8c78747a.js" defer=""></script><script src="/_next/static/bXc5Sirceq9aybu69XHfq/_buildManifest.js" defer=""></script><script src="/_next/static/bXc5Sirceq9aybu69XHfq/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="flex flex-col min-h-screen bg-zinc-800"><header class="sticky top-0 border-b border-zinc-400 z-10 bg-zinc-900 text-slate-400"><div class="max-w-4xl mx-auto flex justify-between items-center h-12"><a href="/">Home</a><a target="_blank" href="https://github.com/jirentaicho">Github</a><a target="_blank" href="https://zenn.dev/misaka">Zenn</a></div></header><main class="flex-1 max-w-4xl w-full mx-auto"><div class="prose prose-lg max-w-none text-emerald-400"><h1 class="mt-12">ゼロからのOS自作入門 | day02</h1><span>2021.12.02</span><div class="space-x-2"><span><a class="text-emerald-300" href="/categories/OS/">OS</a></span></div></div></main><footer class="bg-zinc-900 text-slate-400"><div class="max-w-4xl w-full mx-auto h-24 flex items-center justify-center"><div>© volkruss.com / Edelstein</div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"frontMatter":{"title":"ゼロからのOS自作入門 | day02","date":"2021.12.02","description":"ゼロからのOS自作入門 | day02","categories":["OS"]},"content":"\u003cp\u003e前回はハローワールドを表示するOSの起動まで行いました。今回はEDKⅡとメモリマップについてです。\u003c/p\u003e\n\u003cp\u003e前回の開発環境構築でedk2フォルダが作成されています。\u003c/p\u003e\n\u003ch3\u003e用語整理\u003c/h3\u003e\n\u003cp\u003eまずは用語を整理します。というかこの辺の用語全然わからない。私はノートパソコンのメモリ増設と、BTOデスクトップのSSD増設くらいしかしたことないにわかです。\u003c/p\u003e\n\u003cp\u003eUEFI\u003c/p\u003e\n\u003cp\u003e従来のBIOSでは古いよってことで従来のBIOSと代わるものとして採用されたそうですが、完全なBIOSの代替というわけではないようですが、新しいBIOSのような認識なのでしょう\u003c/p\u003e\n\u003cp\u003eちなみに私のパソコンはBIOSモードがUEFIになってました\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/225/1.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003eEDK２\u003c/p\u003e\n\u003cp\u003eUEFIとその周辺のプログラムを実装したオープンソースで、UEFIの開発にも、UEFIで動くアプリの開発にも使える”開発キット”だそうです。\u003c/p\u003e\n\u003cp\u003eBIOS\u003c/p\u003e\n\u003cp\u003eそもそもBIOSってのは、OSが起動する前にキーボードやマウス、CPUの管理制御を行うものだそうです。つまりハードウェアの管理と制御\u003c/p\u003e\n\u003cp\u003eブートローダ\u003c/p\u003e\n\u003cp\u003eコンピュータを起動したときに、OSなどを動かすためのプログラム。ハードディスクにあるOSをメインメモリにロードする。\u003c/p\u003e\n\u003cp\u003eBIOSがブートローダを呼出し、ブートローダがOSを呼出すような動きです。\u003c/p\u003e\n\u003cp\u003eこの書籍ではUSBメモリからメインメモリにOSをロードします。\u003c/p\u003e\n\u003cp\u003eメインメモリ\u003c/p\u003e\n\u003cp\u003eCPUが直接データを読み書きできるデータの一時保存場所\u003c/p\u003e\n\u003cp\u003eOS\u003c/p\u003e\n\u003cp\u003e今回の書籍で作るものですね。ユーザーやアプリケーションと、ハードウェアの中間に位置するもの。\u003c/p\u003e\n\u003cp\u003eマウスを動かすというインターフェースを提供するし、画面に表示するのようなインターフェースも提供するようなもの。かしらね。\u003c/p\u003e\n\u003cp\u003eOVMF\u003c/p\u003e\n\u003cp\u003eOpen Virtual Machine Firmwareは仮想マシンでUEFI を使えるようにするプロジェクトです。\u003c/p\u003e\n\u003cp\u003e参考：OVMF による PCI パススルー\u003c/p\u003e\n\u003ch3\u003eブートローダの作成\u003c/h3\u003e\n\u003cp\u003e用語を整理することでなんとなくやろうとしていることが理解できた。\u003c/p\u003e\n\u003cp\u003eまずEDK2の開発キット（ライブラリ）を使ってOSを作っていきます。\u003c/p\u003e\n\u003cp\u003eで、まずやることはOSをメインメモリにロードするためのブートローダを作成する。\u003c/p\u003e\n\u003ch3\u003eビルドに必要な設定を参考書通りに行う\u003c/h3\u003e\n\u003cp\u003eworkspaceでチェックアウトする。。。え？いつ作ったんそれ？開発環境構築でクローンはしてきたけどworkspaceフォルダにやってないような・・・？\u003c/p\u003e\n\u003cp\u003eそもそもこれって開発環境じゃなくて、mikanos本体のリポジトリですよね？クローンしてくれなんてどこに記載があるんだろうか・・・Kindleの検索機能も使えないのがまじで辛い\u003c/p\u003e\n\u003cp\u003eここで付録Bを見る\u003c/p\u003e\n\u003cp\u003eここにいろいろ書いてありました。\u003c/p\u003e\n\u003cp\u003eMikanOSをビルドするには開発環境に加えてMikanOSそのもののソースコードも必要\u003c/p\u003e\n\u003cp\u003eMikanOSのソースコードはどこに配置してもOKで例としてworkspaceを利用します。→本はしっかり付録から読みましょう。。。？？？\u003c/p\u003e\n\u003cp\u003e気を取り直して付録通りにクローンしたら本章のday02に戻ってチェックアウトします。\u003c/p\u003e\n\u003cp\u003eここでようやくMain.Cが参考書通りに記載されているのを確認。\u003c/p\u003e\n\u003cp\u003eedk2フォルダ（開発環境）に対して、$HOME/workspace/mikanos/MikanLoaderPkg（ソースコード）へのシンボリックリンクを張ります。\u003c/p\u003e\n\u003cp\u003eln -s です。Windowsでいうところのショートカット作成のようなもの。\u003c/p\u003e\n\u003cp\u003els -lで確認\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/225/2.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003e失敗すると赤で表示されます\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/225/3.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003eConf/target.txtの作成と、ビルドの設定、EDK２のビルドコマンドの実施まで行う。ビルドはズラーっと長文が流れます。\u003c/p\u003e\n\u003cp\u003etarget.txtにてACTIVE_PLATFORM = MikanLoaderPkg/MikanLoaderPkg.dscとしていますので、先ほどのedk2に張ったシンボリックリンクが有効なら、ソースコードのほうを参照してくれるという感じです。\u003c/p\u003e\n\u003cp\u003eefiファイルができたのでエミュレータで起動してみます。\u003c/p\u003e\n\u003cp\u003e起動\u003c/p\u003e\n\u003cp\u003e前回やったのですが、ほとんど覚えてないので再確認します。\u003c/p\u003e\n\u003cp\u003edevenvのrun_qemu.shを起動したのだ。というわけで以下で実施\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003e$HOME/osbook/devenv/run_qemu.sh Loader.efi\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003cimg src=\"/225/4.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003e上手く動いてることを確認\u003c/p\u003e\n\u003ch2\u003eメモリマップとは\u003c/h2\u003e\n\u003cp\u003eメモリマップとはメインメモリのどの部分が何に使われているか記載した地図。つまりデータがメインメモリのどこにどのように記録されているのか。\u003c/p\u003e\n\u003cp\u003ehttps://www.kushiro-ct.ac.jp/yanagawa/pl2b-2018/01.html\u003c/p\u003e\n\u003ch3\u003eメモリマップを取得するプログラム\u003c/h3\u003e\n\u003cp\u003eとりあえずブランチ変えてビルドするだけでは意味ないのでソースを追ってみます。今回のソースは以下のソース\u003c/p\u003e\n\u003cp\u003ehttps://github.com/uchan-nos/mikanos/blob/osbook_day02b/MikanLoaderPkg/Main.c\u003c/p\u003e\n\u003cp\u003eさて、この章を読んで気が付いた。\u003c/p\u003e\n\u003cp\u003e「C言語がわからない」ドンッ！\u003c/p\u003e\n\u003cp\u003eとりあえずざっと読んで構造体とかポインタとかに目を通す。\u003c/p\u003e\n\u003cp\u003ehttps://www.tohoho-web.com/ex/c-lang.html\u003c/p\u003e\n\u003cp\u003eポインタ\u003c/p\u003e\n\u003cp\u003e変数など宣言したときに、その変数のメモリ上のアドレスを取得するときに利用する。\u003c/p\u003e\n\u003cp\u003e変数aのポインタは int \u003cem\u003eb = \u0026#x26;a;のようにすれば\u003c/em\u003ebにはaのポインタが格納される。\u003c/p\u003e\n\u003cp\u003e値渡しと参照渡し\u003c/p\u003e\n\u003cp\u003e関数に引数を渡す際の渡し方。Javaではできないようなことですな。たしかオブジェクトを渡したときに参照の値渡しになるので引数のオブジェクトをメソッド内で再代入しても呼出し下では変化がない。(ojc.list = newlistはできる）\u003c/p\u003e\n\u003cp\u003eCの場合は参照を渡せるのですね？\u003c/p\u003e\n\u003cp\u003evoid hoge(int *x) { *x = 10 }\u003c/p\u003e\n\u003cp\u003e構造体(struct)\u003c/p\u003e\n\u003cp\u003eメンバ変数のみを定義できるclassのようなもの(ふむふむ)型と変数名のセットを,で区切って定義する。\u003c/p\u003e\n\u003cp\u003eポインタを返す関数\u003c/p\u003e\n\u003cp\u003e戻り値の型に*をつける\u003c/p\u003e\n\u003cp\u003econst CHAR16* GetMemoryTypeUnicode(EFI_MEMORY_TYPE type)\u003c/p\u003e\n\u003cp\u003e構造体の初期化\u003c/p\u003e\n\u003cp\u003ehttps://yu-nix.com/blog/2020/8/7/c-struct-init/\u003c/p\u003e\n\u003cp\u003eようやくソースコードを見ます。。\u003c/p\u003e\n\u003cp\u003eとりあえず入り口であるUefiMainメソッドを見ると\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003e  CHAR8 memmap_buf[4096 * 4];\n  struct MemoryMap memmap = {sizeof(memmap_buf), memmap_buf, 0, 0, 0, 0};\n  GetMemoryMap(\u0026#x26;amp;memmap);\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eまずは構造体を初期化してメモリマップを取得するメソッドに構造体のポインタを渡します。\u003c/p\u003e\n\u003cp\u003eGetMemoryMapメソッドはgBSというブートサービスを表すグローバル変数です。とりあえずこれでメモリマップを取得でき、MemoryMapで指定されたメモリ領域に書き込みます。\u003c/p\u003e\n\u003cp\u003eあとはファイルへの保存とかみたいです。\u003c/p\u003e\n\u003cp\u003e早速ビルドしてみます。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/225/5.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003e次いでに作成されたdisc.imgをマウントして中身を見てみます\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/225/6.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003eその後はポインタの説明で二章終わり。\u003c/p\u003e\n\u003ch2\u003eポインタ\u003c/h2\u003e\n\u003cp\u003e以下のようなコードでポインタを少し理解する\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003e#include \u0026#x26;lt;stdio.h\u0026#x26;gt;\n\nint main(void)\n{\n\t// %pはポインタ　%dはint\n\tint i = 10;\n\tprintf(\u0026#x26;quot;iの値 = %d \\n\u0026#x26;quot;, i);\n\tprintf(\u0026#x26;quot;iのポインタ = %p \\n\u0026#x26;quot;, \u0026#x26;amp;i);\n\n\tint* p = \u0026#x26;amp;i;\n\tprintf(\u0026#x26;quot;iのポインタ変数p = %p \\n\u0026#x26;quot;, p);\n\n\tint r = *p;\n\tprintf(\u0026#x26;quot;iのポインタ変数pを代入したｒ = %d \\n\u0026#x26;quot;, r);\n\n\t*p = 99;\n\tprintf(\u0026#x26;quot;iのポインタ変数pに99を代入しました \\n\u0026#x26;quot;);\n\n\tprintf(\u0026#x26;quot;iの値 = %d \\n\u0026#x26;quot;, i);\n\n\tgetchar();\n\n\treturn 0;\n}\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e出力結果は以下です\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003eiの値 = 10\niのポインタ = 0053FAB8\niのポインタ変数p = 0053FAB8\niのポインタ変数pを代入したｒ = 10\niのポインタ変数pに99を代入しました\niの値 = 99\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e・ポインタは整数と変換できます。\u003c/p\u003e\n\u003cp\u003e・ポインタのポインタを利用して値を変更することもテクニックとしてありよく使います。\u003c/p\u003e\n\u003ch3\u003eサイトなど\u003c/h3\u003e\n\u003cp\u003ehttps://osdev-jp.readthedocs.io/ja/latest/2017/create-uefi-app-with-edk2.html#\u003c/p\u003e\n\u003ch3\u003e思ったこと\u003c/h3\u003e\n\u003cp\u003e・時間かかりすぎているし理解度が低い。これって一通りやって何週かしたほうがいいのかな？\u003c/p\u003e\n\u003cp\u003e・私の読み方が悪い？どうやって手を動かすべきなのか散らばりすぎてる印象。→ようやくこの辺は落ち着いてきた。\u003c/p\u003e\n\u003cp\u003e・ここまではGithubでクローンとかするのはいいんだけど、なんか端折りすぎていて探すのに時間がかかった\u003c/p\u003e","slug":"p225"},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"p225"},"buildId":"bXc5Sirceq9aybu69XHfq","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>