<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@site"/><meta name="twitter:creator" content="@keisukesiratori"/><meta property="og:site_name" content="Edelstein"/><title>トランザクションマネージャについて深く見る | Spring</title><meta name="robots" content="index,follow"/><meta name="description" content="トランザクションマネージャについて深く見る | Spring"/><meta property="og:title" content="トランザクションマネージャについて深く見る | Spring"/><meta property="og:description" content="トランザクションマネージャについて深く見る | Spring"/><meta property="og:url" content="http:localhost:3000/posts/p2420"/><meta property="og:type" content="website"/><meta property="og:image" content="https://locahost:3000/undefined"/><meta property="og:image:alt" content="トランザクションマネージャについて深く見る | Spring"/><meta property="og:image:width" content="1200"/><meta property="og:image:height" content="700"/><meta name="next-head-count" content="17"/><link rel="preload" href="/_next/static/css/df6bb53438996960.css" as="style"/><link rel="stylesheet" href="/_next/static/css/df6bb53438996960.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-8fa1640cc84ba8fe.js" defer=""></script><script src="/_next/static/chunks/framework-7751730b10fa0f74.js" defer=""></script><script src="/_next/static/chunks/main-480c748fb908b436.js" defer=""></script><script src="/_next/static/chunks/pages/_app-5a840d570c522cf0.js" defer=""></script><script src="/_next/static/chunks/7-a9ae6bf2d6049209.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-31ed6b5e8c78747a.js" defer=""></script><script src="/_next/static/AkuQOCUS04X5_x3YaJhBO/_buildManifest.js" defer=""></script><script src="/_next/static/AkuQOCUS04X5_x3YaJhBO/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="flex flex-col min-h-screen bg-zinc-800"><header class="sticky top-0 border-b border-zinc-400 z-10 bg-zinc-900 text-slate-400"><div class="max-w-4xl mx-auto flex justify-between items-center h-12"><a href="/">Home</a><a target="_blank" href="https://github.com/jirentaicho">Github</a><a target="_blank" href="https://zenn.dev/misaka">Zenn</a></div></header><main class="flex-1 max-w-4xl w-full mx-auto"><div class="prose prose-lg max-w-none text-emerald-400"><h1 class="mt-12">トランザクションマネージャについて深く見る | Spring</h1><span>2022.05.20</span><div class="space-x-2"><span><a class="text-emerald-300" href="/categories/Spring/">Spring</a></span></div></div></main><footer class="bg-zinc-900 text-slate-400"><div class="max-w-4xl w-full mx-auto h-24 flex items-center justify-center"><div>© volkruss.com / Edelstein</div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"frontMatter":{"title":"トランザクションマネージャについて深く見る | Spring","date":"2022.05.20","description":"トランザクションマネージャについて深く見る | Spring","categories":["Spring"]},"content":"\u003cp\u003eトランザクションマネージャを利用することで、トランザクションの制御を細かく設定できる。またトランザクションの制御も複雑になっているので、その辺も確認する。\u003c/p\u003e\n\u003cp\u003eトランザクションマネージャ3つの利用方法\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eBean定義する\n\u003cul\u003e\n\u003cli\u003ePlatformTransactionManagerの実装クラスをBean定義する\u003c/li\u003e\n\u003cli\u003eAdviceの設定をするどのようなメソッドの時に、どのような設定でトランザクションを行うかを記載\n\u003cul\u003e\n\u003cli\u003eどのようなメソッドの時に、どのような設定でトランザクションを行うかを記載\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eアノテーションによる宣言的トランザクション\n\u003cul\u003e\n\u003cli\u003e@Transactionalアノテーションを使う。一番使いやすい。\u003c/li\u003e\n\u003cli\u003eアノテーションの要素にトランザクションの定義情報を記載できる\u003c/li\u003e\n\u003cli\u003eProxyを介してトランザクションが行われる\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e明示的トランザクション\n\u003cul\u003e\n\u003cli\u003eソースコード上でPlatformTransactionManagerから提供されるメソッドを利用してトランザクションの制御を行う\u003c/li\u003e\n\u003cli\u003e同一クラス内の処理の一部でトランザクション処理を行いたい場合(Proxyを介さない)に対応できる通常は宣言的トランザクションを利用すれば良いです\n\u003cul\u003e\n\u003cli\u003e通常は宣言的トランザクションを利用すれば良いです\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e今回は明示的トランザクションについて見ていきますが、軽くアノテーションを使う宣言的トランザクションも見ていきます。明示的トランザクションを見る理由は、APIの使い方がわかりやすいからです。※宣言的トランザクションの利用が推奨されているらしいです。\u003c/p\u003e\n\u003ch2\u003eトランザクションマネージャの実装クラス\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eDataSourceTransactionManager\n\u003cul\u003e\n\u003cli\u003e1つのデータソースに対してトランザクション制御を行う\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eHibernateTransactionManager\n\u003cul\u003e\n\u003cli\u003eHibernate用\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eJpaTransactionManager\n\u003cul\u003e\n\u003cli\u003eJPAのEntityManagerに対してトランザクション制御を行う\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eJtaTransactionManager\n\u003cul\u003e\n\u003cli\u003eJTA用\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e使用するデータアクセス技術に合わせて利用する。\u003c/p\u003e\n\u003ch2\u003ePlatformTransactionManager\u003c/h2\u003e\n\u003cp\u003e全てのトランザクションマネージャが実装しているインターフェースです。\u003c/p\u003e\n\u003cp\u003e公開されているメソッド\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003egetTransaction\u003c/li\u003e\n\u003cli\u003ecommit\u003c/li\u003e\n\u003cli\u003erollback\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e下の2つは想像通りの動きをすると思います。\u003c/p\u003e\n\u003cp\u003egetTransactionは指定された伝搬動作に従って、現在アクティブなトランザクションを返すか、新しいトランザクションを返すそうです。以下は実装の一部で、見る限りトランザクションを開始してトランザクションを返しています\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edef\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetPropagationBehavior\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eTransactionDefinition\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003ePROPAGATION_REQUIRED\u003c/span\u003e \u003cspan class=\"token operator\"\u003e||\u003c/span\u003e\n\t\tdef\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetPropagationBehavior\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eTransactionDefinition\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003ePROPAGATION_REQUIRES_NEW\u003c/span\u003e \u003cspan class=\"token operator\"\u003e||\u003c/span\u003e\n\t\tdef\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetPropagationBehavior\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eTransactionDefinition\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003ePROPAGATION_NESTED\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token class-name\"\u003eSuspendedResourcesHolder\u003c/span\u003e suspendedResources \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003esuspend\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edebugEnabled\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\tlogger\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003edebug\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Creating new transaction with name [\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e def\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetName\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"]: \"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e def\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003etry\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token function\"\u003estartTransaction\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edef\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e transaction\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e debugEnabled\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e suspendedResources\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003ecatch\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eRuntimeException\u003c/span\u003e \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eError\u003c/span\u003e ex\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token function\"\u003eresume\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e suspendedResources\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003ethrow\u003c/span\u003e ex\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cul\u003e\n\u003cli\u003eパラメータのdefinitionは、伝搬の動作、分離レベル、タイムアウトなどを記述したTransactionDefinition のインスタンス (デフォルトでは NULL も可能)。とのことなので、TransactionDefinitionこそが\u003c/li\u003e\n\u003cli\u003e伝搬動作\n\u003cul\u003e\n\u003cli\u003eこの3つの伝搬動作はトランザクションを開始する動作を表しています。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003e伝搬動作\u003c/h2\u003e\n\u003cp\u003eトランザクション制御に利用している伝搬動作は重要なのが2つあります\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e伝搬属性\u003c/li\u003e\n\u003cli\u003e独立性レベル\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003e伝搬属性\u003c/h3\u003e\n\u003cp\u003e上記コードにも出てきましたが、TransactionDefinition.PROPAGATION_REQUIREDなどが伝搬属性です。どれもトランザクションを開始するという意味ですが、別のトランザクションから呼ばれた時の振る舞いが異なります。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePROPAGATION_REQUIRED\n\u003cul\u003e\n\u003cli\u003eトランザクションを開始する\u003c/li\u003e\n\u003cli\u003eただし別のトランザクションから呼ばれた時は、そのトランザクションに参加する\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003ePROPAGATION_REQUIRES_NEW\n\u003cul\u003e\n\u003cli\u003eトランザクションを開始する\u003c/li\u003e\n\u003cli\u003eただし別のトランザクションから呼ばれた時は、新しいトランザクションを開始する\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003ePROPAGATION_NESTED\n\u003cul\u003e\n\u003cli\u003eトランザクションを開始する\u003c/li\u003e\n\u003cli\u003eただし別のトランザクションから呼ばれた時は、部分的なトランザクションを開始する\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003ePROPAGATION_MANDATORY\n\u003cul\u003e\n\u003cli\u003e例外を投げる\u003c/li\u003e\n\u003cli\u003eただし別のトランザクションから呼ばれた時は、そのトランザクションに参加する\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e例えば採番処理なんかは、多くの機能から呼ばれることになるので常に新しいトランザクションを開始(PROPAGATION_REQUIRES_NEW)を選択しても良いでしょう。\u003c/p\u003e\n\u003cp\u003eまた在庫更新などは、出荷や受注などの機能と同時に呼ばれることが前提になるのでPROPAGATION_MANDATORYを選択するべきです。\u003c/p\u003e\n\u003cp\u003e他にもトランザクションを開始しない(PROPAGATION_SUPPORTS)などの伝搬属性があります。\u003c/p\u003e\n\u003cp\u003ePROPAGATION_SUPPORTSは正確には、トランザクションを行わないが、他のトランザクションから呼ばれた時は、そのトランザクションに参加します。\u003c/p\u003e\n\u003cp\u003e完全にトランザクションを開始しない場合はPROPAGATION_NOT_SUPPORTEDを利用します。\u003c/p\u003e\n\u003ch2\u003e独立性レベル\u003c/h2\u003e\n\u003cp\u003e簡単に言うと「別のトランザクションが更新したけどコミットしてないデータの扱い方」みたいなものだと思います。\u003c/p\u003e\n\u003cp\u003e更新したけどコミットしていないということは、のちにロールバックされる可能性がある=不確定な状態ということです。\u003c/p\u003e\n\u003cp\u003eそういった不確定な状態のデータを矛盾なく処理を行う性質が独立性です。\u003c/p\u003e\n\u003cp\u003eデフォルトがISOLATION_DEFAULT(データベースに依存する)ということになっています。\u003c/p\u003e\n\u003cp\u003eデータ矛盾が生じる状態\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eDirty Read\n\u003cul\u003e\n\u003cli\u003e他のトランザクションが変更してコミットしていないデータを読み出すことDirty = 汚い\n\u003cul\u003e\n\u003cli\u003eDirty = 汚い\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eUnrepeatable Read\n\u003cul\u003e\n\u003cli\u003eトランザクションが同じデータを複数回読み出す時に、他のトランザクションが途中でそのデータを更新すると、以前と違うデータを読み出してしまうことUnrepeatable = 繰り返し不可能\n\u003cul\u003e\n\u003cli\u003eUnrepeatable = 繰り返し不可能\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003ePhantom Read\n\u003cul\u003e\n\u003cli\u003eトランザクションが同じデータを複数回読み出す時に、他のトランザクションが途中でレコードを追加すると、以前は存在しなかったレコードを読み出してしまうことPhantom = 幽霊\n\u003cul\u003e\n\u003cli\u003ePhantom = 幽霊\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e下に行くほど独立性レベルが強く矛盾を許さない。独立性レベルが強くなるとパフォーマンスが悪くなる。処理対象のレコードやテーブルにロックをかけて他方のトランザクションの処理を持たせることで独立性を確保することが多い（データベースによって異なる）\u003c/p\u003e\n\u003cp\u003eソースのコメントAI翻訳すると以下のようになりました\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eISOLATION_READ_UNCOMMITTED\n\u003cul\u003e\n\u003cli\u003eダーティリード、非再現性リード、ファントムリードが発生する可能性があることを示します。このレベルでは、あるトランザクションで変更された行を、その行の変更がコミットされる前に別のトランザクションで読み取ることができます（”ダーティリード”）。変更のいずれかがロールバックされると、2番目のトランザクションは無効な行を取得したことになります。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eREAD_COMMITTED\n\u003cul\u003e\n\u003cli\u003eダーティな読み取りが防止されることを示します。繰り返し不可能な読み取りやファントム・リードは発生する可能性があります。このレベルは、トランザクションがコミットされていない変更のある行を読み取ることを禁止するだけです。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eISOLATION_REPEATABLE_READ\n\u003cul\u003e\n\u003cli\u003eダーティリードと非再現性リードが禁止されていることを示しますが、ファントムリードが発生する可能性があります。このレベルでは、トランザクションがコミットされていない変更のある行を読み取ることを禁止します。また、あるトランザクションが行を読み取り、2番目のトランザクションがその行を変更し、最初のトランザクションが行を再読み取りして2回目に異なる値を取得するという状況（「非再現性読み取り」）も禁止されます。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eISOLATION_SERIALIZABLE\n\u003cul\u003e\n\u003cli\u003eダーティリード、非再現性リード、ファントム・リードが防止されていることを示します。このレベルはISOLATION_REPEATABLE_READの禁止事項を含み、さらに、あるトランザクションがWHERE条件を満たすすべての行を読み取り、2番目のトランザクションがそのWHERE条件を満たす行を挿入し、最初のトランザクションが同じ条件で再読み取りし、2番目の読み取りで追加の「ファントム」行を取得するという状況を禁止している。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eデフォルトで困ったら考えればいいのかな？これで思い出したけど、トランザクションかかってんだからデータを読み出せないじゃん！ってなったことがあったけど、独立性をいじれば良かったのか？（フレームワークで設定してていじれなかったと思うのですが・・・）完全に独り言です。すみません。。。\u003c/p\u003e\n\u003ch3\u003e他のトランザクション定義情報\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eタイムアウト\n\u003cul\u003e\n\u003cli\u003eトランザクションがキャンセルされるタイムアウトの時間(秒単位)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e読み取り専用\n\u003cul\u003e\n\u003cli\u003eトランザクション内の処理が読み取り専用かどうか\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eロールバック対象例外\n\u003cul\u003e\n\u003cli\u003eどの例外の時にロールバックするか設定できる。デフォルトでは実行時例外の場合。検査例外が投げられてもロールバックされない明示的トランザクションの場合はExceptionでもロールバックされました。\n\u003cul\u003e\n\u003cli\u003e検査例外が投げられてもロールバックされない明示的トランザクションの場合はExceptionでもロールバックされました。\u003c/li\u003e\n\u003cli\u003e明示的トランザクションの場合はExceptionでもロールバックされました。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eコミット対象例外\n\u003cul\u003e\n\u003cli\u003eどの例外の時にコミットするか設定できる。デフォルトでは検査例外が投げられた際はコミットが行われる。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003e明示的トランザクションを利用する\u003c/h2\u003e\n\u003cp\u003e前提知識が多かったですが、ようやく実装に入りたいと思います。今回はSpringBoot環境で実装を行っていきます。\u003c/p\u003e\n\u003cp\u003e全体のソースは以下のブランチにあげております。\u003c/p\u003e\n\u003cp\u003ehttps://github.com/jirentaicho/springboot-transaction-sample/tree/dev01\u003c/p\u003e\n\u003cp\u003e以下のようなテーブルを利用します\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/2420/1.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003e処理説明\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eacceptを登録します\n\u003cul\u003e\n\u003cli\u003eaccpetで登録するstockをstocksから取得します\u003c/li\u003e\n\u003cli\u003estockのcountをacceptのcountだけ減算しますacceptのcountは100を想定しています\u003c/li\u003e\n\u003cli\u003estockのcountがマイナス値の場合は例外になりますstockの件数が100以下なら例外になります\u003c/li\u003e\n\u003cli\u003eacceptレコードの追加処理を行います\u003c/li\u003e\n\u003cli\u003estockレコードの更新処理を行います。\n\u003cul\u003e\n\u003cli\u003eacceptのcountは100を想定しています\u003c/li\u003e\n\u003cli\u003estockの件数が100以下なら例外になります\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token annotation punctuation\"\u003e@Service\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eAcceptServiceImpl\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eimplements\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eAcceptService\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\n    \u003cspan class=\"token annotation punctuation\"\u003e@Autowired\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eAcceptRepository\u003c/span\u003e acceptRepository\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token annotation punctuation\"\u003e@Autowired\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eItemRepository\u003c/span\u003e itemRepository\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token annotation punctuation\"\u003e@Autowired\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eStockRepository\u003c/span\u003e stockRepository\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token annotation punctuation\"\u003e@Autowired\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"token class-name\"\u003ePlatformTransactionManager\u003c/span\u003e txManager\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token annotation punctuation\"\u003e@Override\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"token function\"\u003ecreateAccept\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eAcceptController\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eRegistAcceptModel\u003c/span\u003e model\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethrows\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eException\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e//定義情報を作成します\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003eDefaultTransactionDefinition\u003c/span\u003e def \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eDefaultTransactionDefinition\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        def\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esetPropagationBehavior\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eTransactionDefinition\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003ePROPAGATION_REQUIRED\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        def\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esetIsolationLevel\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eTransactionDefinition\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003eISOLATION_DEFAULT\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        def\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esetTimeout\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e10\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        def\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esetReadOnly\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// トランザクションを開始します\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003eTransactionStatus\u003c/span\u003e status \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e txManager\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetTransaction\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edef\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003etry\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e// ドメインモデルの作成\u003c/span\u003e\n            \u003cspan class=\"token class-name\"\u003eAccept\u003c/span\u003e accept \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eAccept\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003emodel\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eitemId\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003emodel\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecustomerName\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003emodel\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecount\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e// 受注の登録をする\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e// わかりやすくロールバックを確認するためここで永続化します\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eacceptRepository\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eregister\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eaccept\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"token comment\"\u003e// 在庫の取得\u003c/span\u003e\n            \u003cspan class=\"token class-name\"\u003eStock\u003c/span\u003e stock \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003estockRepository\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efindStockByItemId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eaccept\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetItemId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"token comment\"\u003e// 在庫を減らす(本当の業務なら実在庫を減らすことはせず予定在庫を減らすなど)\u003c/span\u003e\n            stock\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esubCount\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eaccept\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetCount\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e// 在庫の整合性を確認する\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estock\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eisMinus\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"token comment\"\u003e// 適当な例外投げてます\u003c/span\u003e\n                \u003cspan class=\"token keyword\"\u003ethrow\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eRuntimeException\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e// 在庫の更新をする\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003estockRepository\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esave\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estock\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ecatch\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eRuntimeException\u003c/span\u003e e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e// 例外が発生した時にロールバックする\u003c/span\u003e\n            txManager\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003erollback\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estatus\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003ethrow\u003c/span\u003e e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// コミットする\u003c/span\u003e\n        txManager\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ecommit\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estatus\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cul\u003e\n\u003cli\u003ePlatformTransactionManagerをインジェクションすることでトランザクションマネージャを利用できます\u003c/li\u003e\n\u003cli\u003enew DefaultTransactionDefinition();\n\u003cul\u003e\n\u003cli\u003e定義情報を作成して、定義情報を設定していきます\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003etxManager.getTransaction(def);\n\u003cul\u003e\n\u003cli\u003e定義情報を元にトランザクションを取得(開始)します\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003eTransactionTemplateを利用する\u003c/h3\u003e\n\u003cp\u003eもう一つのやり方としてTransactionTemplateを利用する方法があります。\u003c/p\u003e\n\u003cp\u003eソースコードは以下のブランチにあげています。\u003c/p\u003e\n\u003cp\u003ehttps://github.com/jirentaicho/springboot-transaction-sample/tree/dev-template\u003c/p\u003e\n\u003cp\u003eこちらはcommitやrollbackのメソッドの呼び出しを隠蔽してくれます。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token annotation punctuation\"\u003e@Service\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eAcceptServiceImpl\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eimplements\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eAcceptService\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\n    \u003cspan class=\"token annotation punctuation\"\u003e@Autowired\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eAcceptRepository\u003c/span\u003e acceptRepository\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token annotation punctuation\"\u003e@Autowired\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eItemRepository\u003c/span\u003e itemRepository\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token annotation punctuation\"\u003e@Autowired\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eStockRepository\u003c/span\u003e stockRepository\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token annotation punctuation\"\u003e@Autowired\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"token class-name\"\u003ePlatformTransactionManager\u003c/span\u003e txManager\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token annotation punctuation\"\u003e@Override\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"token function\"\u003ecreateAccept\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eAcceptController\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eRegistAcceptModel\u003c/span\u003e model\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethrows\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eException\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\n        \u003cspan class=\"token class-name\"\u003eTransactionTemplate\u003c/span\u003e tm \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eTransactionTemplate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etxManager\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        tm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esetPropagationBehavior\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eTransactionDefinition\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003ePROPAGATION_REQUIRED\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        tm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esetIsolationLevel\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eTransactionDefinition\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003eISOLATION_DEFAULT\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        tm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esetTimeout\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e10\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        tm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esetReadOnly\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        tm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eexecute\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estatus\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e// ドメインモデルの作成\u003c/span\u003e\n            \u003cspan class=\"token class-name\"\u003eAccept\u003c/span\u003e accept \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eAccept\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003emodel\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eitemId\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003emodel\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecustomerName\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003emodel\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecount\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e// 受注の登録をする\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e// わかりやすくロールバックを確認するためここで永続化します\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eacceptRepository\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eregister\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eaccept\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e// 在庫の取得\u003c/span\u003e\n            \u003cspan class=\"token class-name\"\u003eStock\u003c/span\u003e stock \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003estockRepository\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efindStockByItemId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eaccept\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetItemId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e// 在庫を減らす(本当の業務なら実在庫を減らすことはせず予定在庫を減らすなど)\u003c/span\u003e\n            stock\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esubCount\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eaccept\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetCount\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e// 在庫の整合性を確認する\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estock\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eisMinus\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"token comment\"\u003e// 適当な例外投げてます\u003c/span\u003e\n                \u003cspan class=\"token keyword\"\u003ethrow\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eRuntimeException\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e// 在庫の更新をする\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003estockRepository\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esave\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estock\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eDataAccessStatus\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003eSUCCESS\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token doc-comment comment\"\u003e/**\u003c/span\u003e\n\u003cspan class=\"token doc-comment comment\"\u003e     * return nullの代用\u003c/span\u003e\n\u003cspan class=\"token doc-comment comment\"\u003e     */\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eenum\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eDataAccessStatus\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token constant\"\u003eSUCCESS\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token constant\"\u003eERROR\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cul\u003e\n\u003cli\u003eTransactionTemplateを作成する際にトランザクションマネージャを渡しています\u003c/li\u003e\n\u003cli\u003eexecute内にトランザクション内の処理を記載すれば、自動的にロールバックもコミットもしてくれます。\u003c/li\u003e\n\u003cli\u003eexecuteメソッドの引数に渡すラムダ式は、戻り値が特にない場合はreturn null;をしている例もありましたが、あまり好きじゃないので形式的なenumを返しています。\u003c/li\u003e\n\u003cli\u003eTransactionCallbackWithoutResultをオーバーライドした戻り値なしのケースも作成できます。\n\u003cul\u003e\n\u003cli\u003eただ、今回の例ではスコープの問題等で実装していません。\u003c/li\u003e\n\u003cli\u003eラムダを使った方が圧倒的に良いです。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003e伝搬属性の確認\u003c/h2\u003e\n\u003cp\u003e次に伝搬属性について見ていきます。あまり無いケースかと思いますが、サービスからサービスを呼出して無理矢理トランザクション内からトランザクション処理を呼び出します。\u003c/p\u003e\n\u003ch3\u003eREQUIRES_NEW\u003c/h3\u003e\n\u003cp\u003eこのパターンは新しいトランザクションを開始するパターンです。\u003c/p\u003e\n\u003cp\u003e全体のソースコードは以下のブランチにあげております。\u003c/p\u003e\n\u003cp\u003ehttps://github.com/jirentaicho/springboot-transaction-sample/tree/req_new\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token annotation punctuation\"\u003e@Override\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"token function\"\u003ecreateAccept\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eAcceptController\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eRegistAcceptModel\u003c/span\u003e model\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethrows\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eException\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\n        \u003cspan class=\"token class-name\"\u003eDefaultTransactionDefinition\u003c/span\u003e def \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eDefaultTransactionDefinition\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        def\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esetPropagationBehavior\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eTransactionDefinition\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003ePROPAGATION_REQUIRED\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        def\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esetIsolationLevel\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eTransactionDefinition\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003eISOLATION_DEFAULT\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        def\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esetTimeout\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e10\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        def\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esetReadOnly\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003eTransactionStatus\u003c/span\u003e status \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e txManager\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetTransaction\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edef\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003etry\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e// 別のトランザクション処理の呼出しを行う\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003estockService\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eupdate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"token comment\"\u003e// ドメインモデルの作成\u003c/span\u003e\n            \u003cspan class=\"token class-name\"\u003eAccept\u003c/span\u003e accept \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eAccept\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003emodel\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eitemId\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003emodel\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecustomerName\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003emodel\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecount\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e// 受注の登録をする\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e// わかりやすくロールバックを確認するためここで永続化します\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eacceptRepository\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eregister\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eaccept\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e// 在庫の取得\u003c/span\u003e\n            \u003cspan class=\"token class-name\"\u003eStock\u003c/span\u003e stock \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003estockRepository\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efindStockByItemId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eaccept\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetItemId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e// 在庫を減らす(本当の業務なら実在庫を減らすことはせず予定在庫を減らすなど)\u003c/span\u003e\n            stock\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esubCount\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eaccept\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetCount\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e// 在庫の整合性を確認する\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estock\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eisMinus\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"token comment\"\u003e// 適当な例外投げてます\u003c/span\u003e\n                \u003cspan class=\"token keyword\"\u003ethrow\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eRuntimeException\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e// 在庫の更新をする\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003estockRepository\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esave\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estock\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ecatch\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eRuntimeException\u003c/span\u003e e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            txManager\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003erollback\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estatus\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003ethrow\u003c/span\u003e e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n        txManager\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ecommit\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estatus\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cul\u003e\n\u003cli\u003e先ほどのトランザクションから別のトランザクション処理を呼びます\u003c/li\u003e\n\u003cli\u003e別のトランザクションの処理が完了後、呼び出し元のトランザクションでロールバックを起こします。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token annotation punctuation\"\u003e@Service\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eStockServiceImpl\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eimplements\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eStockService\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\n    \u003cspan class=\"token annotation punctuation\"\u003e@Autowired\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eStockRepository\u003c/span\u003e stockRepository\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token annotation punctuation\"\u003e@Autowired\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"token class-name\"\u003ePlatformTransactionManager\u003c/span\u003e txManager\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token annotation punctuation\"\u003e@Override\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"token function\"\u003eupdate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e//　あくまでトランザクション確認用のメソッドです。\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003eDefaultTransactionDefinition\u003c/span\u003e def \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eDefaultTransactionDefinition\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        def\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esetPropagationBehavior\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eTransactionDefinition\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003ePROPAGATION_REQUIRES_NEW\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token comment\"\u003e//新規トランザクションを開始\u003c/span\u003e\n        def\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esetIsolationLevel\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eTransactionDefinition\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003eISOLATION_DEFAULT\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        def\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esetTimeout\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e10\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        def\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esetReadOnly\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003eTransactionStatus\u003c/span\u003e status \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e txManager\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetTransaction\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edef\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003etry\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token class-name\"\u003eStock\u003c/span\u003e stock \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003estockRepository\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efindStockByItemId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            stock\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esubCount\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e10\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            stockRepository\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esave\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estock\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ecatch\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eRuntimeException\u003c/span\u003e e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            txManager\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003erollback\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estatus\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003ethrow\u003c/span\u003e e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n        txManager\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ecommit\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estatus\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cul\u003e\n\u003cli\u003eid=2のstockのcountを10減算して更新します\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e現在のデータベースのレコードは以下のようになっています。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/2420/2.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003e処理を実行します\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/2420/3.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003e呼び出し元のトランザクションでロールバックしているのに、countが10減っています。\u003c/p\u003e\n\u003cp\u003eこれはdef.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRES_NEW)として、呼び出し元のトランザクションに参加せず、新しいトランザクションを開始しているためです。\u003c/p\u003e\n\u003ch3\u003ePROPAGATION_REQUIRED\u003c/h3\u003e\n\u003cp\u003e全体のソースを以下のブランチにあげております\u003c/p\u003e\n\u003cp\u003ehttps://github.com/jirentaicho/springboot-transaction-sample/tree/required※チェリーピックしているので他のコミットコメントが入ってます。\u003c/p\u003e\n\u003cp\u003eREQUIRES_NEWで行ったことと同じことを、PROPAGATION_REQUIREDにして実行します。こっちは呼び出し元のトランザクションに参加しますので、呼び出し元でロールバックされるとデータのコミットが行われません。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token annotation punctuation\"\u003e@Override\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"token function\"\u003eupdate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e//　あくまでトランザクション確認用のメソッドです。\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003eDefaultTransactionDefinition\u003c/span\u003e def \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eDefaultTransactionDefinition\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        def\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esetPropagationBehavior\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eTransactionDefinition\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003ePROPAGATION_REQUIRED\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token comment\"\u003e//既存トランザクションに参加\u003c/span\u003e\n        def\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esetIsolationLevel\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eTransactionDefinition\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003eISOLATION_DEFAULT\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        def\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esetTimeout\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e10\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        def\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esetReadOnly\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003eTransactionStatus\u003c/span\u003e status \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e txManager\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetTransaction\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edef\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003etry\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token class-name\"\u003eStock\u003c/span\u003e stock \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003estockRepository\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efindStockByItemId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            stock\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esubCount\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e10\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            stockRepository\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esave\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estock\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ecatch\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eRuntimeException\u003c/span\u003e e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            txManager\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003erollback\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estatus\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003ethrow\u003c/span\u003e e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n        txManager\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ecommit\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estatus\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eデータベースの状態も同じです\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/2420/4.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003e実行します\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/2420/5.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003e呼び出し元のトランザクションでロールバックが呼ばれると、レコードの更新は行われませんでした。\u003c/p\u003e\n\u003ch2\u003e宣言的トランザクションの利用\u003c/h2\u003e\n\u003cp\u003eソースは以下のブランチにあげています\u003c/p\u003e\n\u003cp\u003ehttps://github.com/jirentaicho/springboot-transaction-sample/tree/dev02\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token annotation punctuation\"\u003e@Service\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eAcceptServiceImpl\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eimplements\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eAcceptService\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\n    \u003cspan class=\"token annotation punctuation\"\u003e@Autowired\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eAcceptRepository\u003c/span\u003e acceptRepository\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token annotation punctuation\"\u003e@Autowired\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eItemRepository\u003c/span\u003e itemRepository\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token annotation punctuation\"\u003e@Autowired\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eStockRepository\u003c/span\u003e stockRepository\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token annotation punctuation\"\u003e@Override\u003c/span\u003e\n    \u003cspan class=\"token annotation punctuation\"\u003e@Transactional\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n            propagation \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token class-name\"\u003ePropagation\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003eREQUIRED\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            isolation \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eIsolation\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003eDEFAULT\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            timeout \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e10\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            readOnly \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"token function\"\u003ecreateAccept\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eAcceptController\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eRegistAcceptModel\u003c/span\u003e model\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethrows\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eException\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// ドメインモデルの作成\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003eAccept\u003c/span\u003e accept \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eAccept\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003emodel\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eitemId\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e model\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecustomerName\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e model\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecount\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// 受注の登録をする\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// わかりやすくロールバックを確認するためここで永続化します\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eacceptRepository\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eregister\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eaccept\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"token comment\"\u003e// 在庫の取得\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003eStock\u003c/span\u003e stock \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003estockRepository\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efindStockByItemId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eaccept\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetItemId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"token comment\"\u003e// 在庫を減らす(本当の業務なら実在庫を減らすことはせず予定在庫を減らすなど)\u003c/span\u003e\n        stock\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esubCount\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eaccept\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetCount\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// 在庫の整合性を確認する\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estock\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eisMinus\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e// 適当な例外投げてます\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003ethrow\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eRuntimeException\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// 在庫の更新をする\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003estockRepository\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esave\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estock\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cul\u003e\n\u003cli\u003eアノテーションを利用したトランザクションの場合はコードがスッキリします\u003c/li\u003e\n\u003cli\u003e定義情報は@Transactionalアノテーションに付与できます\u003c/li\u003e\n\u003cli\u003ethrow new Exception();のように例外を起こした場合はロールバックされません。\n\u003cul\u003e\n\u003cli\u003eRuntimeException、およびそのサブクラスならロールバックされます\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003eその他\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eNo EntityManager with actual transaction available for current thread – cannot reliably process ‘persist’ call\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eトランザクションが開始されていない場合に起こりますので、トランザクションを開始する必要があります。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eメモ程度ですが、伝搬属性PROPAGATION_REQUIRES_NEWと.PROPAGATION_NESTEDのコード上の違いについて\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003egetTransactionを呼出したときに、おそらくここに流れる\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003eisExistingTransaction\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etransaction\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token comment\"\u003e// Existing transaction found -\u003e check propagation behavior to find out how to behave.\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token function\"\u003ehandleExistingTransaction\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edef\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e transaction\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e debugEnabled\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eこのhandleExistingTransactionメソッドで処理の振り分けをしている\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edefinition\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetPropagationBehavior\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eTransactionDefinition\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003ePROPAGATION_REQUIRES_NEW\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edebugEnabled\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\tlogger\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003edebug\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Suspending current transaction, creating new transaction with name [\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\n\t\t\t\tdefinition\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetName\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"]\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"token class-name\"\u003eSuspendedResourcesHolder\u003c/span\u003e suspendedResources \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003esuspend\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etransaction\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003etry\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token function\"\u003estartTransaction\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edefinition\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e transaction\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e debugEnabled\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e suspendedResources\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003ecatch\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eRuntimeException\u003c/span\u003e \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eError\u003c/span\u003e beginEx\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token function\"\u003eresumeAfterBeginException\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etransaction\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e suspendedResources\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e beginEx\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003ethrow\u003c/span\u003e beginEx\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edefinition\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetPropagationBehavior\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eTransactionDefinition\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003ePROPAGATION_NESTED\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e!\u003c/span\u003e\u003cspan class=\"token function\"\u003eisNestedTransactionAllowed\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003ethrow\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eNestedTransactionNotSupportedException\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token string\"\u003e\"Transaction manager does not allow nested transactions by default - \"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token string\"\u003e\"specify 'nestedTransactionAllowed' property with value 'true'\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edebugEnabled\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\tlogger\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003edebug\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Creating nested transaction with name [\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e definition\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetName\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"]\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003euseSavepointForNestedTransaction\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token comment\"\u003e// Create savepoint within existing Spring-managed transaction,\u003c/span\u003e\n\t\t\u003cspan class=\"token comment\"\u003e// through the SavepointManager API implemented by TransactionStatus.\u003c/span\u003e\n\t\t\u003cspan class=\"token comment\"\u003e// Usually uses JDBC 3.0 savepoints. Never activates Spring synchronization.\u003c/span\u003e\n\t\t\u003cspan class=\"token class-name\"\u003eDefaultTransactionStatus\u003c/span\u003e status \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token function\"\u003eprepareTransactionStatus\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edefinition\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e transaction\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e debugEnabled\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\tstatus\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ecreateAndHoldSavepoint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e status\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token comment\"\u003e// Nested transaction through nested begin and commit/rollback calls.\u003c/span\u003e\n\t\t\u003cspan class=\"token comment\"\u003e// Usually only for JTA: Spring synchronization might get activated here\u003c/span\u003e\n\t\t\u003cspan class=\"token comment\"\u003e// in case of a pre-existing JTA transaction.\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token function\"\u003estartTransaction\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edefinition\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e transaction\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e debugEnabled\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2\u003e参考\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e［改訂新版］Spring入門 ――Javaフレームワーク・より良い設計とアーキテクチャ\n\u003cul\u003e\n\u003cli\u003eこの本、すごく気に入ってます。と、ミサカは遠回しにオススメします。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e","slug":"p2420"},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"p2420"},"buildId":"AkuQOCUS04X5_x3YaJhBO","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>