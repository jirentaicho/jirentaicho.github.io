<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@site"/><meta name="twitter:creator" content="@keisukesiratori"/><meta property="og:site_name" content="Edelstein"/><title>SpringBootとPostgreのアプリケーションをKubernetesにデプロイ | Secrets</title><meta name="robots" content="index,follow"/><meta name="description" content="SpringBootとPostgreのアプリケーションをKubernetesにデプロイ | Secrets"/><meta property="og:title" content="SpringBootとPostgreのアプリケーションをKubernetesにデプロイ | Secrets"/><meta property="og:description" content="SpringBootとPostgreのアプリケーションをKubernetesにデプロイ | Secrets"/><meta property="og:url" content="http:localhost:3000/posts/p3306"/><meta property="og:type" content="website"/><meta property="og:image" content="https://locahost:3000/undefined"/><meta property="og:image:alt" content="SpringBootとPostgreのアプリケーションをKubernetesにデプロイ | Secrets"/><meta property="og:image:width" content="1200"/><meta property="og:image:height" content="700"/><meta name="next-head-count" content="17"/><link rel="preload" href="/_next/static/css/df6bb53438996960.css" as="style"/><link rel="stylesheet" href="/_next/static/css/df6bb53438996960.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-8fa1640cc84ba8fe.js" defer=""></script><script src="/_next/static/chunks/framework-7751730b10fa0f74.js" defer=""></script><script src="/_next/static/chunks/main-480c748fb908b436.js" defer=""></script><script src="/_next/static/chunks/pages/_app-5a840d570c522cf0.js" defer=""></script><script src="/_next/static/chunks/7-a9ae6bf2d6049209.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-31ed6b5e8c78747a.js" defer=""></script><script src="/_next/static/hnqBLK_Hn_sJaGDbWgeJa/_buildManifest.js" defer=""></script><script src="/_next/static/hnqBLK_Hn_sJaGDbWgeJa/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="flex flex-col min-h-screen bg-zinc-800"><header class="sticky top-0 border-b border-zinc-400 z-10 bg-zinc-900 text-slate-400"><div class="max-w-4xl mx-auto flex justify-between items-center h-12"><a href="/">Home</a><a target="_blank" href="https://github.com/jirentaicho">Github</a><a target="_blank" href="https://zenn.dev/misaka">Zenn</a></div></header><main class="flex-1 max-w-4xl w-full mx-auto"><div class="prose prose-lg max-w-none text-emerald-400"><h1 class="mt-12">SpringBootとPostgreのアプリケーションをKubernetesにデプロイ | Secrets</h1><span>2022.08.09</span><div class="space-x-2"><span><a class="text-emerald-300" href="/categories/Kubernetes/">Kubernetes</a></span></div></div></main><footer class="bg-zinc-900 text-slate-400"><div class="max-w-4xl w-full mx-auto h-24 flex items-center justify-center"><div>© volkruss.com / Edelstein</div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"frontMatter":{"title":"SpringBootとPostgreのアプリケーションをKubernetesにデプロイ | Secrets","date":"2022.08.09","description":"SpringBootとPostgreのアプリケーションをKubernetesにデプロイ | Secrets","categories":["Kubernetes"]},"content":"\u003cp\u003eこの記事のSecrets部分の内容は「現場至上主義 Spring Boot2 徹底活用」を参考に実施しています。\u003c/p\u003e\n\u003cp\u003e前回の続きで、今回はデータベースのアクセス情報の記載を、Secrets利用して設定します。Secretsに関しては過去記事でも実践済なので復習の意味も込めてやっていきます。\u003c/p\u003e\n\u003cp\u003eあくまで勉強目的であり、ベストプラクティスではないので注意してください。\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"/posts/p3270\"\u003eリンク\u003c/a\u003e\u003c/p\u003e\n\u003ch2\u003e準備\u003c/h2\u003e\n\u003cp\u003eデータベースに接続するアプリケーションを作るのですが、環境変数から読み取るように予め定義しておきます。\u003c/p\u003e\n\u003cp\u003eここで${}になっている部分が環境変数を参照するようになっています\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-html\"\u003e\u003ccode class=\"language-html\"\u003espring:\n  datasource:\n    driver-class-name: org.postgresql.Driver\n    url: jdbc:postgresql://${POSTGRE_DB_HOST}:${POSTGRE_DB_PORT}/misaka\n    username: ${POSTGRE_DB_USER}\n    password: ${POSTGRE_DB_PASSWORD}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e今回はPostgreを用意してSpringApplicationからの接続を行います。\u003c/p\u003e\n\u003ch2\u003ePostgre環境の作成と接続\u003c/h2\u003e\n\u003cp\u003e以下の順序で作成します\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eSecretsの作成\n\u003cul\u003e\n\u003cli\u003eユーザー名とパスワードをエンコードした状態で登録する\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eConfigMapの作成\n\u003cul\u003e\n\u003cli\u003ePostgre環境のホスト名を登録します\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003ePostgreのdeployment\n\u003cul\u003e\n\u003cli\u003ePostgreのコンテナを作成します\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eServiceの作成\n\u003cul\u003e\n\u003cli\u003ePostgreのホスト名を設定します\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eSpringのdeployment\n\u003cul\u003e\n\u003cli\u003eDB接続に必要となる環境変数の定義など行います\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4\u003eSecrets\u003c/h4\u003e\n\u003cp\u003eユーザー名とパスワードを暗号化して設定したいので、以下のコマンドでbase64でエンコードした値が取得できます。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003e└─$ echo -n \u0026#x26;quot;misaka\u0026#x26;quot; | base64              \r\r\nbWlzYWth\r\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003cimg src=\"/3306/1.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003e上記の値を利用してyamlファイルを作成します\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-html\"\u003e\u003ccode class=\"language-html\"\u003eapiVersion: v1\nkind: Secret\nmetadata:\n  name: postgre-secrets\ntype: Opaque\ndata:\n  user: bWlzYWth\n  password: bWlrb3Rv\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cul\u003e\n\u003cli\u003euserとpasswordを設定\n\u003cul\u003e\n\u003cli\u003emisaka/mikoto\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e以下のコマンドで登録します\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003ekubectl apply -f /home/misaka/デスクトップ/jar/postgre-secrets.yaml                                                    \r\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003cimg src=\"/3306/2.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003ch4\u003eConfigMapの作成\u003c/h4\u003e\n\u003cp\u003epostgreのホスト名はConfigMapに記載するようにします。前回作成したConfigMapのyamlを以下のように修正します\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-html\"\u003e\u003ccode class=\"language-html\"\u003eapiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: sample-config\ndata:\n  spring.profiles.active: default\n  postgre.db.host: 10.103.127.228\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cul\u003e\n\u003cli\u003epostgre.db.host\n\u003cul\u003e\n\u003cli\u003eここはServiceを設定後に再設定します\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eいったん設定をapplyで登録しておきます。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/3306/3.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003ch2\u003ePostgreのdeploymentの作成\u003c/h2\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-html\"\u003e\u003ccode class=\"language-html\"\u003eapiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: postgre-sample\nspec:\n  selector:\n    matchLabels:\n      app: postgre-sample\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        app: postgre-sample\n    spec:\n      containers:\n      - name: postgre-sample\n        image: postgres:14\n        env:\n        - name: POSTGRE_DB_HOST\n          valueFrom:\n            configMapKeyRef:\n              name: sample-config\n              key: postgre.db.host\n        - name: POSTGRES_USER\n          valueFrom:\n            secretKeyRef:\n              name: postgre-secrets\n              key: user\n        - name: POSTGRES_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              name: postgre-secrets\n              key: password\n        ports:\n        - containerPort: 5432\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cul\u003e\n\u003cli\u003ehost\n\u003cul\u003e\n\u003cli\u003econfigmapから取得\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003euserとpassword\n\u003cul\u003e\n\u003cli\u003esecretsから取得\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eまたエラーを起こして気づいたのですが、POSTGRES_PASSWORDという環境変数名のkeyにパスワードを登録しておく必要があります\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eServiceの作成\u003c/h2\u003e\n\u003cp\u003epostgre用のサービスを作成します\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-html\"\u003e\u003ccode class=\"language-html\"\u003eapiVersion: v1\nkind: Service\nmetadata:\n  name: postgre-service\nspec:\n  selector:\n    app: postgre-sample\n  ports:\n  - port: 5432\n    targetPort: 5432\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003cimg src=\"/3306/4.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003e先ほどのConfigMapのpostgre.db.hostにここのクラスターIPを設定して再度登録しておきます\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/3306/5.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003ch2\u003eSpringのdeploymentの修正\u003c/h2\u003e\n\u003cp\u003eenvのvalueは外部に設定していますが、postgreのポート番号だけはここに直接記載しています。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-html\"\u003e\u003ccode class=\"language-html\"\u003eapiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: sample\nspec:\n  selector:\n    matchLabels:\n      app: sample\n  replicas: 2\n  template:\n    metadata:\n      labels:\n        app: sample\n    spec:\n      containers:\n      - name: sample\n        image: sample\n        imagePullPolicy: Never\n        env:\n        - name: SPRING_PROFILES_ACTIVE\n          valueFrom:\n            configMapKeyRef:\n              name: sample-config\n              key: spring.profiles.active\n        - name: POSTGRE_DB_HOST\n          valueFrom:\n            configMapKeyRef:\n              name: sample-config\n              key: postgre.db.host\n        - name: POSTGRE_DB_USER\n          valueFrom:\n            secretKeyRef:\n              name: postgre-secrets\n              key: user\n        - name: POSTGRE_DB_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              name: postgre-secrets\n              key: password\n        - name: POSTGRE_DB_PORT\n          value: !!integer 5432\n        ports:\n        - containerPort: 8080\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cul\u003e\n\u003cli\u003e必要な環境変数を定義します\n\u003cul\u003e\n\u003cli\u003eホスト名はConfigMapから\u003c/li\u003e\n\u003cli\u003eパスワードとユーザー名はSecretsから\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e環境変数のkey名はSpringBootアプリケーション側yamlで${}に定義するkey名と同じもの\u003c/li\u003e\n\u003cli\u003e!!integerで数値を文字列として表現できます\n\u003cul\u003e\n\u003cli\u003e数値のままだとエラーになります\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eこれもapplyして登録し直します。\u003c/p\u003e\n\u003cp\u003eこれでブラウザにアクセスするとアプリケーションが問題なく動作している(DBに接続できている）ことがわかります\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/3306/6.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003ch3\u003eDB接続エラー\u003c/h3\u003e\n\u003cp\u003evirtualboxが重くてタイプミスがあったりでホスト名とかポートとかの打ち間違えがありました。うまくデータベースに接続できないとお決まりのエラーになります\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/3306/7.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003ePodにエラーがあるかどうかはget podしてSTATUSで確認できます\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/3306/8.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003e詳細ログの出し方はlogs pod名で取得できます(後述)\u003c/p\u003e\n\u003ch2\u003eその他\u003c/h2\u003e\n\u003ch4\u003eCrashLoopBackOff\u003c/h4\u003e\n\u003cp\u003eログを見ると速いです\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003e└─$ sudo kubectl get pod                                                                                                                       1 ⨯\r\r\nNAME                              READY   STATUS             RESTARTS      AGE\r\r\npostgre-sample-86f58c6b45-7n4rs   0/1     CrashLoopBackOff   6 (15s ago)   6m9s\r\r\n\r\n└─$ sudo kubectl logs postgre-sample-86f58c6b45-7n4rs                                                                                          1 ⨯\r\r\nError: Database is uninitialized and superuser password is not specified.\r\r\n       You must specify POSTGRES_PASSWORD to a non-empty value for the\r\r\n       superuser. For example, \u0026#x26;quot;-e POSTGRES_PASSWORD=password\u0026#x26;quot; on \u0026#x26;quot;docker run\u0026#x26;quot;.\r\r\n\r\r\n       You may also use \u0026#x26;quot;POSTGRES_HOST_AUTH_METHOD=trust\u0026#x26;quot; to allow all\r\r\n       connections without a password. This is *not* recommended.\r\r\n\r\r\n       See PostgreSQL documentation about \u0026#x26;quot;trust\u0026#x26;quot;:\r\r\n       https://www.postgresql.org/docs/current/auth-trust.html\r\r\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cul\u003e\n\u003cli\u003eこの場合は環境変数のPOSTGRES_PASSWORDを設定すれば解決します\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eexec\u003c/h2\u003e\n\u003cp\u003epod名からコンテナに入る\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003e└─$ sudo kubectl exec -it postgre-sample-c4669875c-8w6s5 /bin/bash\r\r\nkubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.\r\r\nroot@postgre-sample-c4669875c-8w6s5:/# \r\n\r\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch3\u003eデータベース\u003c/h3\u003e\n\u003cp\u003e今回はPOSTGRES_USERとPOSTGRES_PASSWORDをmisaka/mikotoで作成しているので、misakaというデータベースが作成されています\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/3306/9.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003ch3\u003eアプリケーションの依存モジュール\u003c/h3\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-html\"\u003e\u003ccode class=\"language-html\"\u003edependencies {\n\timplementation 'org.springframework.boot:spring-boot-starter-web'\n\tcompileOnly 'org.projectlombok:lombok'\n\truntimeOnly 'org.postgresql:postgresql'\n\timplementation 'org.springframework.boot:spring-boot-starter-data-jdbc'\n\tannotationProcessor 'org.projectlombok:lombok'\n\ttestImplementation 'org.springframework.boot:spring-boot-starter-test'\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2\u003e参考サイト\u003c/h2\u003e\n\u003cp\u003ehttps://qiita.com/higakin/items/f94b30686aabd0186d48\u003c/p\u003e","slug":"p3306"},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"p3306"},"buildId":"hnqBLK_Hn_sJaGDbWgeJa","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>