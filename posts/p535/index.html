<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@site"/><meta name="twitter:creator" content="@keisukesiratori"/><meta property="og:site_name" content="Edelstein"/><title>Springbootで排他制御を読む</title><meta name="robots" content="index,follow"/><meta name="description" content="Springbootで排他制御を読む"/><meta property="og:title" content="Springbootで排他制御を読む"/><meta property="og:description" content="Springbootで排他制御を読む"/><meta property="og:url" content="http:localhost:3000/posts/p535"/><meta property="og:type" content="website"/><meta property="og:image" content="https://locahost:3000/undefined"/><meta property="og:image:alt" content="Springbootで排他制御を読む"/><meta property="og:image:width" content="1200"/><meta property="og:image:height" content="700"/><meta name="next-head-count" content="17"/><link rel="preload" href="/_next/static/css/df6bb53438996960.css" as="style"/><link rel="stylesheet" href="/_next/static/css/df6bb53438996960.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-8fa1640cc84ba8fe.js" defer=""></script><script src="/_next/static/chunks/framework-7751730b10fa0f74.js" defer=""></script><script src="/_next/static/chunks/main-480c748fb908b436.js" defer=""></script><script src="/_next/static/chunks/pages/_app-5a840d570c522cf0.js" defer=""></script><script src="/_next/static/chunks/7-a9ae6bf2d6049209.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-31ed6b5e8c78747a.js" defer=""></script><script src="/_next/static/weL_0RqgC4WyoEVTiFXky/_buildManifest.js" defer=""></script><script src="/_next/static/weL_0RqgC4WyoEVTiFXky/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="flex flex-col min-h-screen bg-zinc-800"><header class="sticky top-0 border-b border-zinc-400 z-10 bg-zinc-900 text-slate-400"><div class="max-w-4xl mx-auto flex justify-between items-center h-12"><a href="/">Home</a><a target="_blank" href="https://github.com/jirentaicho">Github</a><a target="_blank" href="https://zenn.dev/misaka">Zenn</a></div></header><main class="flex-1 max-w-4xl w-full mx-auto"><div class="prose prose-lg max-w-none text-emerald-400"><h1 class="mt-12">Springbootで排他制御を読む</h1><span>2021.12.09</span><div class="space-x-2"><span><a class="text-emerald-300" href="/categories/Spring/">Spring</a></span></div></div></main><footer class="bg-zinc-900 text-slate-400"><div class="max-w-4xl w-full mx-auto h-24 flex items-center justify-center"><div>© volkruss.com / Edelstein</div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"frontMatter":{"title":"Springbootで排他制御を読む","date":"2021.12.09","description":"Springbootで排他制御を読む","categories":["Spring"]},"content":"\u003cp\u003e参考書籍のリーディングになります。\u003c/p\u003e\n\u003cp\u003e参考：https://github.com/miyabayt/spring-boot-doma2-sample\u003c/p\u003e\n\u003cp\u003e今回の内容は検証を行っていません。参照書を読んでメモを残しています。\u003c/p\u003e\n\u003ch2\u003e楽観的排他制御\u003c/h2\u003e\n\u003cp\u003e参考書籍で言ってる内容が全く理解できなかったです。。。\u003c/p\u003e\n\u003cp\u003eUserクラスの親クラスであるDomaDtoImplクラスでは、@Versionアノテーションを持ったフィールドがありますので、取得時にバージョン番号フィールドも取得します。\u003c/p\u003e\n\u003cp\u003eここまでいいのですがこの後\u003c/p\u003e\n\u003cp\u003e「データ更新処理時にバージョン番号をセットしたエンティティをメソッドの引数に渡すだけで、更新されたデータの件数が０件である場合は排他エラー」\u003c/p\u003e\n\u003cp\u003eのようにあるのですが、そんなことしてる？データ更新処理っていうのは\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token annotation punctuation\"\u003e@PostMapping\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"/edit/{userId}\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e \u003cspan class=\"token function\"\u003eeditUser\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token annotation punctuation\"\u003e@Validated\u003c/span\u003e \u003cspan class=\"token annotation punctuation\"\u003e@ModelAttribute\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"userForm\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eUserForm\u003c/span\u003e form\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eBindingResult\u003c/span\u003e br\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token annotation punctuation\"\u003e@PathVariable\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eLong\u003c/span\u003e userId\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eSessionStatus\u003c/span\u003e sessionStatus\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eRedirectAttributes\u003c/span\u003e attributes\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eだと思うのですが、エンティティって渡してますか？\u003c/p\u003e\n\u003cp\u003eそしてここを読む\u003c/p\u003e\n\u003cp\u003eそして理解した。あ、更新処理ってここかと\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token comment\"\u003e// 1件更新\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eint\u003c/span\u003e updated \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e userDao\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eupdate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003einputUser\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eコントローラーのソースを見せていたので、てっきり更新処理ってコントローラーの更新処理だと思っていました。(aho)\u003c/p\u003e\n\u003cp\u003eこの時にversionを持ったエンティティを渡すと自動的にdomaで楽観的排他を行ってくれるそうです。\u003c/p\u003e\n\u003cp\u003eちなみにversionをどうやって取得するかというと@SessionAttributesを使うそうです。\u003c/p\u003e\n\u003cp\u003eUserFormが継承しているBaseFormクラスは以下のように改定番号を持っています @SessionAttributesを使うことで指定した（今回であればUserFormクラス）はセッションとして情報が保持されます。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token comment\"\u003e// 改定番号\u003c/span\u003e\n\u003cspan class=\"token class-name\"\u003eInteger\u003c/span\u003e version\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e編集画面の初期表示処理で以下のように取得したDtoをFormに詰め込んでいるのですが、ここでversionがformに渡されて編集処理を行うまでこのversion情報をセッションにて管理できる。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token comment\"\u003e// セッションから取得できる場合は、読み込み直さない\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e!\u003c/span\u003e\u003cspan class=\"token function\"\u003ehasErrors\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003emodel\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n   \u003cspan class=\"token comment\"\u003e// 1件取得する\u003c/span\u003e\n    val user \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e userService\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efindById\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003euserId\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e// 取得したDtoをFromに詰め替える\u003c/span\u003e\n    modelMapper\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003emap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003euser\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e form\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e実際の更新処理ではformの値をDtoに書き換えを行う\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token comment\"\u003e// 更新対象を取得する\u003c/span\u003e\nval user \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e userService\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efindById\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003euserId\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// 入力値を詰め替える\u003c/span\u003e\nmodelMapper\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003emap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eform\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e user\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eこれで編集画面を表示した時に取得したversion番号を、更新処理で利用するdtoに設定できます。\u003c/p\u003e\n\u003cp\u003e参考サイトのDaoインターフェースを見ると@Updateのようなアノテーションがあり、引数の@Entityを持つクラスに紐づくテーブルを更新できるのでしょうね。参考\u003c/p\u003e\n\u003cp\u003ejpaではインターフェースを継承したインターフェースを生成すればある程度のメソッドが利用できましたが、ジェネリックなDaoクラスを作ればもっと便利に使えそう？と思いました。\u003c/p\u003e\n\u003cp\u003eここまでフレームワークがやってくれると便利ですがなんか不安になりますね。。。\u003c/p\u003e\n\u003ch2\u003e悲観的排他制御\u003c/h2\u003e\n\u003cp\u003e行ロックを使う方法。行ロックとは、行ロックだそうです。\u003c/p\u003e\n\u003cp\u003eただ、こちらは物凄く簡単で例えば修正する前の検索処理にて、forUpdte()メソッドを利用してレコードを取得するだけで、行にロックがかかるそうです\u003c/p\u003e\n\u003cp\u003e※ただし取得できるレコードがない場合は、テーブルロックになってしまうので要注意。これは実装はなくドキュメントとして存在しています。\u003c/p\u003e\n\u003cp\u003eデータベース初心者で申し訳ない。select for updateというのがあるんですね。\u003c/p\u003e\n\u003cp\u003eちなみにJPAでも同じように手軽に利用できるようです。\u003c/p\u003e\n\u003ch2\u003eselect for update\u003c/h2\u003e\n\u003cp\u003eせっかく出てきたので少し調べてみます。\u003c/p\u003e\n\u003cp\u003ePostgreで行った例が出てきたので真似してやってみます。（参考サイトはwhereが間違っているので実行時は注意してください)\u003c/p\u003e\n\u003cp\u003eコマンドラインから入るには以下のコマンド\u003c/p\u003e\n\u003cp\u003eトランザクションを再確認しつつ見ていきます。ログを載せます。昔は金融系の現場でSQL流す際によくやっていたのですが、忘れつつあります。てか忘れてます。\u003c/p\u003e\n\u003cp\u003eトランザクションを開始するにはBEGINを使ってCOMMITで終了します。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-sql\"\u003e\u003ccode class=\"language-sql\"\u003emisaka\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token comment\"\u003e# select * from lockman;\u003c/span\u003e\n id \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e     name\n\u003cspan class=\"token comment\"\u003e----+--------------\u003c/span\u003e\n  \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e 澁谷かのん\n  \u003cspan class=\"token number\"\u003e2\u003c/span\u003e \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e 唐可可\n  \u003cspan class=\"token number\"\u003e3\u003c/span\u003e \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e 平安名すみれ\n  \u003cspan class=\"token number\"\u003e4\u003c/span\u003e \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e 嵐千砂都\n  \u003cspan class=\"token number\"\u003e5\u003c/span\u003e \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e 葉月恋\n\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e5\u003c/span\u003e \u003cspan class=\"token keyword\"\u003erows\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\nmisaka\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token comment\"\u003e# commit;\u003c/span\u003e\nWARNING:  there \u003cspan class=\"token operator\"\u003eis\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eno\u003c/span\u003e \u003cspan class=\"token keyword\"\u003etransaction\u003c/span\u003e \u003cspan class=\"token operator\"\u003ein\u003c/span\u003e progress\n\u003cspan class=\"token keyword\"\u003eCOMMIT\u003c/span\u003e\nmisaka\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token comment\"\u003e# begin\u003c/span\u003e\nmisaka\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token comment\"\u003e# ;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eBEGIN\u003c/span\u003e\nmisaka\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003e\u003cspan class=\"token comment\"\u003e#\u003c/span\u003e\nmisaka\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003e\u003cspan class=\"token comment\"\u003e# commit;l\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eCOMMIT\u003c/span\u003e\nmisaka\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token comment\"\u003e#\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e基本操作はわかったので早速forupdateを利用してみます。idが4のレコードをfor updateで取得してみました。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-sql\"\u003e\u003ccode class=\"language-sql\"\u003emisaka\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token comment\"\u003e# begin;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eBEGIN\u003c/span\u003e\nmisaka\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003e\u003cspan class=\"token comment\"\u003e# select * from lockman where id = '4' for update;\u003c/span\u003e\n id \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e   name\n\u003cspan class=\"token comment\"\u003e----+----------\u003c/span\u003e\n  \u003cspan class=\"token number\"\u003e4\u003c/span\u003e \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e 嵐千砂都\n\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token keyword\"\u003erow\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eもう一つのコマンドラインから同じレコードを取得してみます。なんと処理が止まっています。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/535/1.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003eちゃんとロックされていますね。commitしてみると結果が表示されました。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/535/2.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003eちなみにfor updateを利用しない場合は結果を待たずにレコードが取得できます。\u003c/p\u003e\n\u003cp\u003e行ロックなので別の行は取得できます\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/535/3.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003e次にテーブルロックを試します。一方のトランザクションでテーブルをロックすると、もう一方のトランザクションではテーブルのレコードを何も取得できません。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/535/4.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003eコミットすると結果が取得されました。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/535/5.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003edomaで排他制御を行うときにレコードが取得できない場合はこの、lock tableがかかるということですね。\u003c/p\u003e","slug":"p535"},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"p535"},"buildId":"weL_0RqgC4WyoEVTiFXky","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>