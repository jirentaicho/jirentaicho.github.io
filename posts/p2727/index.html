<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@site"/><meta name="twitter:creator" content="@keisukesiratori"/><meta property="og:site_name" content="Edelstein"/><title>SpringSecurityの認証処理を行う流れ</title><meta name="robots" content="index,follow"/><meta name="description" content="SpringSecurityの認証処理を行う流れ"/><meta property="og:title" content="SpringSecurityの認証処理を行う流れ"/><meta property="og:description" content="SpringSecurityの認証処理を行う流れ"/><meta property="og:url" content="http:localhost:3000/posts/p2727"/><meta property="og:type" content="website"/><meta property="og:image" content="https://locahost:3000/undefined"/><meta property="og:image:alt" content="SpringSecurityの認証処理を行う流れ"/><meta property="og:image:width" content="1200"/><meta property="og:image:height" content="700"/><meta name="next-head-count" content="17"/><link rel="preload" href="/_next/static/css/df6bb53438996960.css" as="style"/><link rel="stylesheet" href="/_next/static/css/df6bb53438996960.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-8fa1640cc84ba8fe.js" defer=""></script><script src="/_next/static/chunks/framework-7751730b10fa0f74.js" defer=""></script><script src="/_next/static/chunks/main-480c748fb908b436.js" defer=""></script><script src="/_next/static/chunks/pages/_app-5a840d570c522cf0.js" defer=""></script><script src="/_next/static/chunks/7-a9ae6bf2d6049209.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-31ed6b5e8c78747a.js" defer=""></script><script src="/_next/static/zySuBojNZUu9-667yIcmf/_buildManifest.js" defer=""></script><script src="/_next/static/zySuBojNZUu9-667yIcmf/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="flex flex-col min-h-screen bg-zinc-800"><header class="sticky top-0 border-b border-zinc-400 z-10 bg-zinc-900 text-slate-400"><div class="max-w-4xl mx-auto flex justify-between items-center h-12"><a href="/">Home</a><a target="_blank" href="https://github.com/jirentaicho">Github</a><a target="_blank" href="https://zenn.dev/misaka">Zenn</a></div></header><main class="flex-1 max-w-4xl w-full mx-auto"><div class="prose prose-lg max-w-none text-emerald-400"><h1 class="mt-12">SpringSecurityの認証処理を行う流れ</h1><span>2022.06.03</span><div class="space-x-2"><span><a class="text-emerald-300" href="/categories/Spring/">Spring</a></span></div></div></main><footer class="bg-zinc-900 text-slate-400"><div class="max-w-4xl w-full mx-auto h-24 flex items-center justify-center"><div>© volkruss.com / Edelstein</div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"frontMatter":{"title":"SpringSecurityの認証処理を行う流れ","date":"2022.06.03","description":"SpringSecurityの認証処理を行う流れ","categories":["Spring"]},"content":"\u003cp\u003eこの記事ではSpringSecurityが認証処理を行う流れをざっくりと確認するのが目的です。\u003c/p\u003e\n\u003cp\u003eざっくり書くと認証処理は以下のように流れていきます\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eUsernamePasswordAuthenticationFilter#attemptAuthentication\u003c/li\u003e\n\u003cli\u003eAuthenticationManager(ProviderManager)#authenticate\u003c/li\u003e\n\u003cli\u003eDaoAuthenticationProvider(AbstractUserDetailsAuthenticationProvider)#authenticate\u003c/li\u003e\n\u003cli\u003eUserDetailsService(JdbcUserDetailsManager)#loadUserByUsername\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eまた流れを確認する上で前回の記事で作成したJDBC認証を使うようにしています。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token annotation punctuation\"\u003e@Bean\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eUserDetailsManager\u003c/span\u003e \u003cspan class=\"token function\"\u003euserDetailsService\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// 既存User : misaka/mikoto\u003c/span\u003e\n    \u003cspan class=\"token class-name\"\u003eJdbcUserDetailsManager\u003c/span\u003e users \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eJdbcUserDetailsManager\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edataSource\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e users\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2\u003eUsernamePasswordAuthenticationFilter\u003c/h2\u003e\n\u003cp\u003eフォーム画面でログインした場合にUsernamePasswordAuthenticationFilterが呼ばれます。\u003c/p\u003e\n\u003cp\u003eログインボタンを押して実際の認証処理が走る時には、一般的にはこのフィルターが利用されるということですね。\u003c/p\u003e\n\u003ch3\u003e実際の認証処理\u003c/h3\u003e\n\u003cp\u003eどういったことをしているのか見てみます\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token annotation punctuation\"\u003e@Override\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eAuthentication\u003c/span\u003e \u003cspan class=\"token function\"\u003eattemptAuthentication\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eHttpServletRequest\u003c/span\u003e request\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eHttpServletResponse\u003c/span\u003e response\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003ethrows\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eAuthenticationException\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epostOnly \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!\u003c/span\u003erequest\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetMethod\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eequals\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"POST\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003ethrow\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eAuthenticationServiceException\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Authentication method not supported: \"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e request\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetMethod\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e username \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eobtainUsername\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003erequest\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\tusername \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eusername \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e?\u003c/span\u003e username\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003etrim\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e password \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eobtainPassword\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003erequest\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\tpassword \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epassword \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e?\u003c/span\u003e password \u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token class-name\"\u003eUsernamePasswordAuthenticationToken\u003c/span\u003e authRequest \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eUsernamePasswordAuthenticationToken\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eunauthenticated\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eusername\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\tpassword\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token comment\"\u003e// Allow subclasses to set the \"details\" property\u003c/span\u003e\n\t\u003cspan class=\"token function\"\u003esetDetails\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003erequest\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e authRequest\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetAuthenticationManager\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eauthenticate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eauthRequest\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cul\u003e\n\u003cli\u003eリクエストの内容からusernameとpasswordを取得しています\u003c/li\u003e\n\u003cli\u003eUsernamePasswordAuthenticationTokenというものを作成して、AuthenticationManager#authenticateを呼出しているのがわかります\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eこの時利用されるAuthenticationManagerがProviderManagerというものであることがわかります\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/2727/1.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003eそもそもAuthenticationManagerというのはAuthenticationを返すauthenticateメソッドのみを持ったインターフェースです\u003c/p\u003e\n\u003cp\u003eつまり実際の認証処理というのはAuthenticationManagerが担当しているようです。引用文にもあるようにauthenticateメソッドの引数はAuthenticationで、戻り値もAuthenticationです。\u003c/p\u003e\n\u003cp\u003eUsernamePasswordAuthenticationFilterで作成したUsernamePasswordAuthenticationTokenというのは、Authenticationの実装クラスです\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/2727/2.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003emisaka/mikotoでログイン\u003c/li\u003e\n\u003cli\u003eまた認可の情報などは取得されていない\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eここまでを一旦整理すると\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eUsernamePasswordAuthenticationFilterがログインすると呼ばれる\u003c/li\u003e\n\u003cli\u003eAuthenticationManager#authenticateメソッドを呼び出す\u003c/li\u003e\n\u003cli\u003eAuthenticationManagerはProviderManagerという実装クラスが処理を行っている\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eAuthenticationManager\u003c/h2\u003e\n\u003cp\u003eUsernamePasswordAuthenticationFilterから呼ばれたAuthenticationManager#authenticateは、ProviderManagerという実装クラスが処理を行います。このauthenticateメソッドは以下のように説明されています\u003c/p\u003e\n\u003cp\u003eauthenticateメソッドの中では以下のようにprovider.authenticateを呼出して、戻り値であるAuthenticationを設定しています\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token annotation punctuation\"\u003e@Override\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eAuthentication\u003c/span\u003e \u003cspan class=\"token function\"\u003eauthenticate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eAuthentication\u003c/span\u003e authentication\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethrows\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eAuthenticationException\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token class-name\"\u003eClass\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token operator\"\u003e?\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eextends\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eAuthentication\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e toTest \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e authentication\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetClass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token class-name\"\u003eAuthenticationException\u003c/span\u003e lastException \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token class-name\"\u003eAuthenticationException\u003c/span\u003e parentException \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token class-name\"\u003eAuthentication\u003c/span\u003e result \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token class-name\"\u003eAuthentication\u003c/span\u003e parentResult \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eint\u003c/span\u003e currentPosition \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eint\u003c/span\u003e size \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eproviders\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esize\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eAuthenticationProvider\u003c/span\u003e provider \u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token function\"\u003egetProviders\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e!\u003c/span\u003eprovider\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esupports\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etoTest\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003econtinue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003elogger\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eisTraceEnabled\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\tlogger\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003etrace\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eLogMessage\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eformat\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Authenticating request with %s (%d/%d)\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\t\tprovider\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetClass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetSimpleName\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token operator\"\u003e++\u003c/span\u003ecurrentPosition\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e size\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003etry\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e result \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e provider\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eauthenticate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eauthentication\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eresult \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token function\"\u003ecopyDetails\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eauthentication\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e result\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token keyword\"\u003ebreak\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e省略\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cul\u003e\n\u003cli\u003e(1)がそのprovider.authenticate\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eこのproviderはDaoAuthenticationProviderというクラスであることがわかりますDaoAuthenticationProviderにはauthenticateメソッドは定義されておらず、基底クラスのAbstractUserDetailsAuthenticationProviderに処理が移ります\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/2727/3.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003eAbstractUserDetailsAuthenticationProvider#authenticateメソッドでは、UserDetailsを作成していることがわかります。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/2727/4.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003eUserDetailsというのはユーザー名やパスワード、そしてユーザーが有効かどうか(enabled)などの情報が格納されており、AuthenticationオブジェクトのgetPrincipalメソッドから取得可能です\u003c/p\u003e\n\u003cp\u003eここで呼出すretrieveUserは抽象メソッドになっているためDaoAuthenticationProviderがその実装を行っています\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token annotation punctuation\"\u003e@Override\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eprotected\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efinal\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eUserDetails\u003c/span\u003e \u003cspan class=\"token function\"\u003eretrieveUser\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e username\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eUsernamePasswordAuthenticationToken\u003c/span\u003e authentication\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003ethrows\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eAuthenticationException\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token function\"\u003eprepareTimingAttackProtection\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003etry\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token class-name\"\u003eUserDetails\u003c/span\u003e loadedUser \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetUserDetailsService\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eloadUserByUsername\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eusername\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eloadedUser \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003ethrow\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eInternalAuthenticationServiceException\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n\t\t\t\t\t\u003cspan class=\"token string\"\u003e\"UserDetailsService returned null, which is an interface contract violation\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e loadedUser\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e省略\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eUserDetailsServiceのloadUserByUsernameメソッドを呼び出しています。たまにDB認証する際にはUserDetailsServiceの実装クラスを作ってloadUserByUsernameメソッドをオーバーライドします。というのを見かけますが、やっているのはココですね。\u003c/p\u003e\n\u003cp\u003eUserDetailsServiceの実体が何者か確認してみると\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/2727/5.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003eBean登録したJdbcUserDetailsManagerです。\u003c/p\u003e\n\u003cp\u003eここまでを一旦整理すると\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eAuthenticationManager(ProviderManager)#authenticateが、DaoAuthenticationProvider#authenticateを呼出す\u003c/li\u003e\n\u003cli\u003e基底クラスのAbstractUserDetailsAuthenticationProvider#authenticateが呼ばれる\u003c/li\u003e\n\u003cli\u003e基底クラスから抽象メソッドretrieveUserを呼出してUserDetailsを作成する\u003c/li\u003e\n\u003cli\u003eDaoAuthenticationProviderがretrieveUserメソッドでUserDetailsServiceのloadUserByUsernameメソッドを呼出してUserDetailsを作成する\u003c/li\u003e\n\u003cli\u003eUserDetailsServiceの実装はBean登録したJdbcUserDetailsManagerです\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eUserDetailsService\u003c/h2\u003e\n\u003cp\u003eDaoAuthenticationProviderから、UserDetailsServiceのloadUserByUsernameが呼ばれてUserDetailsを取得しようとしていました。\u003c/p\u003e\n\u003cp\u003eそしてUserDetailsServiceの実体がBean登録したJdbcUserDetailsManagerでした。\u003c/p\u003e\n\u003cp\u003eJdbcUserDetailsManagerを見てみると、loadUserByUsernameメソッドは定義されておらず、基底クラスのJdbcDaoImplに定義があります\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token annotation punctuation\"\u003e@Override\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eUserDetails\u003c/span\u003e \u003cspan class=\"token function\"\u003eloadUserByUsername\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e username\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethrows\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eUsernameNotFoundException\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eList\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eUserDetails\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e users \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eloadUsersByUsername\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eusername\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eusers\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esize\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003elogger\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003edebug\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Query returned no results for user '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e username \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"'\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003ethrow\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eUsernameNotFoundException\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003emessages\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetMessage\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"JdbcDaoImpl.notFound\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eObject\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e username \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Username {0} not found\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"token class-name\"\u003eUserDetails\u003c/span\u003e user \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e users\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// contains no GrantedAuthority[]\u003c/span\u003e\n\t\u003cspan class=\"token class-name\"\u003eSet\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eGrantedAuthority\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e dbAuthsSet \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eHashSet\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eenableAuthorities\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e dbAuthsSet\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eaddAll\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003eloadUserAuthorities\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003euser\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetUsername\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eenableGroups\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\tdbAuthsSet\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eaddAll\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003eloadGroupAuthorities\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003euser\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetUsername\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"token class-name\"\u003eList\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eGrantedAuthority\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e dbAuths \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eArrayList\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edbAuthsSet\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token function\"\u003eaddCustomAuthorities\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003euser\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetUsername\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e dbAuths\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edbAuths\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esize\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003elogger\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003edebug\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"User '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e username \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"' has no authorities and will be treated as 'not found'\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003ethrow\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eUsernameNotFoundException\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003emessages\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetMessage\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"JdbcDaoImpl.noAuthority\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eObject\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e username \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"User {0} has no GrantedAuthority\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token function\"\u003ecreateUserDetails\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eusername\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e user\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e dbAuths\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cul\u003e\n\u003cli\u003e(1)でデータベースからレコードを取得しています\u003c/li\u003e\n\u003cli\u003e(2)でデータベースから認可を取得しています\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e(1)loadUsersByUsernameメソッド\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/2727/6.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003e(2)loadUserAuthoritiesメソッド\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/2727/7.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003e(3)最終的にはUserDetailsを作成して返します\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token keyword\"\u003eprotected\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eUserDetails\u003c/span\u003e \u003cspan class=\"token function\"\u003ecreateUserDetails\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e username\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eUserDetails\u003c/span\u003e userFromUserQuery\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\u003cspan class=\"token class-name\"\u003eList\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eGrantedAuthority\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e combinedAuthorities\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e returnUsername \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e userFromUserQuery\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetUsername\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e!\u003c/span\u003e\u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eusernameBasedPrimaryKey\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\treturnUsername \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e username\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eUser\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ereturnUsername\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e userFromUserQuery\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetPassword\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e userFromUserQuery\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eisEnabled\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\tuserFromUserQuery\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eisAccountNonExpired\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e userFromUserQuery\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eisCredentialsNonExpired\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\tuserFromUserQuery\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eisAccountNonLocked\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e combinedAuthorities\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cul\u003e\n\u003cli\u003eUserというのはUserDetailsの実装クラスです\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eこうやってデータベースからレコードを取得して認証ユーザーを取得しているんですね。\u003c/p\u003e\n\u003cp\u003eここまでを一旦整理すると\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eUserDetailsService(JdbcUserDetailsManager)のloadUserByUsernameメソッドは、基底クラスのJdbcDaoImplが実装しています\u003c/li\u003e\n\u003cli\u003eloadUserByUsernameメソッドで実際にSQLを発行してデータベースからレコードを取得している\u003c/li\u003e\n\u003cli\u003eまた認可などの情報もここでSQLを発行して取得している\u003c/li\u003e\n\u003cli\u003e最終的にUserDetailsを作成して返却する\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eこれでデータベースからレコードを取得しているのがわかりました。\u003c/p\u003e\n\u003cp\u003eしかしユーザー取得のSQLを見ると理解できないことが起きています。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efinal\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e \u003cspan class=\"token constant\"\u003eDEF_USERS_BY_USERNAME_QUERY\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"select username,password,enabled \"\u003c/span\u003e\n\t\t\t\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"from users \"\u003c/span\u003e\n\t\t\t\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"where username = ?\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eなんとパスワードのチェックをしていません\u003c/p\u003e\n\u003ch2\u003e認証情報のチェック\u003c/h2\u003e\n\u003cp\u003eAbstractUserDetailsAuthenticationProvider#authenticateメソッドは、辿っていくとUserDetailsSerivceからUserDetailsを取得していましたね\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/2727/8.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003eこのAbstractUserDetailsAuthenticationProvider#authenticateメソッドはAuthenticationManager(ProviderManager)のauthenticateメソッドから呼ばれていて、戻り値としてAuthenticationを返却しています。\u003c/p\u003e\n\u003cp\u003eここまでDBから取得したのはUserDetailsであるため、この後の処理でAuthenticationを返却することになります。このメソッドを見ると以下のようになっています\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token annotation punctuation\"\u003e@Override\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eAuthentication\u003c/span\u003e \u003cspan class=\"token function\"\u003eauthenticate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eAuthentication\u003c/span\u003e authentication\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethrows\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eAuthenticationException\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token class-name\"\u003eAssert\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eisInstanceOf\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eUsernamePasswordAuthenticationToken\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e authentication\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003emessages\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetMessage\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"AbstractUserDetailsAuthenticationProvider.onlySupports\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\t\t\u003cspan class=\"token string\"\u003e\"Only UsernamePasswordAuthenticationToken is supported\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e username \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003edetermineUsername\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eauthentication\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eboolean\u003c/span\u003e cacheWasUsed \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token class-name\"\u003eUserDetails\u003c/span\u003e user \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003euserCache\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetUserFromCache\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eusername\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003euser \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\tcacheWasUsed \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003etry\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e user \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eretrieveUser\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eusername\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eUsernamePasswordAuthenticationToken\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e authentication\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003ecatch\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eUsernameNotFoundException\u003c/span\u003e ex\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003elogger\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003edebug\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Failed to find user '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e username \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"'\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e!\u003c/span\u003e\u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ehideUserNotFoundExceptions\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token keyword\"\u003ethrow\u003c/span\u003e ex\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003ethrow\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eBadCredentialsException\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003emessages\n\t\t\t\t\t\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetMessage\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"AbstractUserDetailsAuthenticationProvider.badCredentials\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Bad credentials\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\u003cspan class=\"token class-name\"\u003eAssert\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003enotNull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003euser\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"retrieveUser returned null - a violation of the interface contract\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003etry\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epreAuthenticationChecks\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003echeck\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003euser\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token function\"\u003eadditionalAuthenticationChecks\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003euser\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eUsernamePasswordAuthenticationToken\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e authentication\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e省略\n\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token function\"\u003ecreateSuccessAuthentication\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eprincipalToReturn\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e authentication\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e user\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cul\u003e\n\u003cli\u003e(1)ではUserDetailsSerivceからUserDetailsを取得してきます\u003c/li\u003e\n\u003cli\u003e(2)でadditionalAuthenticationChecksということをしています\u003c/li\u003e\n\u003cli\u003e(3)で成功認証情報の作成をして返却しています\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e(1)については上述してきた処理です。\u003c/p\u003e\n\u003cp\u003e(2)のadditionalAuthenticationChecksは抽象メソッドになっていますので、継承先のクラスにて実装されているはずです。その実装はDaoAuthenticationProviderでしたね\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token annotation punctuation\"\u003e@Override\u003c/span\u003e\n\u003cspan class=\"token annotation punctuation\"\u003e@SuppressWarnings\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"deprecation\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eprotected\u003c/span\u003e \u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"token function\"\u003eadditionalAuthenticationChecks\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eUserDetails\u003c/span\u003e userDetails\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\u003cspan class=\"token class-name\"\u003eUsernamePasswordAuthenticationToken\u003c/span\u003e authentication\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethrows\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eAuthenticationException\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eauthentication\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetCredentials\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003elogger\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003edebug\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Failed to authenticate since no credentials provided\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003ethrow\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eBadCredentialsException\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003emessages\n\t\t\t\t\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetMessage\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"AbstractUserDetailsAuthenticationProvider.badCredentials\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Bad credentials\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e presentedPassword \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e authentication\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetCredentials\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003etoString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e!\u003c/span\u003e\u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epasswordEncoder\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ematches\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epresentedPassword\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e userDetails\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetPassword\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003elogger\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003edebug\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Failed to authenticate since password does not match stored value\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003ethrow\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eBadCredentialsException\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003emessages\n\t\t\t\t\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetMessage\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"AbstractUserDetailsAuthenticationProvider.badCredentials\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Bad credentials\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cul\u003e\n\u003cli\u003eここでパスワードの整合性をチェックしていることがわかります\u003c/li\u003e\n\u003cli\u003epresentedPasswordは入力時のパスワード\u003c/li\u003e\n\u003cli\u003euserDetails.getPassword()はDBから取得したUserDetailsのパスワード\u003c/li\u003e\n\u003cli\u003epresentedPasswordとuserDetails.getPassword()がマッチしていない場合はエラーになる\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e引数のauthenticationというのは、UsernamePasswordAuthenticationFilterのattemptAuthenticationメソッドで作成されたUsernamePasswordAuthenticationTokenでしたね\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token class-name\"\u003eUsernamePasswordAuthenticationToken\u003c/span\u003e authRequest \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eUsernamePasswordAuthenticationToken\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eunauthenticated\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eusername\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003epassword\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e(3)は抽象メソッドではないのですが、DaoAuthenticationProviderにてオーバーライドされています。オーバーライド先では最終的にsuperを呼び出しています\u003c/p\u003e\n\u003cp\u003e最終的には以下のような形のAuthenticationオブジェクトが返却されていました\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/2727/9.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003eここまでを一旦整理すると\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eAuthenticationManagerから呼ばれるAuthenticationProviderの実装クラスAbstractUserDetailsAuthenticationProviderがパスワードのチェックを行う\u003c/li\u003e\n\u003cli\u003eパスワードの整合性はadditionalAuthenticationChecksメソッドで行う\u003c/li\u003e\n\u003cli\u003e最終的にはAuthenticationオブジェクトを返却する\u003c/li\u003e\n\u003c/ul\u003e","slug":"p2727"},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"p2727"},"buildId":"zySuBojNZUu9-667yIcmf","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>