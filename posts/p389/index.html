<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@site"/><meta name="twitter:creator" content="@keisukesiratori"/><meta property="og:site_name" content="Edelstein"/><title>kubernetesの初心者トレーニング | サービス偏</title><meta name="robots" content="index,follow"/><meta name="description" content="kubernetesの初心者トレーニング | サービス偏"/><meta property="og:title" content="kubernetesの初心者トレーニング | サービス偏"/><meta property="og:description" content="kubernetesの初心者トレーニング | サービス偏"/><meta property="og:url" content="http:localhost:3000/posts/p389"/><meta property="og:type" content="website"/><meta property="og:image" content="https://locahost:3000/undefined"/><meta property="og:image:alt" content="kubernetesの初心者トレーニング | サービス偏"/><meta property="og:image:width" content="1200"/><meta property="og:image:height" content="700"/><meta name="next-head-count" content="17"/><link rel="preload" href="/_next/static/css/df6bb53438996960.css" as="style"/><link rel="stylesheet" href="/_next/static/css/df6bb53438996960.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-8fa1640cc84ba8fe.js" defer=""></script><script src="/_next/static/chunks/framework-7751730b10fa0f74.js" defer=""></script><script src="/_next/static/chunks/main-480c748fb908b436.js" defer=""></script><script src="/_next/static/chunks/pages/_app-5a840d570c522cf0.js" defer=""></script><script src="/_next/static/chunks/7-a9ae6bf2d6049209.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-31ed6b5e8c78747a.js" defer=""></script><script src="/_next/static/bXc5Sirceq9aybu69XHfq/_buildManifest.js" defer=""></script><script src="/_next/static/bXc5Sirceq9aybu69XHfq/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="flex flex-col min-h-screen bg-zinc-800"><header class="sticky top-0 border-b border-zinc-400 z-10 bg-zinc-900 text-slate-400"><div class="max-w-4xl mx-auto flex justify-between items-center h-12"><a href="/">Home</a><a target="_blank" href="https://github.com/jirentaicho">Github</a><a target="_blank" href="https://zenn.dev/misaka">Zenn</a></div></header><main class="flex-1 max-w-4xl w-full mx-auto"><div class="prose prose-lg max-w-none text-emerald-400"><h1 class="mt-12">kubernetesの初心者トレーニング | サービス偏</h1><span>2021.12.06</span><div class="space-x-2"><span><a class="text-emerald-300" href="/categories/Kubernetes/">Kubernetes</a></span></div></div></main><footer class="bg-zinc-900 text-slate-400"><div class="max-w-4xl w-full mx-auto h-24 flex items-center justify-center"><div>© volkruss.com / Edelstein</div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"frontMatter":{"title":"kubernetesの初心者トレーニング | サービス偏","date":"2021.12.06","description":"kubernetesの初心者トレーニング | サービス偏","categories":["Kubernetes"]},"content":"\u003cp\u003e参考\u003c/p\u003e\n\u003cp\u003ehttps://kubernetes.io/ja/docs/concepts/services-networking/connect-applications-service/\u003c/p\u003e\n\u003cp\u003e参考サイトの内容を参考にしてkubernetesのトレーニングします。\u003c/p\u003e\n\u003cp\u003e・今回の参考サイトではnginxサーバーを作成する。この時repicasを2として2つのPodが起動する。この時それぞれのPodがそれぞれのIPアドレスを保持している\u003c/p\u003e\n\u003cp\u003e・次にサービスを作成する。サービスではclusterIPアドレスが割り当てられ、このIPアドレスへ通信を行うことでPodに通信できます。そしてこの時にPodには自動的に負荷分散される（Podが２つあるので、アクセスがどっちかに分散される）\u003c/p\u003e\n\u003cp\u003e・次にbusyboxを利用してnslookupを行います。\u003c/p\u003e\n\u003cp\u003e・次に、少し省略してNodePortを利用して外部への公開を試みます。\u003c/p\u003e\n\u003cp\u003e・最後にロードバランサを利用します。\u003c/p\u003e\n\u003cp\u003eそれではやってみます\u003c/p\u003e\n\u003ch2\u003edeploymentの作成\u003c/h2\u003e\n\u003cp\u003e参考サイトの内容でyamlファイルを作成したら、デプロイします。\u003c/p\u003e\n\u003cp\u003eしばらくするとPodが作成されます。状況については以下のコマンドで確認できます\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003ekubectl get pod\r\nNAME                        READY   STATUS              RESTARTS   AGE\r\nmy-nginx-5b56ccd65f-nv2sx   0/1     ContainerCreating   0          2m29s\r\nmy-nginx-5b56ccd65f-xqkrm   0/1     ContainerCreating   0          2m29s\r\nkubectl describe pod my-nginx-5b56ccd65f-nv2sx\r\nName:           my-nginx-5b56ccd65f-nv2sx\r\nNamespace:      default\r\nPriority:       0\r\nNode:           docker-desktop/192.168.65.4\r\nStart Time:     Mon, 06 Dec 2021 15:38:54 +0900\r\nLabels:         pod-template-hash=5b56ccd65f\r\n                run=my-nginx\r\nAnnotations:    \u0026#x26;lt;none\u0026#x26;gt;\r\nStatus:         Pending\r\nIP:             \r\nIPs:            \u0026#x26;lt;none\u0026#x26;gt;\r\nControlled By:  ReplicaSet/my-nginx-5b56ccd65f\r\nContainers:\r\n  my-nginx:\r\n    Container ID:   \r\n    Image:          nginx\r\n    Image ID:       \r\n    Port:           80/TCP\r\n    Host Port:      0/TCP\r\n    State:          Waiting\r\n      Reason:       ContainerCreating\r\n    Ready:          False\r\n    Restart Count:  0\r\n    Environment:    \u0026#x26;lt;none\u0026#x26;gt;\r\n    Mounts:\r\n      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-62bfr (ro)\r\nConditions:\r\n  Type              Status\r\n  Initialized       True \r\n  Ready             False \r\n  ContainersReady   False \r\n  PodScheduled      True \r\nVolumes:\r\n  kube-api-access-62bfr:\r\n    Type:                    Projected (a volume that contains injected data from multiple sources)\r\n    TokenExpirationSeconds:  3607\r\n    ConfigMapName:           kube-root-ca.crt\r\n    ConfigMapOptional:       \u0026#x26;lt;nil\u0026#x26;gt;\r\n    DownwardAPI:             true\r\nQoS Class:                   BestEffort\r\nNode-Selectors:              \u0026#x26;lt;none\u0026#x26;gt;\r\nTolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s\r\n                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s\r\nEvents:\r\n  Type    Reason     Age    From               Message\r\n  ----    ------     ----   ----               -------\r\n  Normal  Scheduled  3m17s  default-scheduler  Successfully assigned default/my-nginx-5b56ccd65f-nv2sx to docker-desktop\r\n  Normal  Pulling    3m17s  kubelet            Pulling image \u0026#x26;quot;nginx\u0026#x26;quot;\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eimageのpullが長いです。\u003c/p\u003e\n\u003cp\u003ePod状態を確認します\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003ekubectl get pods\r\nNAME                        READY   STATUS    RESTARTS   AGE\r\nmy-nginx-5b56ccd65f-nv2sx   1/1     Running   0          99m\r\nmy-nginx-5b56ccd65f-xqkrm   1/1     Running   0          99m\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2\u003eserviceの作成\u003c/h2\u003e\n\u003cp\u003e参考サイトと同じ内容でyamlファイルを作成したらデプロイします\u003c/p\u003e\n\u003cp\u003eサービスの状態を確認する\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003ekubectl get service\r\nNAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE\r\nkubernetes   ClusterIP   10.96.0.1      \u0026#x26;lt;none\u0026#x26;gt;        443/TCP        17d\r\nmy-nginx     ClusterIP   10.98.160.64   \u0026#x26;lt;none\u0026#x26;gt;        80/TCP         78m\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003espec.selector属性にはServiceのターゲットとしたいPodが持つラベルを設定する。\u003c/p\u003e\n\u003ch2\u003ebusyboxでnslookupする\u003c/h2\u003e\n\u003cp\u003e以下のコマンドを入力します\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003ekubectl run curl --image=radial/busyboxplus:curl -i --tty\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eこれでbusyboxに入れます。これは一時的にクラスタ内にbusyboxを設けてサービスを経由してPodにアクセスできるか確認します。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003e root@curl:/ ]$ nslookup my-nginx\r\nServer:    10.96.0.10\r\nAddress 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local\r\n\r\nName:      my-nginx\r\nAddress 1: 10.98.160.64 my-nginx.default.svc.cluster.local\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003enslookupはドメイン名からIPアドレスを調べるコマンドです。\u003c/p\u003e\n\u003cp\u003ecurlコマンドも試してみます。clusterIPを指定してService→Podとアクセスできるか確認します\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003e[ root@curl:/ ]$ curl 10.98.160.64\r\n\u0026#x26;lt;!DOCTYPE html\u0026#x26;gt;\r\n\u0026#x26;lt;html\u0026#x26;gt;\r\n\u0026#x26;lt;head\u0026#x26;gt;\r\n\u0026#x26;lt;title\u0026#x26;gt;Welcome to nginx!\u0026#x26;lt;/title\u0026#x26;gt;\r\n\u0026#x26;lt;style\u0026#x26;gt;\r\nhtml { color-scheme: light dark; }\r\nbody { width: 35em; margin: 0 auto;\r\nfont-family: Tahoma, Verdana, Arial, sans-serif; }\r\n\u0026#x26;lt;/style\u0026#x26;gt;\r\n\u0026#x26;lt;/head\u0026#x26;gt;\r\n\u0026#x26;lt;body\u0026#x26;gt;\r\n\u0026#x26;lt;h1\u0026#x26;gt;Welcome to nginx!\u0026#x26;lt;/h1\u0026#x26;gt;\r\n\u0026#x26;lt;p\u0026#x26;gt;If you see this page, the nginx web server is successfully installed and\r\nworking. Further configuration is required.\u0026#x26;lt;/p\u0026#x26;gt;\r\n\r\n\u0026#x26;lt;p\u0026#x26;gt;For online documentation and support please refer to\r\n\u0026#x26;lt;a href=\u0026#x26;quot;http://nginx.org/\u0026#x26;quot;\u0026#x26;gt;nginx.org\u0026#x26;lt;/a\u0026#x26;gt;.\u0026#x26;lt;br/\u0026#x26;gt;\r\nCommercial support is available at\r\n\u0026#x26;lt;a href=\u0026#x26;quot;http://nginx.com/\u0026#x26;quot;\u0026#x26;gt;nginx.com\u0026#x26;lt;/a\u0026#x26;gt;.\u0026#x26;lt;/p\u0026#x26;gt;\r\n\r\n\u0026#x26;lt;p\u0026#x26;gt;\u0026#x26;lt;em\u0026#x26;gt;Thank you for using nginx.\u0026#x26;lt;/em\u0026#x26;gt;\u0026#x26;lt;/p\u0026#x26;gt;\r\n\u0026#x26;lt;/body\u0026#x26;gt;\r\n\u0026#x26;lt;/html\u0026#x26;gt;\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e現状Podが残っているので必要ならば消してください\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003ekubectl get pods\r\nNAME                        READY   STATUS    RESTARTS   AGE\r\ncurl                        1/1     Running   1          13m\r\nmy-nginx-5b56ccd65f-nv2sx   1/1     Running   0          114m\r\nmy-nginx-5b56ccd65f-xqkrm   1/1     Running   0          114m\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eもう一回入る\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003ekubectl exec -it curl -- sh\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e消す\u003c/p\u003e\n\u003ch2\u003eNodePortを利用する\u003c/h2\u003e\n\u003cp\u003e現状はclusterIPをブラウザで入力してもアクセスできません。もちろんターミナルからもcurlはできません。\u003c/p\u003e\n\u003cp\u003e先程はbusyboxがクラスタ内にありそこに入ってcurlを打ったのでアクセスできました。\u003c/p\u003e\n\u003cp\u003e今回は、ホストマシンからもアクセスできるようにします。\u003c/p\u003e\n\u003cp\u003e※安全という章を飛ばしています\u003c/p\u003e\n\u003cp\u003e一旦サービスを削除します\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003ekubectl delete -f run-my-nginx.yaml \r\ndeployment.apps \u0026#x26;quot;my-nginx\u0026#x26;quot; deleted\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eサービスの内容を参考サイトをもとに以下のように書き換えます。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003eapiVersion: v1\r\nkind: Service\r\nmetadata:\r\n  name: my-nginx\r\n  labels:\r\n    run: my-nginx\r\nspec:\r\n  type: NodePort\r\n  ports:\r\n  - port: 8080\r\n    targetPort: 80\r\n    protocol: TCP\r\n  selector:\r\n    run: my-nginx\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eサービスからNodePortを確認します。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003ekubectl get service\r\nNAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE\r\nkubernetes   ClusterIP   10.96.0.1      \u0026#x26;lt;none\u0026#x26;gt;        443/TCP          18d\r\nmy-nginx     NodePort    10.98.92.166   \u0026#x26;lt;none\u0026#x26;gt;        8080:30681/TCP   5m41s\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eこの場合はttp://localhost:30681/にアクセスするとnginxのページが表示されます。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/389/1.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003ch2\u003eロードバランサに変更する\u003c/h2\u003e\n\u003cp\u003e参考\u003c/p\u003e\n\u003cp\u003ehttps://kubernetes.io/ja/docs/tutorials/stateless-application/expose-external-ip-address/\u003c/p\u003e\n\u003cp\u003eserviceを一旦消してから以下のコマンドを打ちます\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003eexpose deployment my-nginx --type=LoadBalancer --name=my-service                                                \r\r\nservice/my-service exposed\r\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003ekubectl get services my-service                                         \r\r\nNAME         TYPE           CLUSTER-IP       EXTERNAL-IP     PORT(S)        AGE\r\r\nmy-service   LoadBalancer   10.109.169.165   192.168.49.51   80:31252/TCP   11s\r\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eEXTERNAL-IPに値が入っています。(自分のホスト端末で行うとlocalhostになっています。今回はminikubeで試しています。\u003c/p\u003e\n\u003cp\u003e192.168.49.51にアクセスします。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/389/2.png\" alt=\"画像\"\u003e\u003c/p\u003e","slug":"p389"},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"p389"},"buildId":"bXc5Sirceq9aybu69XHfq","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>