<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@site"/><meta name="twitter:creator" content="@keisukesiratori"/><meta property="og:site_name" content="Edelstein"/><title>Spring Security | JWTトークンの検証を行う</title><meta name="robots" content="index,follow"/><meta name="description" content="Spring Security | JWTトークンの検証を行う"/><meta property="og:title" content="Spring Security | JWTトークンの検証を行う"/><meta property="og:description" content="Spring Security | JWTトークンの検証を行う"/><meta property="og:url" content="http:localhost:3000/posts/p3448"/><meta property="og:type" content="website"/><meta property="og:image" content="https://locahost:3000/undefined"/><meta property="og:image:alt" content="Spring Security | JWTトークンの検証を行う"/><meta property="og:image:width" content="1200"/><meta property="og:image:height" content="700"/><meta name="next-head-count" content="17"/><link rel="preload" href="/_next/static/css/df6bb53438996960.css" as="style"/><link rel="stylesheet" href="/_next/static/css/df6bb53438996960.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-8fa1640cc84ba8fe.js" defer=""></script><script src="/_next/static/chunks/framework-7751730b10fa0f74.js" defer=""></script><script src="/_next/static/chunks/main-480c748fb908b436.js" defer=""></script><script src="/_next/static/chunks/pages/_app-5a840d570c522cf0.js" defer=""></script><script src="/_next/static/chunks/7-a9ae6bf2d6049209.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-31ed6b5e8c78747a.js" defer=""></script><script src="/_next/static/_k0KM30rhR250p_rOC5lF/_buildManifest.js" defer=""></script><script src="/_next/static/_k0KM30rhR250p_rOC5lF/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="flex flex-col min-h-screen bg-zinc-800"><header class="sticky top-0 border-b border-zinc-400 z-10 bg-zinc-900 text-slate-400"><div class="max-w-4xl mx-auto flex justify-between items-center h-12"><a href="/">Home</a><a target="_blank" href="https://github.com/jirentaicho">Github</a><a target="_blank" href="https://zenn.dev/misaka">Zenn</a></div></header><main class="flex-1 max-w-4xl w-full mx-auto"><div class="prose prose-lg max-w-none text-emerald-400"><h1 class="mt-12">Spring Security | JWTトークンの検証を行う</h1><span>2022.08.18</span><div class="space-x-2"><span><a class="text-emerald-300" href="/categories/Spring/">Spring</a></span></div></div></main><footer class="bg-zinc-900 text-slate-400"><div class="max-w-4xl w-full mx-auto h-24 flex items-center justify-center"><div>© volkruss.com / Edelstein</div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"frontMatter":{"title":"Spring Security | JWTトークンの検証を行う","date":"2022.08.18","description":"Spring Security | JWTトークンの検証を行う","categories":["Spring"]},"content":"\u003cp\u003e今回はログイン時に取得したJWTトークンを利用したログインを行います。\u003c/p\u003e\n\u003cp\u003e発行されたトークンを保存するのにローカルストレージを利用します。\u003c/p\u003e\n\u003ch2\u003eFilterの作成\u003c/h2\u003e\n\u003cp\u003eOncePerRequestFilterを利用してリクエストの発生に対して、1回実行される処理を定義できますここでリクエストのヘッダーからTokenを取得して、適切なTokenかどうかを判断して、認証済としてあげます\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"token import\"\u003e\u003cspan class=\"token namespace\"\u003ecom\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eauth0\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ejwt\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eJWT\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"token import\"\u003e\u003cspan class=\"token namespace\"\u003ecom\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eauth0\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ejwt\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ealgorithms\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eAlgorithm\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"token import\"\u003e\u003cspan class=\"token namespace\"\u003ecom\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eauth0\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ejwt\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003einterfaces\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eDecodedJWT\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"token import\"\u003e\u003cspan class=\"token namespace\"\u003eorg\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003espringframework\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003esecurity\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eauthentication\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eUsernamePasswordAuthenticationToken\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"token import\"\u003e\u003cspan class=\"token namespace\"\u003eorg\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003espringframework\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003esecurity\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecore\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eAuthentication\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"token import\"\u003e\u003cspan class=\"token namespace\"\u003eorg\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003espringframework\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003esecurity\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecore\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003econtext\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eSecurityContextHolder\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"token import\"\u003e\u003cspan class=\"token namespace\"\u003eorg\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003espringframework\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eweb\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003efilter\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eOncePerRequestFilter\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"token import\"\u003e\u003cspan class=\"token namespace\"\u003ejavax\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eservlet\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eFilterChain\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"token import\"\u003e\u003cspan class=\"token namespace\"\u003ejavax\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eservlet\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eServletException\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"token import\"\u003e\u003cspan class=\"token namespace\"\u003ejavax\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eservlet\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ehttp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eHttpServletRequest\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"token import\"\u003e\u003cspan class=\"token namespace\"\u003ejavax\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eservlet\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ehttp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eHttpServletResponse\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"token import\"\u003e\u003cspan class=\"token namespace\"\u003ejava\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eio\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eIOException\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"token import\"\u003e\u003cspan class=\"token namespace\"\u003ejava\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eutil\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eArrayList\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eLoginFilter\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eextends\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eOncePerRequestFilter\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token annotation punctuation\"\u003e@Override\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eprotected\u003c/span\u003e \u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"token function\"\u003edoFilterInternal\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eHttpServletRequest\u003c/span\u003e request\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eHttpServletResponse\u003c/span\u003e response\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eFilterChain\u003c/span\u003e filterChain\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethrows\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eServletException\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eIOException\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// headersのkeyを指定して値(トークン)を取得する\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e value \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e request\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetHeader\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"X-AUTH-TOKEN\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003evalue \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enull\u003c/span\u003e \u003cspan class=\"token operator\"\u003e||\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!\u003c/span\u003evalue\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003estartsWith\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Bearer \"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            filterChain\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003edoFilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003erequest\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003eresponse\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e token \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e value\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esubstring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e7\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// tokenの検証と認証を行う\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003eDecodedJWT\u003c/span\u003e decodedJWT \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token constant\"\u003eJWT\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003erequire\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eAlgorithm\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eHMAC256\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"secret\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ebuild\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003everify\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etoken\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// usernameの取得\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e username \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e decodedJWT\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetClaim\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"username\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003etoString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// ログイン状態の設定\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003eSecurityContextHolder\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetContext\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esetAuthentication\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eUsernamePasswordAuthenticationToken\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eusername\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\u003cspan class=\"token keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eArrayList\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        filterChain\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003edoFilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003erequest\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003eresponse\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e作成したFilterを追加します\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token annotation punctuation\"\u003e@Bean\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eSecurityFilterChain\u003c/span\u003e \u003cspan class=\"token function\"\u003efilterChain\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eHttpSecurity\u003c/span\u003e http\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethrows\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eException\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    http\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ecsrf\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ecsrfTokenRepository\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eCookieCsrfTokenRepository\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ewithHttpOnlyFalse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    http\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eauthorizeRequests\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eauth \u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        auth\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eantMatchers\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"/get\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003epermitAll\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        auth\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eantMatchers\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"/api/login\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003epermitAll\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        auth\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eantMatchers\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"/post\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eauthenticated\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    http\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ecors\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003econfigurationSource\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003ecorsConfigurationSource\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    http\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eaddFilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eJwtAuthenticationFilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003eauthenticationManager\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ehttp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetSharedObject\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eAuthenticationConfiguration\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// JwtAuthenticationFilterの後にフィルターを追加する\u003c/span\u003e\n    http\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eaddFilterAfter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eLoginFilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eJwtAuthenticationFilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e http\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ebuild\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eまたCORSの設定でレスポンスヘッダーを公開する設定を行います\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token annotation punctuation\"\u003e@Bean\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eCorsConfigurationSource\u003c/span\u003e \u003cspan class=\"token function\"\u003ecorsConfigurationSource\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token class-name\"\u003eCorsConfiguration\u003c/span\u003e cors \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eCorsConfiguration\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    cors\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esetAllowedOrigins\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eArrays\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003easList\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"http://localhost:3000\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    cors\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esetAllowedMethods\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eArrays\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003easList\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"GET\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"POST\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    cors\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esetAllowedHeaders\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eArrays\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003easList\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"*\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    cors\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esetAllowCredentials\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// X-AUTH-TOKENのレスポンスヘッダーを公開します → jsで取得できるようになる\u003c/span\u003e\n    cors\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eaddExposedHeader\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"X-AUTH-TOKEN\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token class-name\"\u003eUrlBasedCorsConfigurationSource\u003c/span\u003e source \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eUrlBasedCorsConfigurationSource\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    source\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eregisterCorsConfiguration\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"/**\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003ecors\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e source\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2\u003eヘッダーにトークンを付与する\u003c/h2\u003e\n\u003cp\u003eトークンを保持する必要がありますが、簡単に値を保存できるローカルストレージを使います\u003c/p\u003e\n\u003cp\u003eログイン後に取得できるX-AUTH-TOKENの値をローカルストレージに保存します\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"token comment\"\u003e// ログイン処理\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function\"\u003edologin\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e csrfToken \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token dom variable\"\u003edocument\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ecookie\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ereplace\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token regex\"\u003e\u003cspan class=\"token regex-delimiter\"\u003e/\u003c/span\u003e\u003cspan class=\"token regex-source language-regex\"\u003e\u003cspan class=\"token group punctuation\"\u003e(?:\u003c/span\u003e\u003cspan class=\"token group punctuation\"\u003e(?:\u003c/span\u003e\u003cspan class=\"token anchor function\"\u003e^\u003c/span\u003e\u003cspan class=\"token alternation keyword\"\u003e|\u003c/span\u003e\u003cspan class=\"token char-set class-name\"\u003e.\u003c/span\u003e\u003cspan class=\"token quantifier number\"\u003e*\u003c/span\u003e;\u003cspan class=\"token char-set class-name\"\u003e\\s\u003c/span\u003e\u003cspan class=\"token quantifier number\"\u003e*\u003c/span\u003e\u003cspan class=\"token group punctuation\"\u003e)\u003c/span\u003eXSRF-TOKEN\u003cspan class=\"token char-set class-name\"\u003e\\s\u003c/span\u003e\u003cspan class=\"token quantifier number\"\u003e*\u003c/span\u003e\u003cspan class=\"token escape\"\u003e\\=\u003c/span\u003e\u003cspan class=\"token char-set class-name\"\u003e\\s\u003c/span\u003e\u003cspan class=\"token quantifier number\"\u003e*\u003c/span\u003e\u003cspan class=\"token group punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token char-class\"\u003e\u003cspan class=\"token char-class-punctuation punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token char-class-negation operator\"\u003e^\u003c/span\u003e;\u003cspan class=\"token char-class-punctuation punctuation\"\u003e]\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token quantifier number\"\u003e*\u003c/span\u003e\u003cspan class=\"token group punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token char-set class-name\"\u003e.\u003c/span\u003e\u003cspan class=\"token quantifier number\"\u003e*\u003c/span\u003e\u003cspan class=\"token anchor function\"\u003e$\u003c/span\u003e\u003cspan class=\"token group punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token alternation keyword\"\u003e|\u003c/span\u003e\u003cspan class=\"token anchor function\"\u003e^\u003c/span\u003e\u003cspan class=\"token char-set class-name\"\u003e.\u003c/span\u003e\u003cspan class=\"token quantifier number\"\u003e*\u003c/span\u003e\u003cspan class=\"token anchor function\"\u003e$\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token regex-delimiter\"\u003e/\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e'$1'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003efetch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'http://localhost:8080/api/login'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token literal-property property\"\u003emethod\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\u003cspan class=\"token string\"\u003e'POST'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token literal-property property\"\u003ecredentials\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'include'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token literal-property property\"\u003eheaders\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token string-property property\"\u003e'X-XSRF-TOKEN'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e:\u003c/span\u003e csrfToken\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token literal-property property\"\u003ebody\u003c/span\u003e \u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token known-class-name class-name\"\u003eJSON\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003estringify\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token string-property property\"\u003e'username'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'misaka'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token string-property property\"\u003e'password'\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'mikoto'\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e \u003cspan class=\"token parameter\"\u003eres\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// ローカルストレージに保存する\u003c/span\u003e\n        \u003cspan class=\"token dom variable\"\u003elocalStorage\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003esetItem\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'jwt-token'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e'Bearer '\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e res\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eheaders\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'X-AUTH-TOKEN'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eこれでログインをするとローカルストレージにトークンが保存されているのがわかります\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/3448/1.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003eこの値を利用してトークンをヘッダーに付与してリクエストします\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003efunction \u003cspan class=\"token function\"\u003edopost\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e csrfToken \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e document\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecookie\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ereplace\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e/\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e?\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\u003cspan class=\"token operator\"\u003e^\u003c/span\u003e\u003cspan class=\"token operator\"\u003e|\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e*\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\\s\u003cspan class=\"token operator\"\u003e*\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token constant\"\u003eXSRF\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token constant\"\u003eTOKEN\u003c/span\u003e\\s\u003cspan class=\"token operator\"\u003e*\u003c/span\u003e\\\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\\s\u003cspan class=\"token operator\"\u003e*\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token operator\"\u003e^\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e*$\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e|\u003c/span\u003e\u003cspan class=\"token operator\"\u003e^\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e*$\u003cspan class=\"token operator\"\u003e/\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token char\"\u003e'$1'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    console\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ecsrfToken\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003efetch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e'http\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\u003cspan class=\"token operator\"\u003e/\u003c/span\u003e\u003cspan class=\"token operator\"\u003e/\u003c/span\u003elocalhost\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\u003cspan class=\"token number\"\u003e8080\u003c/span\u003e\u003cspan class=\"token operator\"\u003e/\u003c/span\u003epost'\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        method\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\u003cspan class=\"token char\"\u003e'POST'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        credentials\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e 'include'\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        headers\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            '\u003cspan class=\"token class-name\"\u003eX\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token constant\"\u003eXSRF\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token constant\"\u003eTOKEN\u003c/span\u003e' \u003cspan class=\"token operator\"\u003e:\u003c/span\u003e csrfToken\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e// jwt-tokenの値をローカルストレージから取得して付与する\u003c/span\u003e\n            '\u003cspan class=\"token class-name\"\u003eX\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token constant\"\u003eAUTH\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token constant\"\u003eTOKEN\u003c/span\u003e' \u003cspan class=\"token operator\"\u003e:\u003c/span\u003e localStorage\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetItem\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e'jwt\u003cspan class=\"token operator\"\u003e-\u003c/span\u003etoken'\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eres \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e res\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003etext\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estr \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e console\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estr\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eこれでjs側からヘッダーにX-AUTH-TOKENというkeyでトークンを付与してリクエストできるようになりました\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/3448/2.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003e正しくトークンの検証が行えればユーザー名の取得もできるようになっています\u003c/p\u003e\n\u003ch2\u003eトークンの改変\u003c/h2\u003e\n\u003cp\u003e試しにトークンの値を改変してリクエストを送ってみます\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/3448/3.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/3448/4.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003eサーバー側の問題としてエラーになっています。SpringでもJWTトークンのデコードエラーになっています\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/3448/5.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003e次にnullでも認証済になってしまうので修正します\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/3448/6.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/3448/7.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003enullで送ってもPOSTが成功しているのでcookieにJSESSIONIDがあり、そもそも認証済として扱われているから\u003c/p\u003e\n\u003cp\u003eフィルターを修正します\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eLoginFilter\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eextends\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eOncePerRequestFilter\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token annotation punctuation\"\u003e@Override\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eprotected\u003c/span\u003e \u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"token function\"\u003edoFilterInternal\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eHttpServletRequest\u003c/span\u003e request\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eHttpServletResponse\u003c/span\u003e response\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eFilterChain\u003c/span\u003e filterChain\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethrows\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eServletException\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eIOException\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e value \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e request\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetHeader\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"X-AUTH-TOKEN\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003evalue \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enull\u003c/span\u003e \u003cspan class=\"token operator\"\u003e||\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!\u003c/span\u003evalue\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003estartsWith\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Bearer \"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e//　認証情報を除去する\u003c/span\u003e\n            \u003cspan class=\"token class-name\"\u003eSecurityContextHolder\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetContext\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esetAuthentication\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            filterChain\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003edoFilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003erequest\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003eresponse\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e token \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e value\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esubstring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e7\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003eDecodedJWT\u003c/span\u003e decodedJWT \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token constant\"\u003eJWT\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003erequire\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eAlgorithm\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eHMAC256\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"secret\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ebuild\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003everify\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etoken\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e username \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e decodedJWT\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetClaim\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"username\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003easString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003eSecurityContextHolder\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetContext\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esetAuthentication\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eUsernamePasswordAuthenticationToken\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eusername\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\u003cspan class=\"token keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eArrayList\u003c/span\u003e\u003cspan class=\"token generics\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        filterChain\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003edoFilter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003erequest\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003eresponse\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e認証情報にnullを設定します\u003c/p\u003e\n\u003cp\u003eこれでトークンをnullにして送信すると一度ログインしても認証ユーザーとして扱われることはなくなりました\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/3448/8.png\" alt=\"画像\"\u003e\u003c/p\u003e\n\u003cp\u003eこれでJWTトークンを利用したRESTAPIでのログイン処理ができるようになりました。\u003c/p\u003e\n\u003cp\u003e最後にソースコードはGithubにアップロードしております\u003c/p\u003e\n\u003cp\u003ehttps://github.com/jirentaicho/SpringSecurity5.7-jwt\u003c/p\u003e\n\u003cp\u003e前回までの記事\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"/posts/p3398\"\u003eリンク\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"/posts/p3424\"\u003eリンク\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"/posts/p3434\"\u003eリンク\u003c/a\u003e\u003c/p\u003e","slug":"p3448"},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"p3448"},"buildId":"_k0KM30rhR250p_rOC5lF","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>