---
title: SpringBoot | éåŒæœŸå‡¦ç†ã‚’è©¦ã™
date: 2022.07.21
description: SpringBoot | éåŒæœŸå‡¦ç†ã‚’è©¦ã™
categories: ['Spring']
---

éåŒæœŸå‡¦ç†ã¯å‡¦ç†ã®å®Œäº†ã‚’å¾…ãŸãšã«å¾Œç¶šã®å‡¦ç†ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚

Springã§ã¯@Asyncã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä»˜ä¸ã™ã‚‹ã ã‘ã§ã€ãã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒåˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ã™ã‚‹ã¨å‘¼ã³å‡ºã—ãŸå´ã¯å‘¼ã³å‡ºã•ã‚ŒãŸå´ã®å‡¦ç†ã®å®Œäº†ã‚’å¾…ãŸãšã«å‡¦ç†ãŒé€²ã¿ã¾ã™ã€‚

æ—©é€Ÿå®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

ä¾‹ãˆã°ä»¥ä¸‹ã®å‡¦ç†ã¯10ç§’å¾Œã«ãƒ­ã‚°å‡ºåŠ›ã‚’è¡Œã†ç°¡å˜ãªãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚

```java
import java.util.concurrent.TimeUnit;

import org.springframework.stereotype.Service;

@Service
public class TestService {

	public void execute() {
		System.out.println("executeãƒ¡ã‚½ãƒƒãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆ : ã‚¹ãƒ¬ãƒƒãƒ‰ = " + Thread.currentThread().getName());
		try {
			TimeUnit.SECONDS.sleep(10);
		} catch (InterruptedException e) {
			e.printStackTrace();
		}
		System.out.println("executeãƒ¡ã‚½ãƒƒãƒ‰ãŒçµ‚äº†ã—ã¾ã—ãŸ");	
	}
	
}
```

* ã‚ã‹ã‚Šã‚„ã™ãã‚¹ãƒ¬ãƒƒãƒ‰åã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™
* 10ç§’é–“å‡¦ç†ã‚’æ­¢ã‚ãŸå¾Œã«ãƒ­ã‚°ã‚’å‡ºåŠ›ã—ã¾ã™

ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‹ã‚‰åˆ©ç”¨ã—ã¾ã™

```java
@RestController
public class TestController {

	@Autowired
	private TestService testService;
	
	@GetMapping("/test")
	public String test() {
		System.out.println("ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ : ã‚¹ãƒ¬ãƒƒãƒ‰ = " + Thread.currentThread().getName());
		this.testService.execute();
		return "çµæœã‚’å–å¾—ã—ã¾ã—ãŸ";
	}
}
```


ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨åŒã˜ã‚¹ãƒ¬ãƒƒãƒ‰ã«ã¦å‡¦ç†ãŒè¡Œã‚ã‚Œã¦ã„ã‚‹ã®ãŒã‚ã‹ã‚Šã¾ã™

![ç”»åƒ](/3023/1.png)


ãã—ã¦10ç§’å¾Œã«ç”»é¢ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

![ç”»åƒ](/3023/2.png)


ã¤ã¾ã‚Šä»¥ä¸‹ã®å‘¼ã³å‡ºã—ã§10ç§’é–“å‡¦ç†ãŒåœæ­¢ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™
```
this.testService.execute();
```

## éåŒæœŸå‡¦ç†ã‚’è¡Œã†


ã¾ãšã¯éåŒæœŸå‡¦ç†ã‚’è¡Œã„ãŸã„ãƒ¡ã‚½ãƒƒãƒ‰ã«å¯¾ã—ã¦@Asyncã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä»˜ä¸ã—ã¾ã™

```java
import java.util.concurrent.TimeUnit;

import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;

@Service
public class TestService {

	// è¿½åŠ 
	@Async
	public void execute() {
		System.out.println("executeãƒ¡ã‚½ãƒƒãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆ : ã‚¹ãƒ¬ãƒƒãƒ‰ = " + Thread.currentThread().getName());
		try {
			TimeUnit.SECONDS.sleep(10);
		} catch (InterruptedException e) {
			e.printStackTrace();
		}
		System.out.println("executeãƒ¡ã‚½ãƒƒãƒ‰ãŒçµ‚äº†ã—ã¾ã—ãŸ");	
	}
}
```


ã¾ãŸmainé–¢æ•°ã®ã‚ã‚‹ã‚¯ãƒ©ã‚¹ã«å¯¾ã—ã¦@EnableAsyncã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä»˜ä¸ã—ã¾ã™

```java
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.scheduling.annotation.EnableAsync;
//è¿½åŠ 
@EnableAsync
@SpringBootApplication
public class ThreadsampleApplication {

	public static void main(String[] args) {
		SpringApplication.run(ThreadsampleApplication.class, args);
	}
}
```


ã“ã‚Œã§å®Ÿè¡Œã™ã‚‹ã¨ãƒ­ã‚°ã«ã¯åˆ¥ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã¨ã—ã¦å‡¦ç†ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™

![ç”»åƒ](/3023/3.png)


ç”»é¢ã§ã¯10ç§’å¾…ãŸãšã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚

ã“ã®ã‚ˆã†ã«ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ã†ã ã‘ã§ç°¡å˜ã«éåŒæœŸå‡¦ç†ã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

## ã‚¨ãƒ©ãƒ¼å‡¦ç†


ã‚‚ã—ã‚‚ã‚¨ãƒ©ãƒ¼ã«ãªã£ãŸã‚‰ã©ã†ã™ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿè©¦ã—ã«ã‚¨ãƒ©ãƒ¼ã‚’èµ·ã“ã—ã¦ã¿ã¾ã™

```java
@Service
public class TestService {

	@Async
	public void execute() {
		System.out.println("executeãƒ¡ã‚½ãƒƒãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆ : ã‚¹ãƒ¬ãƒƒãƒ‰ = " + Thread.currentThread().getName());
		try {
			TimeUnit.SECONDS.sleep(10);
		} catch (InterruptedException e) {
			e.printStackTrace();
		}
		throw new RuntimeException();
		// System.out.println("executeãƒ¡ã‚½ãƒƒãƒ‰ãŒçµ‚äº†ã—ã¾ã—ãŸ");	
	}
}
```


ã“ã‚Œã§å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ä¾‹å¤–ã®ãƒ­ã‚°ãŒæµã‚Œã¾ã™
```
[2m2022-07-21 15:45:13.127[0;39m [32m INFO[0;39m [35m17364[0;39m [2m---[0;39m [2m[nio-8080-exec-1][0;39m [36mo.s.web.servlet.DispatcherServlet       [0;39m [2m:[0;39m Completed initialization in 1 ms
ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ : ã‚¹ãƒ¬ãƒƒãƒ‰ = http-nio-8080-exec-1
executeãƒ¡ã‚½ãƒƒãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆ : ã‚¹ãƒ¬ãƒƒãƒ‰ = task-1
[2m2022-07-21 15:45:23.163[0;39m [31mERROR[0;39m [35m17364[0;39m [2m---[0;39m [2m[         task-1][0;39m [36m.a.i.SimpleAsyncUncaughtExceptionHandler[0;39m [2m:[0;39m Unexpected exception occurred invoking async method: public void com.volkruss.threadsample.service.TestService.execute()

java.lang.RuntimeException: null
	at com.volkruss.threadsample.service.TestService.execute(TestService.java:20) ~[classes/:na]
	at com.volkruss.threadsample.service.TestService$$FastClassBySpringCGLIB$$37f944b6.invoke(<generated>) ~[classes/:na]
	at org.springframework.cglib.proxy.MethodProxy.invoke(MethodProxy.java:218) ~[spring-core-5.3.21.jar:5.3.21]
```

ç”»é¢ã§ã¯å½“ç„¶ã§ã™ãŒå–å¾—ã—ã¾ã—ãŸã¨ã„ã†çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸæ™‚ã«ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã™ã‚‹ã«ã¯AsyncUncaughtExceptionHandlerã®å®Ÿè£…ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¾ã™

```java
import java.lang.reflect.Method;

import org.springframework.aop.interceptor.AsyncUncaughtExceptionHandler;
import org.springframework.stereotype.Component;

@Component
public class ExceptionHandler implements AsyncUncaughtExceptionHandler{

	@Override
	public void handleUncaughtException(Throwable ex, Method method, Object... params) {
		System.out.println(method.getName() + "ã«ã¦ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
	}

}
```

* handleUncaughtExceptionãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ã¦å‡¦ç†ã‚’è¨˜è¼‰ã—ã¾ã™ã€‚
* ã“ã“ã§ã¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸãƒ¡ã‚½ãƒƒãƒ‰åã‚’ãƒ­ã‚°ã«å‡ºåŠ›ã—ã¾ã™

æ¬¡ã«AsyncConfigurerSupportã‚’ç¶™æ‰¿ã—ãŸè¨­å®šã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚ä»Šå›ã¯ä¾‹å¤–æ™‚ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ã¿è¨­å®šã™ã‚‹ã®ã§getAsyncUncaughtExceptionHandlerãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ã¾ã™

```java
import org.springframework.aop.interceptor.AsyncUncaughtExceptionHandler;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Configuration;
import org.springframework.scheduling.annotation.AsyncConfigurerSupport;

@Configuration
public class Config extends AsyncConfigurerSupport{
	@Autowired
	private ExceptionHandler handler;
	
    @Override
    public AsyncUncaughtExceptionHandler getAsyncUncaughtExceptionHandler() {
        return handler;
    }
}
```

* å…ˆã»ã©ä½œæˆã—ãŸExceptionHandlerã‚¯ãƒ©ã‚¹ã‚’è¿”å´ã—ã¾ã™

ã“ã‚Œã§å®Ÿè¡Œã—ã¾ã™

![ç”»åƒ](/3023/4.png)


ãƒ­ã‚°ãŒæµã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚ã“ã®ã‚ˆã†ã«ã—ã¦ä¾‹å¤–ç™ºç”Ÿæ™‚ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚‚è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

## å®Œäº†æ™‚ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°


æ¬¡ã«å®Œäº†æ™‚ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è¡Œã„ã¾ã™

éåŒæœŸå‡¦ç†ã«æˆ»ã‚Šå€¤ã‚’è¨­å®šã—ã¾ã™

```java
@Service
public class TestService {

	@Async
	public Future<String> execute() {
		System.out.println("executeãƒ¡ã‚½ãƒƒãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆ : ã‚¹ãƒ¬ãƒƒãƒ‰ = " + Thread.currentThread().getName());
		try {
			TimeUnit.SECONDS.sleep(10);
			return new AsyncResult<String>("mission complete");
		} catch (InterruptedException e) {
			e.printStackTrace();
		}
		return null;
		// System.out.println("executeãƒ¡ã‚½ãƒƒãƒ‰ãŒçµ‚äº†ã—ã¾ã—ãŸ");	
	}
}
```

* Futureå‹ã§éåŒæœŸå‡¦ç†ã®çµæœã‚’å–å¾—ã—ã¾ã™
  * new AsyncResultã§ä½œæˆã§ãã¾ã™

whileæ–‡ã§å‡¦ç†ã®å®Œäº†ã‚’ç›£è¦–ã—ã¾ã™

```java
@RestController
public class TestController {

	@Autowired
	private TestService testService;
	
	@GetMapping("/test")
	public String test() throws InterruptedException, ExecutionException {
		System.out.println("ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ : ã‚¹ãƒ¬ãƒƒãƒ‰ = " + Thread.currentThread().getName());
		// çµæœã‚’å—ã‘å–ã‚‹
		Future<String> result = this.testService.execute();
		while(true) {
			// å‡¦ç†å®Œäº†æ™‚
			if(result.isDone()) {
				System.out.println("å‡¦ç†çµæœ = " + result.get());
				break;
			}
			System.out.println("å‡¦ç†ãŒç¶™ç¶šä¸­ã§ã™");
			TimeUnit.SECONDS.sleep(1);
		}
		return "çµæœã‚’å–å¾—ã—ã¾ã—ãŸ";
	}
}
```


éåŒæœŸå‡¦ç†ãŒå®Œäº†ã™ã‚‹ã¾ã§å¾…ã¤ã“ã¨ãŒã§ãã€ã¾ãŸçµæœã®å–å¾—ã‚‚è¡Œã†ã“ã¨ãŒã§ãã¾ã™

![ç”»åƒ](/3023/5.png)


Springã§ã¯ç°¡å˜ã«éåŒæœŸå‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚
